
<?php exit;

/*
    Powered by ZeroDream
    Optimized by ZeroDream
	https://www.zerodream.top/xiuno.htm
	
	修改文件将有禁止使用帐户风险
*/

 elseif($action == 'zerodream_plugin_cloud') { !defined('DEBUG') AND exit('Access Denied.'); function zd_plugin_cloud_dir() { $filename = APP_PATH.'data/zerodream_plugin/cache/zd_plugin_cloud/'; if(!is_dir($filename)) mkdir($filename); } function zd_plugin_cloud_data() { global $conf,$url_rewrite_on,$url_record,$url_request,$zd_kv_zerodream_plugin,$filename_cache,$zd_plugin_cloud; $_server_request_url = zd_request_uri(); $url_rewrite_on = $conf['url_rewrite_on']; $url_record = substr($_server_request_url, $url_rewrite_on?14:15); $zd_kv_zerodream_plugin = zd_kv_get('zerodream_plugin'); if(empty($zd_kv_zerodream_plugin['key'])) message(-1, jump('请设置 key', url('plugin-setting-zerodream_plugin').'#key', 3)); $filename_md5 = md5($url_request); $filename_cache = APP_PATH."data/zerodream_plugin/cache/zd_plugin_cloud/$filename_md5"; $zd_plugin_cloud = array(); } function zd_plugin_cloud_url_record() { global $url_route,$url_record; $zd_plugin_url_record = zd_plugin_url_record_get(); $zd_plugin_url_record['zd_plugin_information']['action'] = 'zd_plugin_plugin_cloud'; $zd_plugin_url_record['zd_plugin_plugin_cloud']['zd_plugin_information']['url_route'] = $url_route; $zd_plugin_url_record['zd_plugin_plugin_cloud'][$url_route]['url_record'] = $url_record; $zd_plugin_url_record['zd_plugin_plugin_read']['back_action'] = 'zd_plugin_plugin_cloud'; zd_plugin_url_record_put($zd_plugin_url_record); } function zd_plugin_cloud_get_information() { global $information,$zd_kv_zerodream_plugin; $key = $zd_kv_zerodream_plugin['key']; $explode = explode("_", $key); $information['uid'] = $explode[0]; $information['key'] = $explode[1]; $information['check'] = $explode[2]; } function zd_plugin_cloud_index() { global $zd_kv_zerodream_plugin; if($zd_kv_zerodream_plugin['cache']) zd_plugin_cloud_cache(); else zd_plugin_cloud_non_cache(); } function zd_plugin_cloud_cache() { global $time,$zd_plugin_conf,$_cache,$filename_cache,$response,$zd_plugin_cloud; $cache_time = $zd_plugin_conf['cache_time']; if($_cache) { zd_plugin_cloud_request(); $data = $response; file_put_contents($filename_cache, $data); message(0, '缓存成功'); } if(is_file($filename_cache)) { $response = file_get_contents($filename_cache); } else { zd_plugin_cloud_request(); $data = $response; file_put_contents($filename_cache, $data); } $name = 'zd_plugin_cloud'; $data = $response; $zd_data_unzip = zd_data_unzip($name, $data); $data = $zd_data_unzip['data']; $html = $zd_data_unzip['html']; $script = $zd_data_unzip['script']; $json_arr = json_decode($data, true); $zd_plugin_information = $json_arr['zd_plugin_information']; $cache = $zd_plugin_information['cache']; $create_time = $zd_plugin_information['create_time']; $zd_kv_zerodream_plugin = zd_kv_get('zerodream_plugin'); $zd_kv_zerodream_plugin['cache'] = $cache; zd_kv_set('zerodream_plugin', $zd_kv_zerodream_plugin); if(!$cache) {zd_plugin_cloud_non_cache();return;} $_time = $create_time + $cache_time; if($time>=$_time) { zd_plugin_cloud_request(); $data = $response; file_put_contents($filename_cache, $data); zd_plugin_cloud_cache();return; } $zd_plugin_cloud['cache'] = true; $zd_plugin_cloud['html'] = $html; $zd_plugin_cloud['script'] = $script; } function zd_plugin_cloud_non_cache() { global $filename_cache,$response,$zd_plugin_cloud; zd_plugin_cloud_request(); $data = $response; file_put_contents($filename_cache, $data); $name = 'zd_plugin_cloud'; $data = $response; $zd_data_unzip = zd_data_unzip($name, $data); $data = $zd_data_unzip['data']; $html = $zd_data_unzip['html']; $script = $zd_data_unzip['script']; $json_arr = json_decode($data, true); $zd_plugin_information = $json_arr['zd_plugin_information']; $cache = $zd_plugin_information['cache']; $zd_kv_zerodream_plugin = zd_kv_get('zerodream_plugin'); $zd_kv_zerodream_plugin['cache'] = $cache; zd_kv_set('zerodream_plugin', $zd_kv_zerodream_plugin); if($cache) {zd_plugin_cloud_cache();return;} $zd_plugin_cloud['cache'] = false; $zd_plugin_cloud['html'] = $html; $zd_plugin_cloud['script'] = $script; } function zd_plugin_cloud_request() { global $url_record,$information,$url_rewrite_on,$url_request,$response; $key = $information['uid'].'_'.$information['key']; $check_key = md5($information['uid'].'_'.$information['key'].'_'.$information['check']); $zerodream_plugin_conf = APP_PATH.'plugin/zerodream_plugin/conf.json'; $zerodream_plugin_json_str = file_get_contents($zerodream_plugin_conf); $zerodream_plugin_json_arr = json_decode($zerodream_plugin_json_str, true); $zerodream_plugin_md5 = zd_plugin_zerodream_plugin_md5_file(); $zerodream_plugin_dir_existence = zd_plugin_zerodream_plugin_dir_existence(); $zd_plugin_cloud['zd_plugin_information']['key'] = $key; $zd_plugin_cloud['zd_plugin_information']['check_key'] = $check_key; $zd_plugin_cloud['zd_plugin_information']['url_rewrite_on'] = $url_rewrite_on; $zd_plugin_cloud['zd_plugin_information']['url_request'] = $url_request; $zd_plugin_cloud['zd_plugin_information']['url_record'] = $url_record; $zd_plugin_cloud['zd_plugin_information']['zerodream_plugin']['version'] = $zerodream_plugin_json_arr['version']; $zd_plugin_cloud['zd_plugin_information']['zerodream_plugin']['installed'] = $zerodream_plugin_json_arr['installed']; $zd_plugin_cloud['zd_plugin_information']['zerodream_plugin']['enable'] = $zerodream_plugin_json_arr['enable']; $zd_plugin_cloud['zd_plugin_information']['zerodream_plugin_md5'] = $zerodream_plugin_md5; $zd_plugin_cloud['zd_plugin_information']['zerodream_plugin_dir_existence'] = $zerodream_plugin_dir_existence; $data_json_str = json_encode($zd_plugin_cloud); $name = 'zd_plugin_cloud'; $data = array('data'=>$data_json_str); $data_str = zd_data_zip($name, $data); $url = ZERODREAM_URL.ZD_PLUGIN_URL_VERSION."plugin_cloud"; $zd_curl = zd_curl($url, $data_str, array('method'=>'POST')); $zd_curl_data = $zd_curl['data']; $zd_curl_error = $zd_curl['error']; if($zd_curl_error) message(-1, "curl_error: $zd_curl_error"); elseif(empty($zd_curl_data)) message(-1, '数据不存在'); $response = $zd_curl_data; } $_server_request_url = zd_request_uri(); $url_rewrite_on = $conf['url_rewrite_on']; $url_request = substr($_server_request_url, $url_rewrite_on?37:38); $url_arr = explode('-', $url_request); $url_arr[count($url_arr)-1] = explode('.', end($url_arr))[0]; $url_route = $url_arr[0]; if($url_route=='search') { !defined('DEBUG') AND exit('Access Denied.'); $_cache = param('cache'); function zd_plugin_cloud_search_dir() { $filename = APP_PATH.'data/zerodream_plugin/cache/zd_plugin_cloud/'; if(!is_dir($filename)) mkdir($filename); } function zd_plugin_cloud_search_data() { global $conf,$url_rewrite_on,$url_record,$url_request,$zd_kv_zerodream_plugin,$filename_cache,$zd_plugin_cloud_search; $_server_request_url = zd_request_uri(); $url_rewrite_on = $conf['url_rewrite_on']; $url_record = substr($_server_request_url, $url_rewrite_on?14:15); $zd_kv_zerodream_plugin = zd_kv_get('zerodream_plugin'); if(empty($zd_kv_zerodream_plugin['key'])) message(-1, jump('请设置 key', url('plugin-setting-zerodream_plugin').'#key', 3)); $filename_md5 = md5($url_request); $filename_cache = APP_PATH."data/zerodream_plugin/cache/zd_plugin_cloud/$filename_md5"; $zd_plugin_cloud_search = array(); } function zd_plugin_cloud_search_url_record() { global $url_record; $zd_plugin_url_record = zd_plugin_url_record_get(); $zd_plugin_url_record['zd_plugin_information']['action'] = 'zd_plugin_plugin_cloud'; $zd_plugin_url_record['zd_plugin_plugin_cloud']['zd_plugin_information']['url_route'] = 'search'; $zd_plugin_url_record['zd_plugin_plugin_cloud']['search']['url_record'] = $url_record; $zd_plugin_url_record['zd_plugin_plugin_read']['back_action'] = 'zd_plugin_plugin_cloud'; zd_plugin_url_record_put($zd_plugin_url_record); } function zd_plugin_cloud_search_get_information() { global $information,$zd_kv_zerodream_plugin; $key = $zd_kv_zerodream_plugin['key']; $explode = explode("_", $key); $information['uid'] = $explode[0]; $information['key'] = $explode[1]; $information['check'] = $explode[2]; } function zd_plugin_cloud_search_index() { global $zd_kv_zerodream_plugin; if($zd_kv_zerodream_plugin['cache']) zd_plugin_cloud_search_cache(); else zd_plugin_cloud_search_non_cache(); } function zd_plugin_cloud_search_cache() { global $time,$zd_plugin_conf,$_cache,$response,$filename_cache,$zd_plugin_cloud_search; $cache_time = $zd_plugin_conf['cache_time']; if($_cache) { zd_plugin_cloud_search_request(); $data = $response; file_put_contents($filename_cache, $data); message(0, '缓存成功'); } if(is_file($filename_cache)) { $response = file_get_contents($filename_cache); } else { zd_plugin_cloud_search_request(); $data = $response; file_put_contents($filename_cache, $data); } $name = 'zd_plugin_cloud'; $data = $response; $zd_data_unzip = zd_data_unzip($name, $data); $data = $zd_data_unzip['data']; $html = $zd_data_unzip['html']; $script = $zd_data_unzip['script']; $json_arr = json_decode($data, true); $plugin_cloud_official = $json_arr['plugin_list']; $zd_plugin_information = $json_arr['zd_plugin_information']; $cache = $zd_plugin_information['cache']; $create_time = $zd_plugin_information['create_time']; $zd_kv_zerodream_plugin = zd_kv_get('zerodream_plugin'); $zd_kv_zerodream_plugin['cache'] = $cache; zd_kv_set('zerodream_plugin', $zd_kv_zerodream_plugin); if(!$cache) {zd_plugin_cloud_search_non_cache();return;} $_time = $create_time + $cache_time; if($time>=$_time) { zd_plugin_cloud_search_request(); $data = $response; file_put_contents($filename_cache, $data); zd_plugin_cloud_search_cache();return; } foreach($plugin_cloud_official as $key=>$value) { $filename_conf = APP_PATH."plugin/$key/conf.json"; $json_str_conf = file_get_contents($filename_conf); $json_arr_conf = json_decode($json_str_conf, true); if(is_array($json_arr_conf)) { $zd_plugin_cloud_search['plugin_list'][$key]['downloaded'] = true; $filename_setting = APP_PATH."plugin/$key/setting.php"; $zd_plugin_cloud_search['plugin_list'][$key]['name'] = $json_arr_conf['name']; $zd_plugin_cloud_search['plugin_list'][$key]['installed_url'] = !$json_arr_conf['installed'] ? url("plugin-install-$key") : false; $zd_plugin_cloud_search['plugin_list'][$key]['setting_url'] = is_file($filename_setting) ? url("plugin-setting-$key") : false; $zd_plugin_cloud_search['plugin_list'][$key]['disable_url'] = $json_arr_conf['enable'] ? url("plugin-disable-$key") : false; $zd_plugin_cloud_search['plugin_list'][$key]['enable_url'] = !$json_arr_conf['enable'] ? url("plugin-enable-$key") : false; $zd_plugin_cloud_search['plugin_list'][$key]['unstall_url'] = url("plugin-unstall-$key"); $version_official = $value['lastversion']; $version_local = $json_arr_conf['version']; if(version_compare($version_local, $version_official, '<')) { $zd_plugin_cloud_search['plugin_list'][$key]['upgrade_url'] = $value['upgrade_url']; $zd_plugin_cloud_search['plugin_list'][$key]['version_official'] = $version_official; } else { $zd_plugin_cloud_search['plugin_list'][$key]['upgrade_url'] = false; } $zd_plugin_cloud_search['plugin_list'][$key]['version_local'] = $version_local; } else { $zd_plugin_cloud_search['plugin_list'][$key]['downloaded'] = false; } } $zd_plugin_cloud_search['cache'] = true; $zd_plugin_cloud_search['html'] = $html; $zd_plugin_cloud_search['script'] = $script; } function zd_plugin_cloud_search_non_cache() { global $filename_cache,$response,$zd_plugin_cloud_search; zd_plugin_cloud_search_request(); $data = $response; file_put_contents($filename_cache, $data); $name = 'zd_plugin_cloud'; $data = $response; $zd_data_unzip = zd_data_unzip($name, $data); $data = $zd_data_unzip['data']; $html = $zd_data_unzip['html']; $script = $zd_data_unzip['script']; $json_arr = json_decode($data, true); $zd_plugin_information = $json_arr['zd_plugin_information']; $cache = $zd_plugin_information['cache']; $zd_kv_zerodream_plugin = zd_kv_get('zerodream_plugin'); $zd_kv_zerodream_plugin['cache'] = $cache; zd_kv_set('zerodream_plugin', $zd_kv_zerodream_plugin); if($cache) {zd_plugin_cloud_search_cache();return;} $zd_plugin_cloud_search['cache'] = false; $zd_plugin_cloud_search['html'] = $html; $zd_plugin_cloud_search['script'] = $script; } function zd_plugin_cloud_search_request() { global $url_record,$information,$url_rewrite_on,$url_request,$zd_plugin_html,$response; $key = $information['uid'].'_'.$information['key']; $check_key = md5($information['uid'].'_'.$information['key'].'_'.$information['check']); $zerodream_plugin_conf = APP_PATH.'plugin/zerodream_plugin/conf.json'; $zerodream_plugin_json_str = file_get_contents($zerodream_plugin_conf); $zerodream_plugin_json_arr = json_decode($zerodream_plugin_json_str, true); $zerodream_plugin_md5 = zd_plugin_zerodream_plugin_md5_file(); $zerodream_plugin_dir_existence = zd_plugin_zerodream_plugin_dir_existence(); $zd_plugin_cloud_search['zd_plugin_information']['key'] = $key; $zd_plugin_cloud_search['zd_plugin_information']['check_key'] = $check_key; $zd_plugin_cloud_search['zd_plugin_information']['url_rewrite_on'] = $url_rewrite_on; $zd_plugin_cloud_search['zd_plugin_information']['url_request'] = $url_request; $zd_plugin_cloud_search['zd_plugin_information']['url_record'] = $url_record; $zd_plugin_cloud_search['zd_plugin_information']['zerodream_plugin']['version'] = $zerodream_plugin_json_arr['version']; $zd_plugin_cloud_search['zd_plugin_information']['zerodream_plugin']['installed'] = $zerodream_plugin_json_arr['installed']; $zd_plugin_cloud_search['zd_plugin_information']['zerodream_plugin']['enable'] = $zerodream_plugin_json_arr['enable']; $zd_plugin_cloud_search['zd_plugin_information']['zerodream_plugin_md5'] = $zerodream_plugin_md5; $zd_plugin_cloud_search['zd_plugin_information']['zerodream_plugin_dir_existence'] = $zerodream_plugin_dir_existence; $data_json_str = json_encode($zd_plugin_cloud_search); $directory = APP_PATH.'plugin/'; $scandir = scandir($directory); foreach ($scandir as $key_scandir=>$value_scandir) { if($value_scandir!='.' && $value_scandir!='..') { $filename_conf = $directory.$value_scandir.'/conf.json'; $json_str = file_get_contents($filename_conf); $json_arr = json_decode($json_str, true); if(is_array($json_arr)) { $local_plugins .= $value_scandir.'|'; $local_plugins .= $json_arr['version'].'|'; $local_plugins .= $json_arr['installed']; $local_plugins .= $json_arr['enable']; $filename_setting = $directory.$value_scandir.'/setting.php'; if(is_file($filename_setting)) $local_plugins .= 1; $local_plugins .= ';'; } } } $name = 'zd_plugin_cloud'; $data = array('data'=>$data_json_str, 'local_plugins'=>$local_plugins); $data_str = zd_data_zip($name, $data); $url = ZERODREAM_URL.ZD_PLUGIN_URL_VERSION."plugin_cloud"; $zd_curl = zd_curl($url, $data_str, array('method'=>'POST')); $zd_curl_data = $zd_curl['data']; $zd_curl_error = $zd_curl['error']; if($zd_curl_error) message(-1, "curl_error: $zd_curl_error"); elseif(empty($zd_curl_data)) message(-1, '数据不存在'); $response = $zd_curl_data; } zd_plugin_cloud_search_dir(); zd_plugin_cloud_search_data(); zd_plugin_cloud_search_url_record(); zd_plugin_cloud_search_get_information(); zd_plugin_cloud_search_index(); include _include(ADMIN_PATH.'view/htm/header.inc.htm');?>

<?php echo $zd_plugin_cloud_search['html'];?>

<?php include _include(ADMIN_PATH.'view/htm/footer.inc.htm');?>

<?php if($zd_plugin_cloud_search['cache']) { ?>
<script>
    var plugin_list = JSON.parse('<?php echo json_encode($zd_plugin_cloud_search['plugin_list']);?>');
</script>
<?php } ?>

<?php echo $zd_plugin_cloud_search['script']; exit(); } $_cache = param('cache'); zd_plugin_cloud_dir(); zd_plugin_cloud_data(); zd_plugin_cloud_url_record(); zd_plugin_cloud_get_information(); zd_plugin_cloud_index(); include _include(ADMIN_PATH.'view/htm/header.inc.htm');?>

<?php echo $zd_plugin_cloud['html'];?>

<?php include _include(ADMIN_PATH.'view/htm/footer.inc.htm');?>

<?php if($zd_plugin_cloud['cache']) { ?>
<script>
    var plugin_cloud = JSON.parse('<?php echo json_encode($zd_plugin_cloud['plugin_cloud']);?>');
</script>
<?php } ?>

<?php echo $zd_plugin_cloud['script']; } elseif($action == 'zerodream_plugin_plugin') { !defined('DEBUG') AND exit('Access Denied.'); $orderby = param(2, 0); $cateid = param(3, 0); $page = param(4, 1); $search = param('search'); $_cache = param('cache'); include _include(APP_PATH.'plugin/zerodream_plugin/admin/model/zd_plugin_list.func.php'); zd_plugin_list_dir(); zd_plugin_list_data(); zd_plugin_list_url_record(); zd_plugin_list_get_information(); zd_plugin_list_index(); include _include(ADMIN_PATH.'view/htm/header.inc.htm');?>

<?php echo $zd_plugin_list['html'];?>

<?php include _include(ADMIN_PATH.'view/htm/footer.inc.htm');?>

<?php if($zd_plugin_list['cache']) { ?>
<script>
    var plugin_list = JSON.parse('<?php echo json_encode($zd_plugin_list['plugin_list']);?>');
</script>
<?php } ?>

<?php echo $zd_plugin_list['script']; } elseif($action == 'zerodream_plugin_template') { !defined('DEBUG') AND exit('Access Denied.'); $orderby = param(2, 0); $cateid = param(3, 0); $page = param(4, 1); $search = param('search'); $_cache = param('cache'); include _include(APP_PATH.'plugin/zerodream_plugin/admin/model/zd_plugin_list.func.php'); zd_plugin_list_dir(); zd_plugin_list_data(); zd_plugin_list_url_record(); zd_plugin_list_get_information(); zd_plugin_list_index(); include _include(ADMIN_PATH.'view/htm/header.inc.htm');?>

<?php echo $zd_plugin_list['html'];?>

<?php include _include(ADMIN_PATH.'view/htm/footer.inc.htm');?>

<?php if($zd_plugin_list['cache']) { ?>
<script>
    var plugin_list = JSON.parse('<?php echo json_encode($zd_plugin_list['plugin_list']);?>');
</script>
<?php } ?>

<?php echo $zd_plugin_list['script']; } elseif($action == 'zerodream_plugin_read') { !defined('DEBUG') AND exit('Access Denied.'); $plugin = param(2); $_cache = param('cache'); function zd_plugin_read_dir() { $filename = APP_PATH.'data/zerodream_plugin/cache/zd_plugin_read/'; if(!is_dir($filename)) mkdir($filename); } function zd_plugin_read_data() { global $conf,$plugin,$url_rewrite_on,$url_record,$zd_kv_zerodream_plugin,$filename_cache,$zd_plugin_read; $_server_request_url = zd_request_uri(); $url_rewrite_on = $conf['url_rewrite_on']; $url_record = substr($_server_request_url, $url_rewrite_on?14:15); $zd_kv_zerodream_plugin = zd_kv_get('zerodream_plugin'); if(!isset($zd_kv_zerodream_plugin['key'])) message(-1, jump('请设置 key', url('plugin-setting-zerodream_plugin').'#key', 3)); $filename_md5 = md5($plugin); $filename_cache = APP_PATH."data/zerodream_plugin/cache/zd_plugin_read/$filename_md5"; $zd_plugin_read = array(); } function zd_plugin_read_url_record() { global $plugin,$url_rewrite_on,$url_record,$zd_plugin_read; $zd_plugin_url_record = zd_plugin_url_record_get(); $zd_plugin_url_record['zd_plugin_information']['action'] = 'zd_plugin_plugin_read'; $zd_plugin_url_record['zd_plugin_plugin_read']['url_record'] = $url_record; zd_plugin_url_record_put($zd_plugin_url_record); $back_action = $zd_plugin_url_record['zd_plugin_plugin_read']['back_action']; if($back_action=='zd_plugin_plugin_list') { $zd_plugin_url_record_url_request = $zd_plugin_url_record['zd_plugin_plugin_list']['url_record']; } elseif($back_action=='zd_plugin_plugin_cloud') { $url_route = $zd_plugin_url_record['zd_plugin_plugin_cloud']['zd_plugin_information']['url_route']; if($url_route=='search') $zd_plugin_url_record_url_request = $zd_plugin_url_record['zd_plugin_plugin_cloud'][$url_route]['url_record']; } $zd_plugin_read['back_url'] = ($url_rewrite_on?'':'?')."plugin-$zd_plugin_url_record_url_request#$plugin"; } function zd_plugin_read_get_information() { global $information,$zd_kv_zerodream_plugin; $key = $zd_kv_zerodream_plugin['key']; $explode = explode("_", $key); $information['uid'] = $explode[0]; $information['key'] = $explode[1]; $information['check'] = $explode[2]; } function zd_plugin_read_index() { global $zd_kv_zerodream_plugin; if($zd_kv_zerodream_plugin['cache']) zd_plugin_read_cache(); else zd_plugin_read_non_cache(); } function zd_plugin_read_cache() { global $time,$zd_plugin_conf,$_cache,$filename_cache,$response,$plugin_list_official,$zd_plugin_read; $cache_time = $zd_plugin_conf['cache_time']; if($_cache) { zd_plugin_read_request(); $data = $response; file_put_contents($filename_cache, $data); message(0, '缓存成功'); } if(is_file($filename_cache)) { $response = file_get_contents($filename_cache); } else { zd_plugin_read_request(); $data = $response; file_put_contents($filename_cache, $data); } $name = 'zd_plugin_read'; $data = $response; $zd_data_unzip = zd_data_unzip($name, $data); $data = $zd_data_unzip['data']; $html = $zd_data_unzip['html']; $script = $zd_data_unzip['script']; $json_arr = json_decode($data, true); $plugin_list_official = $json_arr['plugin_list']; $zd_plugin_information = $json_arr['zd_plugin_information']; $cache = $zd_plugin_information['cache']; $create_time = $zd_plugin_information['create_time']; $zd_kv_zerodream_plugin = zd_kv_get('zerodream_plugin'); $zd_kv_zerodream_plugin['cache'] = $cache; zd_kv_set('zerodream_plugin', $zd_kv_zerodream_plugin); if(!$cache) {zd_plugin_read_non_cache();return;} $_time = $create_time + $cache_time; if($time>=$_time) { zd_plugin_read_request(); $data = $response; file_put_contents($filename_cache, $data); zd_plugin_read_cache();return; } zd_plugin_list_cache_data(); $zd_plugin_read['cache'] = true; $zd_plugin_read['html'] = $html; $zd_plugin_read['script'] = $script; } function zd_plugin_read_non_cache() { global $filename_cache,$response,$zd_plugin_read; zd_plugin_read_request(); $data = $response; file_put_contents($filename_cache, $data); $name = 'zd_plugin_read'; $data = $response; $zd_data_unzip = zd_data_unzip($name, $data); $data = $zd_data_unzip['data']; $html = $zd_data_unzip['html']; $script = $zd_data_unzip['script']; $json_arr = json_decode($data, true); $zd_plugin_information = $json_arr['zd_plugin_information']; $cache = $zd_plugin_information['cache']; $zd_kv_zerodream_plugin = zd_kv_get('zerodream_plugin'); $zd_kv_zerodream_plugin['cache'] = $cache; zd_kv_set('zerodream_plugin', $zd_kv_zerodream_plugin); if($cache) {zd_plugin_read_cache();return;} $zd_plugin_read['cache'] = false; $zd_plugin_read['html'] = $html; $zd_plugin_read['script'] = $script; } function zd_plugin_read_request() { global $plugin,$url_record,$information,$url_rewrite_on,$zd_plugin_html,$response; $key = $information['uid'].'_'.$information['key']; $check_key = md5($information['uid'].'_'.$information['key'].'_'.$information['check']); $filename_plugin = APP_PATH."plugin/$plugin/"; if(is_dir($filename_plugin)) { $filename_conf = $filename_plugin.'conf.json'; $json_str = file_get_contents($filename_conf); $json_arr = json_decode($json_str, true); if(is_array($json_arr)) { $local_plugin[$plugin]['version'] = $json_arr['version']; $local_plugin[$plugin]['installed'] = $json_arr['installed']; $local_plugin[$plugin]['enable'] = $json_arr['enable']; $filename_setting = $filename_plugin.'/setting.php'; if(is_file($filename_setting)) $local_plugin[$plugin]['setting'] = true; } } $zd_plugin_read['user_plugins'] = $local_plugin; $zerodream_plugin_conf = APP_PATH.'plugin/zerodream_plugin/conf.json'; $zerodream_plugin_json_str = file_get_contents($zerodream_plugin_conf); $zerodream_plugin_json_arr = json_decode($zerodream_plugin_json_str, true); $zerodream_plugin_md5 = zd_plugin_zerodream_plugin_md5_file(); $zerodream_plugin_dir_existence = zd_plugin_zerodream_plugin_dir_existence(); $zd_plugin_read['zd_plugin_information']['key'] = $key; $zd_plugin_read['zd_plugin_information']['check_key'] = $check_key; $zd_plugin_read['zd_plugin_information']['url_rewrite_on'] = $url_rewrite_on; $zd_plugin_read['zd_plugin_information']['plugin'] = $plugin; $zd_plugin_read['zd_plugin_information']['url_record'] = $url_record; $zd_plugin_read['zd_plugin_information']['zerodream_plugin']['version'] = $zerodream_plugin_json_arr['version']; $zd_plugin_read['zd_plugin_information']['zerodream_plugin']['installed'] = $zerodream_plugin_json_arr['installed']; $zd_plugin_read['zd_plugin_information']['zerodream_plugin']['enable'] = $zerodream_plugin_json_arr['enable']; $zd_plugin_read['zd_plugin_information']['zerodream_plugin_md5'] = $zerodream_plugin_md5; $zd_plugin_read['zd_plugin_information']['zerodream_plugin_dir_existence'] = $zerodream_plugin_dir_existence; $data_str = json_encode($zd_plugin_read); $url = ZERODREAM_URL.ZD_PLUGIN_URL_VERSION."plugin_read.htm"; $zd_curl = zd_curl($url, $data_str, array('method'=>'POST')); $zd_curl_data = $zd_curl['data']; $zd_curl_error = $zd_curl['error']; if($zd_curl_error) message(-1, "curl_error: $zd_curl_error"); elseif(empty($zd_curl_data)) message(-1, '数据不存在'); $response = $zd_curl_data; } include _include(APP_PATH.'plugin/zerodream_plugin/admin/model/zd_plugin_list.func.php'); zd_plugin_read_dir(); zd_plugin_read_data(); zd_plugin_read_url_record(); zd_plugin_read_get_information(); zd_plugin_read_index(); include _include(ADMIN_PATH.'view/htm/header.inc.htm');?>

<?php echo $zd_plugin_read['html'];?>

<?php include _include(ADMIN_PATH.'view/htm/footer.inc.htm');?>

<?php if($zd_plugin_read['cache']) { ?>
<script>
    var plugin_list = JSON.parse('<?php echo json_encode($zd_plugin_list['plugin_list']);?>');
    var back_url = '<?php echo $zd_plugin_read['back_url'];?>';
</script>
<?php } ?>

<?php echo $zd_plugin_read['script']; } elseif($action == 'zerodream_plugin_download') { !defined('DEBUG') AND exit('Access Denied.'); $_key = param(2); $_check_key = param(3); $check_salt = param(4); $plugin = param(5); function zd_plugin_download_data() { global $zd_plugin_download; $zd_plugin_download = array(); } function zd_plugin_download_get_information() { global $conf,$information,$url_rewrite_on; $zd_kv_zerodream_plugin = zd_kv_get('zerodream_plugin'); $explode = explode("_", $zd_kv_zerodream_plugin['key']); $information['uid'] = $explode[0]; $information['key'] = $explode[1]; $information['check'] = $explode[2]; $url_rewrite_on = $conf['url_rewrite_on']; } function zd_plugin_download_check_information() { global $_key,$_check_key,$check_salt,$plugin,$information; $key = $information['uid'].'_'.$information['key']; $check_key = md5($information['check'].$check_salt.$plugin); if($key != $_key) message(-1, 'error: b01_01'); if($check_key != $_check_key) message(-1, 'error: b01_02'); } function zd_plugin_download_request() { global $plugin,$information,$url_rewrite_on,$data_download,$zd_plugin_html,$response; $key = $information['uid'].'_'.$information['key']; $check_salt = zd_uniqid(); $check_key_download = md5($information['check'].$check_salt.$plugin); $filename_check_key_download = APP_PATH."data/zerodream_plugin/check/$check_salt.download"; $data_check_key_download = $check_key_download; file_put_contents($filename_check_key_download, $data_check_key_download); $zerodream_plugin_conf = APP_PATH.'plugin/zerodream_plugin/conf.json'; $zerodream_plugin_json_str = file_get_contents($zerodream_plugin_conf); $zerodream_plugin_json_arr = json_decode($zerodream_plugin_json_str, true); $zerodream_plugin_md5 = zd_plugin_zerodream_plugin_md5_file(); $zerodream_plugin_dir_existence = zd_plugin_zerodream_plugin_dir_existence(); $zd_plugin_download['zd_plugin_information']['key'] = $key; $zd_plugin_download['zd_plugin_information']['check_salt'] = $check_salt; $zd_plugin_download['zd_plugin_information']['url_rewrite_on'] = $url_rewrite_on; $zd_plugin_download['zd_plugin_information']['zerodream_plugin']['version'] = $zerodream_plugin_json_arr['version']; $zd_plugin_download['zd_plugin_information']['zerodream_plugin']['installed'] = $zerodream_plugin_json_arr['installed']; $zd_plugin_download['zd_plugin_information']['zerodream_plugin']['enable'] = $zerodream_plugin_json_arr['enable']; $zd_plugin_download['zd_plugin_information']['zerodream_plugin_md5'] = $zerodream_plugin_md5; $zd_plugin_download['zd_plugin_information']['zerodream_plugin_dir_existence'] = $zerodream_plugin_dir_existence; $data_str = json_encode($zd_plugin_download); $url = ZERODREAM_URL.ZD_PLUGIN_URL_VERSION."plugin_download-$plugin.htm"; $zd_curl = zd_curl($url, $data_str, array('method'=>'POST')); $zd_curl_data = $zd_curl['data']; $zd_curl_error = $zd_curl['error']; if($zd_curl_error) message(-1, "curl_error: $zd_curl_error"); elseif(empty($zd_curl_data)) message(-1, '数据不存在'); $response = $zd_curl_data; } function zd_plugin_download_index() { global $plugin,$url_rewrite_on,$response,$jump_url,$data_download,$zd_plugin_download; $name = 'zd_plugin_download'; $data = $response; $zd_data_unzip = zd_data_unzip($name, $data); $data = $zd_data_unzip['data']; $json_arr = json_decode($data, true); $type = $json_arr['type']; if($type=='html') { $html = $zd_data_unzip['html']; $script = $zd_data_unzip['script']; $zd_plugin_download['html'] = $html; $zd_plugin_download['script'] = $script; include _include(ADMIN_PATH.'view/htm/header.inc.htm');?>

<?php echo $zd_plugin_download['html'];?>

<?php include _include(ADMIN_PATH.'view/htm/footer.inc.htm');?>

<?php echo $zd_plugin_download['script']; } elseif($type=='download') { $cache = $json_arr['cache']; if($plugin=='zerodream_plugin') { $jump_url = url("plugin-install-$plugin"); } elseif($cache) { $zd_plugin_url_record = zd_plugin_url_record_get(); $action = $zd_plugin_url_record['zd_plugin_information']['action']; if($action=='zd_plugin_plugin_list') { $zd_plugin_url_record_url_request = $zd_plugin_url_record['zd_plugin_plugin_list']['url_record']; $jump_url = ($url_rewrite_on?'':'?')."plugin-$zd_plugin_url_record_url_request#$plugin"; } elseif($action=='zd_plugin_plugin_cloud') { $url_route = $zd_plugin_url_record['zd_plugin_plugin_cloud']['zd_plugin_information']['url_route']; if($url_route=='search') { $zd_plugin_url_record_url_request = $zd_plugin_url_record['zd_plugin_plugin_cloud'][$url_route]['url_record']; $jump_url = ($url_rewrite_on?'':'?')."plugin-$zd_plugin_url_record_url_request#$plugin"; } } elseif($action=='zd_plugin_plugin_read') { $zd_plugin_url_record_url_request = $zd_plugin_url_record['zd_plugin_plugin_read']['url_record']; $jump_url = ($url_rewrite_on?'':'?')."plugin-$zd_plugin_url_record_url_request"; } } else { $jump_url = $json_arr['jump_url']; } $data_download = $zd_data_unzip['data_download']; zd_plugin_download_plugin(); } } function zd_plugin_download_plugin() { global $plugin,$jump_url,$data_download; $path = APP_PATH."plugin/$plugin"; if(is_dir($path)) zd_deldir($path); $zd_plugin_plugin_download_uniqid = zd_uniqid(); $filename_download = APP_PATH."data/zerodream_plugin/download/$zd_plugin_plugin_download_uniqid"; if(is_file($filename_download)) unlink($filename_download); file_put_contents($filename_download, $data_download); $zipfile = $filename_download; $extdir = APP_PATH.'plugin/'; zd_unzip($zipfile, $extdir); unlink($filename_download); message(0, jump(lang('zd_plugin_download_successful'), $jump_url, 3)); } zd_plugin_download_data(); zd_plugin_download_get_information(); zd_plugin_download_check_information(); zd_plugin_download_request(); zd_plugin_download_index(); } elseif($action == 'zerodream_plugin_install') { !defined('DEBUG') AND exit('Access Denied.'); plugin_lock_start(); $dir = param_word(2); plugin_check_exists($dir); $name = $plugins[$dir]['name']; plugin_check_dependency($dir, 'install'); plugin_install($dir); $installfile = APP_PATH."plugin/$dir/install.php"; if(is_file($installfile)) include _include($installfile); $upgradefile = APP_PATH."plugin/$dir/upgrade.php"; if(is_file($upgradefile)) include _include($upgradefile); plugin_lock_end(); if(strpos($dir, '_theme_') !== FALSE) { foreach($plugins as $_dir => $_plugin) { if($dir == $_dir) continue; if(strpos($_dir, '_theme_') !== FALSE) { plugin_unstall($_dir); } } } elseif(stripos($dir, 'zerodream') === FALSE) { $suffix = substr($dir, strpos($dir, '_')); foreach($plugins as $_dir => $_plugin) { if($dir == $_dir) continue; if(stripos($_dir, 'zerodream') === FALSE) { $_suffix = substr($_dir, strpos($_dir, '_')); if($suffix == $_suffix) { plugin_unstall($_dir); } } } } rmdir_recusive($conf['tmp_path'], 1); if($dir=='zerodream_plugin') { $msg = lang('plugin_install_sucessfully', array('name'=>$name)); $url = url('plugin-zerodream_plugin_cloud-index'); message(0, jump($msg, $url, 3)); } $msg = lang('plugin_install_sucessfully', array('name'=>$name)); message(0, jump($msg, http_referer(), 3)); } elseif($action == 'new_plugin') { !defined('DEBUG') AND exit('Access Denied.'); $dir = param('dir'); $name = param('name'); $version = param('version'); $bbs_version = param('bbs_version'); $brief = param('brief'); $hook = param('hook'); $overwrite = param('overwrite'); if(empty($dir)) message('dir', '目录名称不能为空'); if(!preg_match('/^\w+$/', $dir)) message('dir', '目录名称只能由数字、字母、下划线组成'); if(empty($name)) message('name', '插件名称不能为空'); if(empty($version)) message('version', '版本号(version)不能为空'); if(empty($bbs_version)) message('bbs_version', '版本号(bbs_version)不能为空'); if(empty($brief)) message('brief', '插件介绍不能为空'); $plugin_conf = [ 'name'=>$name, 'brief'=>$brief, 'version'=>$version, 'bbs_version'=>$bbs_version, 'installed'=>0, 'enable'=>0, 'hooks_rank'=>[], 'overwrites_rank'=>[], 'dependencies'=>[] ]; if(!is_dir(APP_PATH.'plugin/'.$dir)){ mkdir(APP_PATH.'plugin/'.$dir); } if($hook == 'on'){ if(!is_dir(APP_PATH.'plugin/'.$dir.'/hook')){ mkdir(APP_PATH.'plugin/'.$dir.'/hook'); } } if($overwrite == 'on'){ if(!is_dir(APP_PATH.'plugin/'.$dir.'/overwrite')){ mkdir(APP_PATH.'plugin/'.$dir.'/overwrite'); } } file_put_contents(APP_PATH.'plugin/'.$dir.'/conf.json',xn_json_encode($plugin_conf)); message(0, '新建成功'); } elseif($action == 'upload_plugin') { !defined('DEBUG') AND exit('Access Denied.'); $file = $_FILES['file']; if($file["error"] > 0) { $message = 'error: '.$file["error"].'<br>'; message(-1, $message); } $zd_uniqid = zd_uniqid($prefix='upload_plugin_'); $filename = $file["tmp_name"]; $destination = APP_PATH."data/zerodream_plugin/tmp/$zd_uniqid.zip"; move_uploaded_file($filename, $destination); $zipfile = $destination; $extdir = APP_PATH."plugin/"; zd_unzip($zipfile, $extdir); unlink($zipfile); message(0, jump("上传成功", http_referer(), 3)); } elseif($action == 'interface') { $interface = param(2); $zd_kv_zerodream_plugin = zd_kv_get('zerodream_plugin'); $zd_kv_zerodream_plugin['interface'] = $interface; zd_kv_set('zerodream_plugin', $zd_kv_zerodream_plugin); message(0, jump('修改成功', url('plugin-local'), 3)); } elseif($action == 'synchro') { $json_path = APP_PATH.'log/plugin-all-4.json'; $json_data = fox_write_plugin_json($json_path); if($json_data) { cache_set('plugin_official_list', xn_json_decode($json_data), 3600); message(0, '同步成功'); } else { message(-1, '同步失败'); } } ?>