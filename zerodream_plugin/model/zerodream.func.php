
<?php

/*
    Powered by ZeroDream
	https://www.zerodream.top/xiuno.htm
	
	修改文件将有禁止使用帐户风险
*/

 define('DEFINED_ZERODREAM_PLUGIN_ZERODREAM_FUNCTION', true); include _include(zd_path('plugin/zerodream_plugin/model/zerodream_kv.func.php')); include _include(zd_path('plugin/zerodream_plugin/model/zerodream_user.func.php')); include _include(zd_path('plugin/zerodream_plugin/model/zerodream_xiuno.func.php')); function zd_path($path) { if(defined('ZD_PATH')) return ADMIN_PATH.'../'.$path; else return APP_PATH.$path; } function zd_url_rewrite() { global $conf; if(!$conf['url_rewrite_on']) $zd_81c3a_0 = '?'; return $zd_81c3a_0; } function zd_check_plugin($plugin) { $zd_5f248_0 = zd_path("plugin/$plugin/conf.json"); if(!is_file($zd_5f248_0)) return false; $zd_19680_2 = file_get_contents($zd_5f248_0); $zd_6b9fc_4 = json_decode($zd_19680_2, true); if($zd_6b9fc_4['installed'] && $zd_6b9fc_4['enable']) $zd_db430_8 = true; else $zd_db430_8 = false; return $zd_db430_8; } function zd_uniqid($prefix='') { $zd_91c6d_0 = $prefix.md5(uniqid(mt_rand(),true)); return $zd_91c6d_0; } function zd_curl($url, $data=null, $array=array()) { if(!isset($array['method'])) $array['method'] = 'GET'; $zd_6abd3_0 = curl_init(); $zd_6c2fa_1 = array( CURLOPT_URL => $url, CURLOPT_CUSTOMREQUEST => $array['method'], CURLOPT_POSTFIELDS => $data, CURLOPT_RETURNTRANSFER => true, CURLOPT_SSL_VERIFYPEER => false, CURLOPT_SSL_VERIFYHOST => false, CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_0, CURLOPT_IPRESOLVE => CURL_IPRESOLVE_V4, CURLOPT_HTTPHEADER => array( "Expect: ", "Accept: application/json", "Content-Type: application/json; charset=utf-8", "Content-Length: ".strlen($data), ), ); curl_setopt_array($zd_6abd3_0, $zd_6c2fa_1); $zd_f7286_4['data'] = curl_exec($zd_6abd3_0); $zd_f7286_4['error'] = curl_error($zd_6abd3_0); if(!empty($array['getinfo'])) $zd_f7286_4['info'] = curl_getinfo($zd_6abd3_0); curl_close($zd_6abd3_0); return $zd_f7286_4; } function zd_request_uri() { if(isset($_SERVER['REQUEST_URI'])) $zd_1e3ce_0 = $_SERVER['REQUEST_URI']; elseif(isset($_SERVER['argv'])) $zd_1e3ce_0 = $_SERVER['PHP_SELF'].'?'.$_SERVER['argv'][0]; else $zd_1e3ce_0 = $_SERVER['PHP_SELF'].'?'.$_SERVER['QUERY_STRING']; return $zd_1e3ce_0; } function zd_remove_extension($name_str) { $zd_6ac13_0 = explode(".", $name_str); $zd_5212f_1 = count($zd_6ac13_0); if($zd_5212f_1 == 1) { $zd_fbe45_4 = $name_str; } else { foreach($zd_6ac13_0 as $zd_82cb5_6=>$zd_66cd5_7) { if($zd_82cb5_6!=($zd_5212f_1-1)) if($zd_fbe45_4) $zd_fbe45_4 .= '.'.$zd_66cd5_7; else $zd_fbe45_4 = $zd_66cd5_7; } } return $zd_fbe45_4; } function zd_deldir($path) { $zd_c1e9e_0 = opendir($path); while($zd_068bc_1=readdir($zd_c1e9e_0)) { if($zd_068bc_1!="." && $zd_068bc_1!="..") { $zd_5e431_5 = $path."/".$zd_068bc_1; if(is_dir($zd_5e431_5)) zd_deldir($zd_5e431_5); else unlink($zd_5e431_5); } } closedir($zd_c1e9e_0); if(rmdir($path)) return true; else return false; } function zd_md5_file($filename, $exclude_filename) { global $zd_md5_file; $zd_595d4_0 = $filename; _zd_md5_file($zd_595d4_0, $exclude_filename); $zd_7d631_2 = $zd_md5_file['md5_file_zerodream_plugin']; unset($zd_md5_file); $zd_2739b_3 = ''; foreach($zd_7d631_2 as $zd_bd53c_5=>$zd_69b50_6) $zd_2739b_3 = md5($zd_2739b_3.$zd_69b50_6); return $zd_2739b_3; } function _zd_md5_file($directory, $exclude_filename) { global $zd_md5_file; $zd_7725a_0 = scandir($directory); foreach($zd_7725a_0 as $zd_d09e5_2=>$zd_ea6b3_3) { if($zd_ea6b3_3!="." && $zd_ea6b3_3!="..") { $zd_50faa_6 = $directory.'/'.$zd_ea6b3_3; if(is_dir($zd_50faa_6)) { if(!in_array($zd_50faa_6, $exclude_filename)) _zd_md5_file($zd_50faa_6, $exclude_filename); } elseif(is_file($zd_50faa_6)) { if(!in_array($zd_50faa_6, $exclude_filename)) $zd_md5_file['md5_file_zerodream_plugin'][] = md5_file($zd_50faa_6); } } } } function zd_data_put($zd_data) { $zd_46c09_0 = zd_path('data/zerodream_plugin/zd_data.json'); $zd_3d6b5_1 = json_encode($zd_data); file_put_contents($zd_46c09_0, $zd_3d6b5_1); zd_data_get($zd_184ad_4=true); } function zd_data_get($reacquire=false) { static $zd_c8993_0 = array(); if(empty($zd_c8993_0) || $reacquire) { $zd_6fc0d_2 = zd_path('data/zerodream_plugin/zd_data.json'); $zd_ba8cc_3 = file_get_contents($zd_6fc0d_2); $zd_c8993_0 = json_decode($zd_ba8cc_3, true); } return $zd_c8993_0; } function zd_data_zip($name, $data) { // hook zd_data_zip_start.php $zd_2c9f4_0 = zd_path('data/zerodream_plugin/tmp/zd_data_zip/'); if(!is_dir($zd_2c9f4_0)) mkdir($zd_2c9f4_0); $zd_e82a5_3 = $name.'_'; $zd_f9ad4_4 = zd_uniqid($zd_e82a5_3); $zd_2c9f4_0 = $zd_2c9f4_0."$zd_f9ad4_4/"; if(!is_dir($zd_2c9f4_0)) mkdir($zd_2c9f4_0); $zd_304e5_11 = $zd_2c9f4_0."$name/"; if(!is_dir($zd_304e5_11)) mkdir($zd_304e5_11); foreach($data as $zd_07b57_15=>$zd_63fba_16) file_put_contents($zd_304e5_11.$zd_07b57_15, $zd_63fba_16); $zd_3ee9e_20 = "$zd_2c9f4_0/$name.zip"; $zd_dd69e_22 = $zd_304e5_11; zd_zip($zd_3ee9e_20, $zd_dd69e_22); $zd_839bb_26 = $zd_3ee9e_20; $zd_717bd_28 = file_get_contents($zd_839bb_26); zd_deldir($zd_2c9f4_0); // hook zd_data_zip_end.php return $zd_717bd_28; } function zd_data_unzip($name, $data) { // hook zd_data_unzip_start.php $zd_e7662_0 = zd_path('data/zerodream_plugin/tmp/zd_data_unzip/'); if(!is_dir($zd_e7662_0)) mkdir($zd_e7662_0); $zd_08b91_3 = $name.'_'; $zd_d1703_4 = zd_uniqid($zd_08b91_3); $zd_e7662_0 = $zd_e7662_0."$zd_d1703_4/"; if(!is_dir($zd_e7662_0)) mkdir($zd_e7662_0); $zd_b071b_11 = $zd_e7662_0.$name.'.zip'; file_put_contents($zd_b071b_11, $data); $zd_cf012_14 = $zd_b071b_11; $zd_4291c_16 = $zd_e7662_0; zd_unzip($zd_cf012_14, $zd_4291c_16); $zd_b7ae2_20 = $zd_e7662_0."$name/"; $zd_2b695_22 = scandir($zd_b7ae2_20); foreach($zd_2b695_22 as $zd_4bf95_25=>$zd_63623_26) if($zd_63623_26!='.' && $zd_63623_26!='..') $zd_54c92_29[$zd_63623_26] = file_get_contents($zd_b7ae2_20.$zd_63623_26); zd_deldir($zd_e7662_0); // hook zd_data_unzip_end.php return $zd_54c92_29; } function zd_byte_conversion($byte, $precision) { if($byte>=1024**4) $zd_87d17_0 = round($byte/1024**4, $precision).' T'; elseif($byte>=1024**3) $zd_87d17_0 = round($byte/1024**3, $precision).' G'; elseif($byte>=1024**2) $zd_87d17_0 = round($byte/1024**2, $precision).' M'; elseif($byte>=1024**1) $zd_87d17_0 = round($byte/1024**1, $precision).' K'; elseif($byte>=1024**0) $zd_87d17_0 = round($byte/1024**0, $precision).' B'; else return false; return $zd_87d17_0; } function zd_zip($zipfile, $extdir) { if(class_exists('ZipArchive')) { $zd_6acab_0 = pathinfo($extdir); $zd_c3859_1 = $zd_6acab_0['dirname']; $zd_5a9e6_3 = $zd_6acab_0['basename']; xn_unlink($zipfile); $zd_52488_5 = new ZipArchive(); $zd_52488_5->open($zipfile, ZIPARCHIVE::CREATE); $zd_52488_5->addEmptyDir($zd_5a9e6_3); zd_dir_to_zip($zd_52488_5, $extdir, strlen("$zd_c3859_1/")); $zd_52488_5->close(); } else { xn_unlink($zipfile); include_once XIUNOPHP_PATH.'xn_zip_old.func.php'; xn_zip_old($zipfile, $extdir); } } function zd_dir_to_zip($z, $zippath, $prelen = 0) { substr($zippath, -1) != '/' AND $zippath .= '/'; $zd_a2796_0 = glob($zippath."*"); foreach($zd_a2796_0 as $zd_5e161_2) { $zd_0188c_3 = substr($zd_5e161_2, $prelen); if(is_file($zd_5e161_2)) { $z->addFile($zd_5e161_2, $zd_0188c_3); } elseif(is_dir($zd_5e161_2)) { $z->addEmptyDir($zd_0188c_3); zd_dir_to_zip($z, $zd_5e161_2, $prelen); } } } function zd_unzip($zipfile, $extdir) { if(class_exists('ZipArchive')) { $zd_09885_0 = new ZipArchive; if($zd_09885_0->open($zipfile) === TRUE) { $zd_09885_0->extractTo($extdir); $zd_09885_0->close(); } } else { include_once XIUNOPHP_PATH.'xn_zip_old.func.php'; xn_unzip_old($zipfile, $extdir); } $extdirlast = substr(strrchr(substr($extdir, 0, -1), '/'), 1); $extdirp = substr(substr($extdir, 0, -1), 0, strpos($extdir, '/') + 1); if(is_dir($extdir.$extdirlast)) { $extdirtmp = substr($extdir, 0, -1).'__xn__tmp__dir__/'; rename(substr($extdir, 0, -1), substr($extdirtmp, 0, -1)); rename($extdirtmp.$extdirlast, substr($extdir, 0, -1)); } } ?>