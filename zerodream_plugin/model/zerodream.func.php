
<?php

/*
    Powered by ZeroDream
    Optimized by ZeroDream
	https://www.zerodream.top/xiuno.htm
	
	修改文件将有禁止使用帐户风险
*/

 define('DEFINED_ZERODREAM_PLUGIN_ZERODREAM_FUNCTION', true); function zd_kv__get($zd_450fe_0) { $zd_39d7f_1 = db_find_one('zerodream_kv', array('k'=>$zd_450fe_0)); return $zd_39d7f_1 ? xn_json_decode($zd_39d7f_1['v']) : NULL; } function zd_kv_get($zd_29f9c_0, $zd_cc5f9_1=array()) { static $zd_a5376_2 = array(); if(!empty($zd_cc5f9_1)) if($zd_cc5f9_1['type']=='update') $zd_a5376_2[$zd_29f9c_0] = $zd_cc5f9_1['v']; elseif($zd_cc5f9_1['type']=='delete') unset($zd_a5376_2[$zd_29f9c_0]); strlen($zd_29f9c_0) > 32 AND $zd_29f9c_0 = md5($zd_29f9c_0); if(!isset($zd_a5376_2[$zd_29f9c_0])) $zd_a5376_2[$zd_29f9c_0] = zd_kv__get($zd_29f9c_0); return $zd_a5376_2[$zd_29f9c_0]; } function zd_kv_set($zd_d2c25_0, $zd_4008c_1, $zd_60ca7_2 = 0) { strlen($zd_d2c25_0) > 32 AND $zd_d2c25_0 = md5($zd_d2c25_0); $zd_a198c_6 = array('k'=>$zd_d2c25_0, 'v'=>xn_json_encode($zd_4008c_1)); $zd_dcf81_9 = db_replace('zerodream_kv', $zd_a198c_6); zd_kv_get($zd_d2c25_0, $zd_0c46f_12=array('type'=>'update','v'=>$zd_4008c_1)); return $zd_dcf81_9; } function zd_kv_delete($zd_8e778_0) { strlen($zd_8e778_0) > 32 AND $zd_8e778_0 = md5($zd_8e778_0); $zd_a287b_4 = db_delete('zerodream_kv', array('k'=>$zd_8e778_0)); zd_kv_get($zd_8e778_0, $zd_642d4_7=array('type'=>'delete')); return $zd_a287b_4; } function zd_user_group_update($zd_6ad6b_0, $zd_904d4_1=false) { global $grouplist; $zd_39793_2 = user__read($zd_6ad6b_0); if(!$zd_904d4_1) if($zd_39793_2['gid'] <= 100) return false; foreach($grouplist as $zd_ae6ee_6) { if($zd_ae6ee_6['gid'] <= 100) continue; if($zd_39793_2['credits']>$zd_ae6ee_6['creditsfrom'] && $zd_39793_2['credits']<$zd_ae6ee_6['creditsto']) { if($zd_39793_2['gid'] != $zd_ae6ee_6['gid']) { user__update($zd_6ad6b_0, array('gid'=>$zd_ae6ee_6['gid'])); return true; } } } return false; } 
// ~ 代码来自 xiuno，代码存在修改 ---> 开始
 function _xn_search_keyword_safe($zd_91d92_0) { $zd_91d92_0 = str_replace(array('\'', '\\', '"', '%', '<', '>', '`', '*', '&', '#'), '', $zd_91d92_0); $zd_91d92_0 = preg_replace('#\s+#', ' ', $zd_91d92_0); $zd_91d92_0 = trim($zd_91d92_0); return $zd_91d92_0; } 
// ~ 代码来自 xiuno，代码存在修改 ---> 结束
 function zd_file_php_json_put($zd_8f196_8, $zd_47f72_9) { $zd_47f72_9 = "<?php '$zd_47f72_9'; ?>"; file_put_contents($zd_8f196_8, $zd_47f72_9); } function zd_file_php_json_get($zd_bf8d4_0) { $zd_dd44b_1 = file_get_contents($zd_bf8d4_0); $zd_dd44b_1 = substr_replace($zd_dd44b_1, '', 0, 7); $zd_dd44b_1 = substr_replace($zd_dd44b_1, '', -5, 5); return $zd_dd44b_1; } function zd_url_rewrite() { global $conf; if(!$conf['url_rewrite_on']) $zd_d3ce8_0 = '?'; return $zd_d3ce8_0; } function zd_plugin_check($zd_25970_0) { $zd_2404a_1 = APP_PATH."plugin/$zd_25970_0/conf.json"; if(!is_file($zd_2404a_1)) return false; $zd_7a8e8_4 = file_get_contents($zd_2404a_1); $zd_c7374_6 = json_decode($zd_7a8e8_4, true); if($zd_c7374_6['installed'] && $zd_c7374_6['enable']) $zd_c4cce_10 = true; else $zd_c4cce_10 = false; return $zd_c4cce_10; } function zd_plugin_conf_zerodream_get($zd_1a510_0, $zd_c26a4_1) { if(!is_file($zd_1a510_0)) return false; $zd_8f8b9_3 = xn_json_decode(file_get_contents($zd_1a510_0)); if(empty($zd_8f8b9_3)) return false; if(is_file($zd_c26a4_1)) { $zd_f6c8f_7 = xn_json_decode(file_get_contents($zd_c26a4_1))['zd_plugin']; $zd_f6c8f_7['zd_plugin'] = true; } else { $zd_f6c8f_7['zd_plugin'] = false; } $zd_56939_11 = array_merge($zd_8f8b9_3, $zd_f6c8f_7); return $zd_56939_11; } function zd_uniqid($zd_30b69_0='') { $zd_db06f_1 = $zd_30b69_0.md5(uniqid(mt_rand(),true)); return $zd_db06f_1; } function zd_curl($zd_99ba7_0, $zd_9bbc2_1=null, $zd_467fc_2=array()) { if(!isset($zd_467fc_2['method'])) $zd_467fc_2['method'] = 'GET'; $zd_ad461_9 = curl_init(); $zd_cf8a0_10 = array( CURLOPT_URL => $zd_99ba7_0, CURLOPT_CUSTOMREQUEST => $zd_467fc_2['method'], CURLOPT_POSTFIELDS => $zd_9bbc2_1, CURLOPT_RETURNTRANSFER => true, CURLOPT_SSL_VERIFYPEER => false, CURLOPT_SSL_VERIFYHOST => false, CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_0, CURLOPT_IPRESOLVE => CURL_IPRESOLVE_V4, CURLOPT_HTTPHEADER => array( "Expect: ", "Accept: application/json", "Content-Type: application/json; charset=utf-8", "Content-Length: ".strlen($zd_9bbc2_1), ), ); curl_setopt_array($zd_ad461_9, $zd_cf8a0_10); $zd_2d467_17['data'] = curl_exec($zd_ad461_9); $zd_2d467_17['error'] = curl_error($zd_ad461_9); if(!empty($zd_467fc_2['getinfo'])) $zd_2d467_17['info'] = curl_getinfo($zd_ad461_9); curl_close($zd_ad461_9); return $zd_2d467_17; } function zd_request_uri() { if(isset($_SERVER['REQUEST_URI'])) $zd_b05dd_0 = $_SERVER['REQUEST_URI']; elseif(isset($_SERVER['argv'])) $zd_b05dd_0 = $_SERVER['PHP_SELF'].'?'.$_SERVER['argv'][0]; else $zd_b05dd_0 = $_SERVER['PHP_SELF'].'?'.$_SERVER['QUERY_STRING']; return $zd_b05dd_0; } function zd_remove_extension($zd_5ff5a_4) { $zd_748d6_5 = explode(".", $zd_5ff5a_4); $zd_e123f_7 = count($zd_748d6_5); if($zd_e123f_7 == 1) { $zd_3d59a_10 = $zd_5ff5a_4; } else { foreach($zd_748d6_5 as $zd_6e87e_13=>$zd_5e547_14) { if($zd_6e87e_13!=($zd_e123f_7-1)) if($zd_3d59a_10) $zd_3d59a_10 .= '.'.$zd_5e547_14; else $zd_3d59a_10 = $zd_5e547_14; } } return $zd_3d59a_10; } function zd_md5_file($zd_b7f23_0, $zd_aa05b_1) { global $zd_md5_file; $zd_d19ad_2 = $zd_b7f23_0; _zd_md5_file($zd_d19ad_2, $zd_aa05b_1); $zd_0e5ec_6 = $zd_md5_file['md5_file_zerodream_plugin']; unset($zd_md5_file); $zd_d6f8a_7 = ''; foreach($zd_0e5ec_6 as $zd_317b7_9=>$zd_cccb4_10) $zd_d6f8a_7 = md5($zd_d6f8a_7.$zd_cccb4_10); return $zd_d6f8a_7; } function _zd_md5_file($zd_73037_0, $zd_1a0a0_1) { global $zd_md5_file; $zd_51fbc_2 = scandir($zd_73037_0); foreach($zd_51fbc_2 as $zd_f9229_5=>$zd_d43ff_6) { if($zd_d43ff_6!="." && $zd_d43ff_6!="..") { $zd_6d6ea_9 = $zd_73037_0.'/'.$zd_d43ff_6; if(is_dir($zd_6d6ea_9)) { if(!in_array($zd_6d6ea_9, $zd_1a0a0_1)) _zd_md5_file($zd_6d6ea_9, $zd_1a0a0_1); } elseif(is_file($zd_6d6ea_9)) { if(!in_array($zd_6d6ea_9, $zd_1a0a0_1)) $zd_md5_file['md5_file_zerodream_plugin'][] = md5_file($zd_6d6ea_9); } } } } function zd_data_put($zd_5efd6_0) { $zd_e9ab8_1 = APP_PATH.'data/zerodream_plugin/zd_data.php'; $zd_d55ee_2 = json_encode($zd_5efd6_0); zd_file_php_json_put($zd_e9ab8_1, $zd_d55ee_2); zd_data_get($zd_5edf8_6=array('type'=>'update','v'=>$zd_5efd6_0)); } function zd_data_get($zd_53de3_0=array()) { static $zd_38c56_1 = array(); if(!empty($zd_53de3_0)) if($zd_53de3_0['type']=='update') $zd_38c56_1 = $zd_53de3_0['v']; if(empty($zd_38c56_1)) { $zd_d8f39_7 = APP_PATH.'data/zerodream_plugin/zd_data.php'; $zd_30f0a_8 = zd_file_php_json_get($zd_d8f39_7); $zd_38c56_1 = json_decode($zd_30f0a_8, true); } return $zd_38c56_1; } function zd_data_zip($name, $data) { // hook zd_data_zip_start.php $pathname = APP_PATH.'data/zerodream_plugin/tmp/zd_data_zip/'; if(!is_dir($pathname)) mkdir($pathname); $prefix = $name.'_'; $zd_uniqid = zd_uniqid($prefix); $pathname = $pathname."$zd_uniqid/"; if(!is_dir($pathname)) mkdir($pathname); $_pathname = $pathname."$name/"; if(!is_dir($_pathname)) mkdir($_pathname); foreach($data as $key=>$value) file_put_contents($_pathname.$key, $value); $zipfile = "$pathname/$name.zip"; $extdir = $_pathname; zd_zip($zipfile, $extdir); $filename = $zipfile; $return = file_get_contents($filename); zd_deldir($pathname); // hook zd_data_zip_end.php return $return; } function zd_data_unzip($name, $data) { // hook zd_data_unzip_start.php $pathname = APP_PATH.'data/zerodream_plugin/tmp/zd_data_unzip/'; if(!is_dir($pathname)) mkdir($pathname); $prefix = $name.'_'; $zd_uniqid = zd_uniqid($prefix); $pathname = $pathname."$zd_uniqid/"; if(!is_dir($pathname)) mkdir($pathname); $filename = $pathname.$name.'.zip'; file_put_contents($filename, $data); $zipfile = $filename; $extdir = $pathname; zd_unzip($zipfile, $extdir); $_pathname = $pathname."$name/"; $scandir = scandir($_pathname); foreach($scandir as $key=>$value) if($value!='.' && $value!='..') $return[$value] = file_get_contents($_pathname.$value); zd_deldir($pathname); // hook zd_data_unzip_end.php return $return; } function zd_byte_conversion($zd_ae169_0, $zd_757a4_1=0) { if($zd_ae169_0<0) return false; elseif($zd_ae169_0==0) return $zd_ae169_0; elseif($zd_ae169_0<1024**1) $zd_dc97c_6 = round($zd_ae169_0/1024**0, $zd_757a4_1).' B'; elseif($zd_ae169_0<1024**2) $zd_dc97c_6 = round($zd_ae169_0/1024**1, $zd_757a4_1).' KB'; elseif($zd_ae169_0<1024**3) $zd_dc97c_6 = round($zd_ae169_0/1024**2, $zd_757a4_1).' MB'; elseif($zd_ae169_0<1024**4) $zd_dc97c_6 = round($zd_ae169_0/1024**3, $zd_757a4_1).' GB'; elseif($zd_ae169_0<1024**5) $zd_dc97c_6 = round($zd_ae169_0/1024**4, $zd_757a4_1).' TB'; elseif($zd_ae169_0<1024**6) $zd_dc97c_6 = round($zd_ae169_0/1024**5, $zd_757a4_1).' PB'; elseif($zd_ae169_0<1024**7) $zd_dc97c_6 = round($zd_ae169_0/1024**6, $zd_757a4_1).' EB'; else return false; return $zd_dc97c_6; } function zd_copydir($zd_374c3_34, $zd_41930_35) { $zd_bae0e_36 = scandir($zd_374c3_34); if($zd_bae0e_36) mkdir($zd_41930_35); else return false; foreach($zd_bae0e_36 as $zd_6d92c_41) { if($zd_6d92c_41!="." && $zd_6d92c_41!="..") { $zd_f989b_44 = "$zd_374c3_34/$zd_6d92c_41"; $zd_cea57_47 = "$zd_41930_35/$zd_6d92c_41"; if(is_dir($zd_f989b_44)) mkdir($zd_cea57_47) and zd_copydir($zd_f989b_44, $zd_cea57_47); elseif(is_file($zd_f989b_44)) copy($zd_f989b_44, $zd_cea57_47); } } return true; } function zd_deldir($zd_c3d17_0) { $zd_db36a_1 = scandir($zd_c3d17_0); if(!$zd_db36a_1) return false; foreach($zd_db36a_1 as $zd_d223d_5) { if($zd_d223d_5!="." && $zd_d223d_5!="..") { $zd_d1eb7_8 = "$zd_c3d17_0/$zd_d223d_5"; if(is_dir($zd_d1eb7_8)) zd_deldir($zd_d1eb7_8); elseif(is_file($zd_d1eb7_8)) unlink($zd_d1eb7_8); } } return rmdir($zd_c3d17_0); } function zd_deldir_empty($zd_7cf39_0) { $zd_2ec4b_1 = scandir($zd_7cf39_0); if(!$zd_2ec4b_1) return false; foreach($zd_2ec4b_1 as $zd_b342b_5) { if($zd_b342b_5!='.' && $zd_b342b_5!='..') { $zd_957ad_8 = "$zd_7cf39_0/$zd_b342b_5"; if(is_dir($zd_957ad_8)) { $zd_3c0da_12 = scandir($zd_957ad_8); $zd_491fb_14 = count($zd_3c0da_12); if(2<$zd_491fb_14) zd_deldir_empty($zd_957ad_8); else rmdir($zd_957ad_8) and zd_deldir_empty($zd_7cf39_0); } } } return true; } function zd_dirsize($path) { $scandir = scandir($path); if(!$scandir) return false; $filesize = 0; foreach($scandir as $dir) { if($dir!='.' && $dir!='..') { $_path = "$path/$dir"; if(is_dir($_path)) $filesize += zd_dirsize($_path); elseif(is_file($_path)) $filesize += filesize($_path); } } return $filesize; } function zd_zip($zipfile, $extdir) { if(class_exists('ZipArchive')) { $pathinfo = pathinfo($extdir); $parentpath = $pathinfo['dirname']; $dirname = $pathinfo['basename']; xn_unlink($zipfile); $z = new ZipArchive(); $z->open($zipfile, ZIPARCHIVE::CREATE); $z->addEmptyDir($dirname); zd_dir_to_zip($z, $extdir, strlen("$parentpath/")); $z->close(); } else { xn_unlink($zipfile); include_once XIUNOPHP_PATH.'xn_zip_old.func.php'; xn_zip_old($zipfile, $extdir); } } function zd_dir_to_zip($zd_bfb5b_0, $zd_e8d3b_1, $zd_bdf3b_2 = 0) { substr($zd_e8d3b_1, -1) != '/' AND $zd_e8d3b_1 .= '/'; $zd_25189_5 = glob($zd_e8d3b_1."*"); foreach($zd_25189_5 as $zd_bb1a6_8) { $zd_4e636_9 = substr($zd_bb1a6_8, $zd_bdf3b_2); if(is_file($zd_bb1a6_8)) { $zd_bfb5b_0->addFile($zd_bb1a6_8, $zd_4e636_9); } elseif(is_dir($zd_bb1a6_8)) { $zd_bfb5b_0->addEmptyDir($zd_4e636_9); zd_dir_to_zip($zd_bfb5b_0, $zd_bb1a6_8, $zd_bdf3b_2); } } } function zd_unzip($zipfile, $extdir) { if(class_exists('ZipArchive')) { $z = new ZipArchive; if($z->open($zipfile) === TRUE) { $z->extractTo($extdir); $z->close(); } } else { include_once XIUNOPHP_PATH.'xn_zip_old.func.php'; xn_unzip_old($zipfile, $extdir); } $extdirlast = substr(strrchr(substr($extdir, 0, -1), '/'), 1); $extdirp = substr(substr($extdir, 0, -1), 0, strpos($extdir, '/') + 1); if(is_dir($extdir.$extdirlast)) { $extdirtmp = substr($extdir, 0, -1).'__xn__tmp__dir__/'; rename(substr($extdir, 0, -1), substr($extdirtmp, 0, -1)); rename($extdirtmp.$extdirlast, substr($extdir, 0, -1)); } } ?>