
<?php

/*
    Powered by ZeroDream
    Optimized by ZeroDream
	https://www.zerodream.top/xiuno.htm
	
	修改文件将有禁止使用帐户风险
*/

 define('DEFINED_ZERODREAM_PLUGIN_ZERODREAM_FUNCTION', true); function zd_kv__get($zd_203a2_0) { $zd_dcc21_1 = db_find_one('zerodream_kv', array('k'=>$zd_203a2_0)); return $zd_dcc21_1 ? xn_json_decode($zd_dcc21_1['v']) : NULL; } function zd_kv_get($zd_3efaa_0) { static $zd_dfa7f_1 = array(); strlen($zd_3efaa_0) > 32 AND $zd_3efaa_0 = md5($zd_3efaa_0); if(!isset($zd_dfa7f_1[$zd_3efaa_0])) $zd_dfa7f_1[$zd_3efaa_0] = zd_kv__get($zd_3efaa_0); return $zd_dfa7f_1[$zd_3efaa_0]; } function zd_kv_set($zd_0ef3e_0, $zd_134a6_1, $zd_22f94_2 = 0) { strlen($zd_0ef3e_0) > 32 AND $zd_0ef3e_0 = md5($zd_0ef3e_0); $zd_1f4f5_6 = array('k'=>$zd_0ef3e_0, 'v'=>xn_json_encode($zd_134a6_1)); $zd_942f6_9 = db_replace('zerodream_kv', $zd_1f4f5_6); return $zd_942f6_9; } function zd_kv_delete($zd_21a62_0) { strlen($zd_21a62_0) > 32 AND $zd_21a62_0 = md5($zd_21a62_0); $zd_e75b8_4 = db_delete('zerodream_kv', array('k'=>$zd_21a62_0)); return $zd_e75b8_4; } function zd_user_group_update($zd_cc943_0, $zd_4e4fd_1=false) { global $grouplist; $zd_42e4c_2 = user__read($zd_cc943_0); if(!$zd_4e4fd_1) if($zd_42e4c_2['gid']<100) return false; foreach($grouplist as $zd_40e6e_6) { if($zd_40e6e_6['gid'] < 100) continue; if($zd_42e4c_2['credits']>$zd_40e6e_6['creditsfrom'] && $zd_42e4c_2['credits']<$zd_40e6e_6['creditsto']) { if($zd_42e4c_2['gid'] != $zd_40e6e_6['gid']) { user__update($zd_cc943_0, array('gid'=>$zd_40e6e_6['gid'])); return true; } } } return false; } 
// ~ 代码来自 xiuno ---> 开始
 function _xn_search_keyword_safe($zd_f7abf_0) { $zd_f7abf_0 = str_replace(array('\'', '\\', '"', '%', '<', '>', '`', '*', '&', '#'), '', $zd_f7abf_0); $zd_f7abf_0 = preg_replace('#\s+#', ' ', $zd_f7abf_0); $zd_f7abf_0 = trim($zd_f7abf_0); return $zd_f7abf_0; } 
// ~ 代码来自 xiuno ---> 结束
 function zd_url_rewrite() { global $conf; if(!$conf['url_rewrite_on']) $zd_1e9c6_10 = '?'; return $zd_1e9c6_10; } function zd_plugin_check($zd_d8805_0) { $zd_a57b0_1 = APP_PATH."plugin/$zd_d8805_0/conf.json"; if(!is_file($zd_a57b0_1)) return false; $zd_09420_4 = file_get_contents($zd_a57b0_1); $zd_c231f_6 = json_decode($zd_09420_4, true); if($zd_c231f_6['installed'] && $zd_c231f_6['enable']) $zd_a5b5b_10 = true; else $zd_a5b5b_10 = false; return $zd_a5b5b_10; } function zd_plugin_conf_zerodream_get($zd_706d8_0, $zd_09daa_1) { if(!is_file($zd_706d8_0)) return false; $zd_ab6dd_3 = xn_json_decode(file_get_contents($zd_706d8_0)); if(empty($zd_ab6dd_3)) return false; if(is_file($zd_09daa_1)) $zd_177e0_7 = xn_json_decode(file_get_contents($zd_09daa_1)); if(empty($zd_177e0_7)) $zd_177e0_7 = array(); $zd_f80e0_11 = array_merge($zd_ab6dd_3, $zd_177e0_7); return $zd_f80e0_11; } function zd_uniqid($zd_208bd_0='') { $zd_50625_1 = $zd_208bd_0.md5(uniqid(mt_rand(),true)); return $zd_50625_1; } function zd_curl($zd_1b5cc_0, $zd_7ba9b_1=null, $zd_3a0fe_2=array()) { if(!isset($zd_3a0fe_2['method'])) $zd_3a0fe_2['method'] = 'GET'; $zd_1ca7c_9 = curl_init(); $zd_eeb42_10 = array( CURLOPT_URL => $zd_1b5cc_0, CURLOPT_CUSTOMREQUEST => $zd_3a0fe_2['method'], CURLOPT_POSTFIELDS => $zd_7ba9b_1, CURLOPT_RETURNTRANSFER => true, CURLOPT_SSL_VERIFYPEER => false, CURLOPT_SSL_VERIFYHOST => false, CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_0, CURLOPT_IPRESOLVE => CURL_IPRESOLVE_V4, CURLOPT_HTTPHEADER => array( "Expect: ", "Accept: application/json", "Content-Type: application/json; charset=utf-8", "Content-Length: ".strlen($zd_7ba9b_1), ), ); curl_setopt_array($zd_1ca7c_9, $zd_eeb42_10); $zd_d17aa_17['data'] = curl_exec($zd_1ca7c_9); $zd_d17aa_17['error'] = curl_error($zd_1ca7c_9); if(!empty($zd_3a0fe_2['getinfo'])) $zd_d17aa_17['info'] = curl_getinfo($zd_1ca7c_9); curl_close($zd_1ca7c_9); return $zd_d17aa_17; } function zd_request_uri() { if(isset($_SERVER['REQUEST_URI'])) $zd_2a8d5_0 = $_SERVER['REQUEST_URI']; elseif(isset($_SERVER['argv'])) $zd_2a8d5_0 = $_SERVER['PHP_SELF'].'?'.$_SERVER['argv'][0]; else $zd_2a8d5_0 = $_SERVER['PHP_SELF'].'?'.$_SERVER['QUERY_STRING']; return $zd_2a8d5_0; } function zd_remove_extension($zd_57180_4) { $zd_cc67d_5 = explode(".", $zd_57180_4); $zd_551a1_7 = count($zd_cc67d_5); if($zd_551a1_7 == 1) { $zd_1cc61_10 = $zd_57180_4; } else { foreach($zd_cc67d_5 as $zd_2558a_13=>$zd_20061_14) { if($zd_2558a_13!=($zd_551a1_7-1)) if($zd_1cc61_10) $zd_1cc61_10 .= '.'.$zd_20061_14; else $zd_1cc61_10 = $zd_20061_14; } } return $zd_1cc61_10; } function zd_md5_file($zd_b4d7c_0, $zd_79b0a_1) { global $zd_md5_file; $zd_db29f_2 = $zd_b4d7c_0; _zd_md5_file($zd_db29f_2, $zd_79b0a_1); $zd_9cedd_6 = $zd_md5_file['md5_file_zerodream_plugin']; unset($zd_md5_file); $zd_16757_7 = ''; foreach($zd_9cedd_6 as $zd_ca156_9=>$zd_d6c21_10) $zd_16757_7 = md5($zd_16757_7.$zd_d6c21_10); return $zd_16757_7; } function _zd_md5_file($zd_574d6_0, $zd_7cf39_1) { global $zd_md5_file; $zd_8aa96_2 = scandir($zd_574d6_0); foreach($zd_8aa96_2 as $zd_5d601_5=>$zd_c3e00_6) { if($zd_c3e00_6!="." && $zd_c3e00_6!="..") { $zd_02234_9 = $zd_574d6_0.'/'.$zd_c3e00_6; if(is_dir($zd_02234_9)) { if(!in_array($zd_02234_9, $zd_7cf39_1)) _zd_md5_file($zd_02234_9, $zd_7cf39_1); } elseif(is_file($zd_02234_9)) { if(!in_array($zd_02234_9, $zd_7cf39_1)) $zd_md5_file['md5_file_zerodream_plugin'][] = md5_file($zd_02234_9); } } } } function zd_data_put($zd_e3eb9_0) { $zd_45aa9_1 = APP_PATH.'data/zerodream_plugin/zd_data.json'; $zd_94e2f_2 = json_encode($zd_e3eb9_0); file_put_contents($zd_45aa9_1, $zd_94e2f_2); zd_data_get($zd_bb485_6=true); } function zd_data_get($zd_60bbc_0=false) { static $zd_57941_1 = array(); if(empty($zd_57941_1) || $zd_60bbc_0) { $zd_db5df_4 = APP_PATH.'data/zerodream_plugin/zd_data.json'; $zd_524a1_5 = file_get_contents($zd_db5df_4); $zd_57941_1 = json_decode($zd_524a1_5, true); } return $zd_57941_1; } function zd_data_zip($name, $data) { // hook zd_data_zip_start.php $pathname = APP_PATH.'data/zerodream_plugin/tmp/zd_data_zip/'; if(!is_dir($pathname)) mkdir($pathname); $prefix = $name.'_'; $zd_uniqid = zd_uniqid($prefix); $pathname = $pathname."$zd_uniqid/"; if(!is_dir($pathname)) mkdir($pathname); $_pathname = $pathname."$name/"; if(!is_dir($_pathname)) mkdir($_pathname); foreach($data as $key=>$value) file_put_contents($_pathname.$key, $value); $zipfile = "$pathname/$name.zip"; $extdir = $_pathname; zd_zip($zipfile, $extdir); $filename = $zipfile; $return = file_get_contents($filename); zd_deldir($pathname); // hook zd_data_zip_end.php return $return; } function zd_data_unzip($name, $data) { // hook zd_data_unzip_start.php $pathname = APP_PATH.'data/zerodream_plugin/tmp/zd_data_unzip/'; if(!is_dir($pathname)) mkdir($pathname); $prefix = $name.'_'; $zd_uniqid = zd_uniqid($prefix); $pathname = $pathname."$zd_uniqid/"; if(!is_dir($pathname)) mkdir($pathname); $filename = $pathname.$name.'.zip'; file_put_contents($filename, $data); $zipfile = $filename; $extdir = $pathname; zd_unzip($zipfile, $extdir); $_pathname = $pathname."$name/"; $scandir = scandir($_pathname); foreach($scandir as $key=>$value) if($value!='.' && $value!='..') $return[$value] = file_get_contents($_pathname.$value); zd_deldir($pathname); // hook zd_data_unzip_end.php return $return; } function zd_byte_conversion($zd_a901e_0, $zd_6d5a0_1=0) { if($zd_a901e_0<0) return false; elseif($zd_a901e_0==0) return $zd_a901e_0; elseif($zd_a901e_0<1024**1) $zd_9d105_6 = round($zd_a901e_0/1024**0, $zd_6d5a0_1).' B'; elseif($zd_a901e_0<1024**2) $zd_9d105_6 = round($zd_a901e_0/1024**1, $zd_6d5a0_1).' KB'; elseif($zd_a901e_0<1024**3) $zd_9d105_6 = round($zd_a901e_0/1024**2, $zd_6d5a0_1).' MB'; elseif($zd_a901e_0<1024**4) $zd_9d105_6 = round($zd_a901e_0/1024**3, $zd_6d5a0_1).' GB'; elseif($zd_a901e_0<1024**5) $zd_9d105_6 = round($zd_a901e_0/1024**4, $zd_6d5a0_1).' TB'; elseif($zd_a901e_0<1024**6) $zd_9d105_6 = round($zd_a901e_0/1024**5, $zd_6d5a0_1).' PB'; elseif($zd_a901e_0<1024**7) $zd_9d105_6 = round($zd_a901e_0/1024**6, $zd_6d5a0_1).' EB'; else return false; return $zd_9d105_6; } function zd_copydir($zd_f54c6_34, $zd_942d6_35) { $zd_2a9df_36 = scandir($zd_f54c6_34); if($zd_2a9df_36) mkdir($zd_942d6_35); else return false; foreach($zd_2a9df_36 as $zd_2734c_41) { if($zd_2734c_41!="." && $zd_2734c_41!="..") { $zd_09142_44 = "$zd_f54c6_34/$zd_2734c_41"; $zd_016c9_47 = "$zd_942d6_35/$zd_2734c_41"; if(is_dir($zd_09142_44)) mkdir($zd_016c9_47) and zd_copydir($zd_09142_44, $zd_016c9_47); elseif(is_file($zd_09142_44)) copy($zd_09142_44, $zd_016c9_47); } } return true; } function zd_deldir($zd_c8b35_0) { $zd_da237_1 = scandir($zd_c8b35_0); if(!$zd_da237_1) return false; foreach($zd_da237_1 as $zd_dc241_5) { if($zd_dc241_5!="." && $zd_dc241_5!="..") { $zd_ba65e_8 = "$zd_c8b35_0/$zd_dc241_5"; if(is_dir($zd_ba65e_8)) zd_deldir($zd_ba65e_8); elseif(is_file($zd_ba65e_8)) unlink($zd_ba65e_8); } } return rmdir($zd_c8b35_0); } function zd_deldir_empty($zd_c9928_0) { $zd_56b09_1 = scandir($zd_c9928_0); if(!$zd_56b09_1) return false; foreach($zd_56b09_1 as $zd_a9d32_5) { if($zd_a9d32_5!='.' && $zd_a9d32_5!='..') { $zd_d41f6_8 = "$zd_c9928_0/$zd_a9d32_5"; if(is_dir($zd_d41f6_8)) { $zd_b0466_12 = scandir($zd_d41f6_8); $zd_e7369_14 = count($zd_b0466_12); if(2<$zd_e7369_14) zd_deldir_empty($zd_d41f6_8); else rmdir($zd_d41f6_8) and zd_deldir_empty($zd_c9928_0); } } } return true; } function zd_dirsize($path) { $scandir = scandir($path); if(!$scandir) return false; $filesize = 0; foreach($scandir as $dir) { if($dir!='.' && $dir!='..') { $_path = "$path/$dir"; if(is_dir($_path)) $filesize += zd_dirsize($_path); elseif(is_file($_path)) $filesize += filesize($_path); } } return $filesize; } function zd_zip($zipfile, $extdir) { if(class_exists('ZipArchive')) { $pathinfo = pathinfo($extdir); $parentpath = $pathinfo['dirname']; $dirname = $pathinfo['basename']; xn_unlink($zipfile); $z = new ZipArchive(); $z->open($zipfile, ZIPARCHIVE::CREATE); $z->addEmptyDir($dirname); zd_dir_to_zip($z, $extdir, strlen("$parentpath/")); $z->close(); } else { xn_unlink($zipfile); include_once XIUNOPHP_PATH.'xn_zip_old.func.php'; xn_zip_old($zipfile, $extdir); } } function zd_dir_to_zip($zd_168db_0, $zd_1c2d9_1, $zd_1bd09_2 = 0) { substr($zd_1c2d9_1, -1) != '/' AND $zd_1c2d9_1 .= '/'; $zd_a8b80_5 = glob($zd_1c2d9_1."*"); foreach($zd_a8b80_5 as $zd_1f063_8) { $zd_14135_9 = substr($zd_1f063_8, $zd_1bd09_2); if(is_file($zd_1f063_8)) { $zd_168db_0->addFile($zd_1f063_8, $zd_14135_9); } elseif(is_dir($zd_1f063_8)) { $zd_168db_0->addEmptyDir($zd_14135_9); zd_dir_to_zip($zd_168db_0, $zd_1f063_8, $zd_1bd09_2); } } } function zd_unzip($zipfile, $extdir) { if(class_exists('ZipArchive')) { $z = new ZipArchive; if($z->open($zipfile) === TRUE) { $z->extractTo($extdir); $z->close(); } } else { include_once XIUNOPHP_PATH.'xn_zip_old.func.php'; xn_unzip_old($zipfile, $extdir); } $extdirlast = substr(strrchr(substr($extdir, 0, -1), '/'), 1); $extdirp = substr(substr($extdir, 0, -1), 0, strpos($extdir, '/') + 1); if(is_dir($extdir.$extdirlast)) { $extdirtmp = substr($extdir, 0, -1).'__xn__tmp__dir__/'; rename(substr($extdir, 0, -1), substr($extdirtmp, 0, -1)); rename($extdirtmp.$extdirlast, substr($extdir, 0, -1)); } } ?>