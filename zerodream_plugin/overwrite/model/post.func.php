
<?php

/*
    Powered by ZeroDream
	https://www.zerodream.top/xiuno.htm
	
	修改文件将有禁止使用帐户风险
*/

 // hook model_post_start.php // hook model_post_data.php function post__create($zd_94dd0_0, $zd_37a67_1) { // hook model_post__create_start.php post_message_fmt($zd_94dd0_0, $zd_37a67_1); // hook model_post__create_insert_before.php $zd_43fb4_4 = db_insert('post', $zd_94dd0_0); // hook model_post__create_end.php return $zd_43fb4_4; } function post__update($zd_936f8_0, $zd_3a2a0_1) { // hook model_post__update_start.php $zd_8e531_2 = db_update('post', array('pid'=>$zd_936f8_0), $zd_3a2a0_1); // hook model_post__update_end.php return $zd_8e531_2; } function post__read($zd_c1b58_0) { // hook model_post__read_start.php $zd_5fbc2_1 = db_find_one('post', array('pid'=>$zd_c1b58_0)); // hook model_post__read_end.php return $zd_5fbc2_1; } function post__delete($zd_52161_0) { // hook model_post__delete_start.php $zd_8aeb0_1 = db_delete('post', array('pid'=>$zd_52161_0)); // hook model_post__delete_end.php return $zd_8aeb0_1; } function post__find($zd_010f9_0 = array(), $zd_2bd94_1 = array(), $zd_94536_2 = 1, $zd_71a0f_3 = 20) { // hook model_post__find_start.php $zd_3f56b_4 = db_find('post', $zd_010f9_0, $zd_2bd94_1, $zd_94536_2, $zd_71a0f_3, 'pid'); // hook model_post__find_end.php return $zd_3f56b_4; } function post_create($zd_a03a3_0, $zd_72199_1, $zd_ce6d3_2) { global $conf, $time; // hook model_post_create_start.php $zd_05c4d_3 = post__create($zd_a03a3_0, $zd_ce6d3_2); if(!$zd_05c4d_3) return $zd_05c4d_3; $zd_4b628_8 = $zd_a03a3_0['tid']; $zd_9357e_10 = $zd_a03a3_0['uid']; if($zd_4b628_8 > 0) { thread__update($zd_4b628_8, array('posts+'=>1, 'lastpid'=>$zd_05c4d_3, 'lastuid'=>$zd_9357e_10, 'last_date'=>$time)); $zd_9357e_10 AND user__update($zd_9357e_10, array('posts+'=>1)); runtime_set('posts+', 1); runtime_set('todayposts+', 1); forum__update($zd_72199_1, array('todayposts+'=>1)); } forum_list_cache_delete(); $zd_f10a3_19 = $zd_a03a3_0['message']; attach_assoc_post($zd_05c4d_3); user_update_group($zd_9357e_10); // hook model_post_create_end.php return $zd_05c4d_3; } function post_update($zd_fbbc7_0, $zd_904ea_1, $zd_118a7_2 = 0) { global $conf, $user, $gid; $zd_eb60a_3 = post__read($zd_fbbc7_0); if(empty($zd_eb60a_3)) return FALSE; $zd_118a7_2 = $zd_eb60a_3['tid']; $zd_f09a4_8 = $zd_eb60a_3['uid']; $zd_ac6a1_10 = $zd_eb60a_3['isfirst']; // hook model_post_update_start.php post_message_fmt($zd_904ea_1, $gid); // hook model_post_create_post__create_before.php $zd_fd9e8_13 = post__update($zd_fbbc7_0, $zd_904ea_1); attach_assoc_post($zd_fbbc7_0); // hook model_post_update_end.php return $zd_fd9e8_13; } function post_read($zd_d3edf_0) { // hook model_post_read_start.php $zd_bd9c8_1 = post__read($zd_d3edf_0); post_format($zd_bd9c8_1); // hook model_post_read_end.php return $zd_bd9c8_1; } function post_read_cache($zd_4a204_0) { // hook model_post_read_cache_start.php static $zd_914b5_1 = array(); if(isset($zd_914b5_1[$zd_4a204_0])) return $zd_914b5_1[$zd_4a204_0]; $zd_914b5_1[$zd_4a204_0] = post_read($zd_4a204_0); // hook model_post_read_cache_end.php return $zd_914b5_1[$zd_4a204_0]; } function post_delete($zd_87e75_0) { global $conf; $zd_e3bfd_1 = post_read_cache($zd_87e75_0); if(empty($zd_e3bfd_1)) return TRUE; $zd_69987_4 = $zd_e3bfd_1['tid']; $zd_c8add_6 = $zd_e3bfd_1['uid']; $zd_e1a34_8 = thread_read_cache($zd_69987_4); $zd_75317_10 = $zd_e1a34_8['fid']; // hook model_post_delete_start.php if(!$zd_e3bfd_1['isfirst']) { thread__update($zd_69987_4, array('posts-'=>1)); $zd_c8add_6 AND user__update($zd_c8add_6, array('posts-'=>1)); runtime_set('posts-', 1); } else { } ($zd_e3bfd_1['images'] || $zd_e3bfd_1['files']) AND attach_delete_by_pid($zd_87e75_0); $zd_ea06a_19 = post__delete($zd_87e75_0); if($zd_ea06a_19 && !$zd_e3bfd_1['isfirst'] && $zd_87e75_0 == $zd_e1a34_8['lastpid']) { thread_update_last($zd_69987_4); } // hook model_post_delete_end.php return $zd_ea06a_19; } function post_delete_by_tid($zd_fb65e_0) { // hook model_post_delete_by_tid_start.php $zd_a52b3_1 = post_find_by_tid($zd_fb65e_0); foreach($zd_a52b3_1 as $zd_7b690_4) { post_delete($zd_7b690_4['pid']); } // hook model_post_delete_by_tid_end.php return count($zd_a52b3_1); } function post_delete_by_uid($zd_82a73_0) { // hook model_post_delete_by_uid_start.php $zd_30da6_1 = db_delete('post', array('uid'=>$zd_82a73_0)); // hook model_post_delete_by_uid_end.php return $zd_30da6_1; } function post_find($zd_38ccf_0 = array(), $zd_f44f0_1 = array(), $zd_2c9ce_2 = 1, $zd_ab0f3_3 = 20) { // hook model_post_find_start.php $zd_14f6a_4 = post__find($zd_38ccf_0, $zd_f44f0_1, $zd_2c9ce_2, $zd_ab0f3_3); $zd_879a6_9 = 1; if($zd_14f6a_4) foreach($zd_14f6a_4 as &$zd_55c78_12) { $zd_55c78_12['floor'] = $zd_879a6_9++; post_format($zd_55c78_12); } // hook model_post_find_end.php return $zd_14f6a_4; } function post_find_by_tid($zd_763c9_0, $zd_4d084_1 = 1, $zd_365ba_2 = 50) { global $conf; // hook model_post_find_by_tid_start.php $zd_ebbb5_3 = post__find(array('tid'=>$zd_763c9_0), array('pid'=>1), $zd_4d084_1, $zd_365ba_2); if($zd_ebbb5_3) { $zd_ab9b2_8 = ($zd_4d084_1 - 1)* $zd_365ba_2 + 1; foreach($zd_ebbb5_3 as &$zd_2fe49_12) { $zd_2fe49_12['floor'] = $zd_ab9b2_8++; post_format($zd_2fe49_12); } } // hook model_post_find_by_tid_end.php return $zd_ebbb5_3; } function user_post_message_format(&$zd_5109d_0) { if(xn_strlen($zd_5109d_0) < 100) return; $zd_5109d_0 = preg_replace('#<blockquote\s+class="blockquote">.*?</blockquote>#is', '', $zd_5109d_0); $zd_5109d_0 = str_ireplace(array('<br>', '<br />', '<br/>', '</p>', '</tr>', '</div>', '</li>', '</dd>'. '</dt>'), "\r\n", $zd_5109d_0); $zd_5109d_0 = str_ireplace(array('&nbsp;'), " ", $zd_5109d_0); $zd_5109d_0 = strip_tags($zd_5109d_0); $zd_5109d_0 = preg_replace('#[\r\n]+#', "\n", $zd_5109d_0); $zd_5109d_0 = xn_substr(trim($zd_5109d_0), 0, 100); $zd_5109d_0 = str_replace("\n", '<br>', $zd_5109d_0); } function post_count($zd_b8459_0 = array()) { // hook model_post_count_start.php $zd_48054_1 = db_count('post', $zd_b8459_0); // hook model_post_count_end.php return $zd_48054_1; } function post_maxid() { // hook model_post_maxid_start.php $zd_5447b_0 = db_maxid('post', 'pid'); // hook model_post_maxid_end.php return $zd_5447b_0; } function post_safe_info($zd_225dd_0) { // hook model_post_safe_info_start.php unset($zd_225dd_0['userip']); if(!empty($zd_225dd_0['user'])) { $zd_225dd_0['user'] = user_safe_info($zd_225dd_0['user']); } // hook model_post_safe_info_end.php return $zd_225dd_0; } function post_find_by_pids($zd_a97a9_0, $zd_a5567_1 = array('pid'=>-1)) { // hook model_post_find_by_pids_start.php if(!$zd_a97a9_0) return array(); $zd_a354f_3 = db_find('post', array('pid'=>$zd_a97a9_0), $zd_a5567_1, 1, 1000, 'pid'); if($zd_a354f_3) foreach($zd_a354f_3 as &$zd_8b047_8) post_format($zd_8b047_8); // hook model_post_find_by_pids_end.php return $zd_a354f_3; } function post_highlight_keyword($zd_74501_0, $zd_830b0_1) { // hook model_post_highlight_keyword_start.php $zd_4561f_2 = str_ireplace($zd_830b0_1, '<span class="red">'.$zd_830b0_1.'</span>', $zd_74501_0); // hook model_post_highlight_keyword_end.php return $zd_4561f_2; } function post_file_list_html($zd_14fcc_0, $zd_ea9ea_1 = FALSE) { global $uid,$user,$gid,$group,$action,$thread,$tid; if(empty($zd_14fcc_0)) return ''; // hook model_post_file_list_html_start.php // hook model_post_file_list_html_data.php $zd_f8f20_3 = '<fieldset id="filelist" class="fieldset">'."\r\n"; $zd_f8f20_3 .= '<legend>上传的附件：</legend>'."\r\n"; $zd_f8f20_3 .= '<ul class="attachlist">'."\r\n"; foreach ($zd_14fcc_0 as &$zd_67333_7) { // hook model_post_file_list_html_filelist_start.php $zd_81645_8 = url("attach-download-$zd_67333_7[aid]"); // hook model_post_file_list_html_filelist_data.php $zd_f8f20_3 .= '<li aid="'.$zd_67333_7['aid'].'">'."\r\n"; $zd_f8f20_3 .= '     <input type="hidden" name="attach_aid[]" value="'.$zd_67333_7['aid'].'" />'."\r\n"; $zd_f8f20_3 .= '		<a href="'.$zd_81645_8.'" target="_blank">'."\r\n"; $zd_f8f20_3 .= '			<i class="icon filetype '.$zd_67333_7['filetype'].'"></i>'."\r\n"; $zd_f8f20_3 .= '			'.$zd_67333_7['orgfilename']."\r\n"; $zd_f8f20_3 .= '		</a>'."\r\n"; // hook model_post_file_list_html_delete_before.php $zd_ea9ea_1 AND $zd_f8f20_3 .= '		<a href="javascript:void(0)" class="delete ml-3"><i class="icon-remove"></i> '.lang('delete').'</a>'."\r\n"; // hook model_post_file_list_html_delete_after.php $zd_f8f20_3 .= '</li>'."\r\n"; // hook model_post_file_list_html_filelist_end.php }; $zd_f8f20_3 .= '</ul>'."\r\n"; $zd_f8f20_3 .= '</fieldset>'."\r\n"; // hook model_post_file_list_html_end.php return $zd_f8f20_3; } function post_format(&$zd_a9b79_0) { global $conf, $uid, $sid, $gid, $longip; if(empty($zd_a9b79_0)) return; $zd_a9b79_0['create_date_fmt'] = humandate($zd_a9b79_0['create_date']); $zd_5eae5_4 = user_read_cache($zd_a9b79_0['uid']); // hook model_post_format_start.php $zd_a9b79_0['username'] = array_value($zd_5eae5_4, 'username'); $zd_a9b79_0['user_avatar_url'] = array_value($zd_5eae5_4, 'avatar_url'); $zd_a9b79_0['user'] = $zd_5eae5_4 ? $zd_5eae5_4 : user_guest(); !isset($zd_a9b79_0['floor']) AND $zd_a9b79_0['floor'] = ''; $zd_7814d_15 = thread_read_cache($zd_a9b79_0['tid']); $zd_a9b79_0['allowupdate'] = ($uid == $zd_a9b79_0['uid']) || forum_access_mod($zd_7814d_15['fid'], $gid, 'allowupdate'); $zd_a9b79_0['allowdelete'] = ($uid == $zd_a9b79_0['uid']) || forum_access_mod($zd_7814d_15['fid'], $gid, 'allowdelete'); $zd_a9b79_0['user_url'] = url("user-$zd_a9b79_0[uid]".($zd_a9b79_0['uid'] ? '' : "-$zd_a9b79_0[pid]")); if($zd_a9b79_0['files'] > 0) { list($zd_d9087_28, $zd_3aab4_29, $zd_959d0_30) = attach_find_by_pid($zd_a9b79_0['pid']); $zd_a9b79_0['filelist'] = $zd_959d0_30; } else { $zd_a9b79_0['filelist'] = array(); } $zd_a9b79_0['classname'] = 'post'; // hook model_post_format_end.php } function post_message_fmt(&$zd_ffecc_0, $zd_e0875_1) { // hook post_message_fmt_start.php $zd_ffecc_0['message'] = xn_substr($zd_ffecc_0['message'], 0, 2028000); $zd_ffecc_0['message_fmt'] = htmlspecialchars($zd_ffecc_0['message']); $zd_ffecc_0['doctype'] == 0 && $zd_ffecc_0['message_fmt'] = ($zd_e0875_1 == 1 ? $zd_ffecc_0['message'] : xn_html_safe($zd_ffecc_0['message'])); $zd_ffecc_0['doctype'] == 1 && $zd_ffecc_0['message_fmt'] = xn_txt_to_html($zd_ffecc_0['message']); // hook post_message_fmt_end.php !empty($zd_ffecc_0['quotepid']) && $zd_ffecc_0['quotepid'] > 0 && $zd_ffecc_0['message_fmt'] = post_quote($zd_ffecc_0['quotepid']).$zd_ffecc_0['message_fmt']; } function post_brief($zd_47c7b_0, $zd_e5121_1 = 100) { // hook post_brief_start.php $zd_47c7b_0 = strip_tags($zd_47c7b_0); $zd_47c7b_0 = htmlspecialchars($zd_47c7b_0); $zd_d03e1_6 = xn_strlen($zd_47c7b_0) > $zd_e5121_1 ? ' ... ' : ''; $zd_47c7b_0 = xn_substr($zd_47c7b_0, 0, $zd_e5121_1).$zd_d03e1_6; // hook post_brief_end.php return $zd_47c7b_0; } function post_quote($zd_499f1_0) { $zd_0950c_1 = post__read($zd_499f1_0); if(empty($zd_0950c_1)) return ''; $zd_0cb07_4 = $zd_0950c_1['uid']; $zd_ae855_6 = $zd_0950c_1['message']; // hook post_quote_start.php $zd_ae855_6 = post_brief($zd_ae855_6, 100); $zd_8e40d_10 = url("user-$zd_0cb07_4"); $zd_c4860_12 = user_read_cache($zd_0cb07_4); $zd_b14eb_14 = '<blockquote class="blockquote">
		<a href="'.$zd_8e40d_10.'" class="text-small text-muted user">
			<img class="avatar-1" src="'.$zd_c4860_12['avatar_url'].'">
			'.$zd_c4860_12['username'].'
		</a>
		'.$zd_ae855_6.'
		</blockquote>'; // hook post_quote_end.php return $zd_b14eb_14; } function post_list_access_filter(&$postlist, $gid) { global $conf, $forumlist; if(empty($postlist)) return; // hook model_post_list_access_filter_start.php foreach($postlist as $pid=>$post) { $thread = thread__read($post['tid']); $fid = $thread['fid']; if(empty($forumlist[$fid]['accesson'])) continue; if($thread['top'] > 0) continue; if(!forum_access_user($fid, $gid, 'allowread')) { unset($postlist[$pid]); } } // hook model_post_list_access_filter_end.php } // hook model_post_end.php ?>