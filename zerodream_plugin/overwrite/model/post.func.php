
<?php

/*
    Powered by ZeroDream
	https://www.zerodream.top/xiuno.htm
	
	修改文件将有禁止使用帐户风险
*/

 // hook model_post_start.php // hook model_post_data.php function post__create($arr, $gid) { // hook model_post__create_start.php post_message_fmt($arr, $gid); // hook model_post__create_insert_before.php $zd_281ca_0 = db_insert('post', $arr); // hook model_post__create_end.php return $zd_281ca_0; } function post__update($pid, $arr) { // hook model_post__update_start.php $zd_3bb3f_0 = db_update('post', array('pid'=>$pid), $arr); // hook model_post__update_end.php return $zd_3bb3f_0; } function post__read($pid) { // hook model_post__read_start.php $zd_c9339_0 = db_find_one('post', array('pid'=>$pid)); // hook model_post__read_end.php return $zd_c9339_0; } function post__delete($pid) { // hook model_post__delete_start.php $zd_14431_0 = db_delete('post', array('pid'=>$pid)); // hook model_post__delete_end.php return $zd_14431_0; } function post__find($cond = array(), $orderby = array(), $page = 1, $pagesize = 20) { // hook model_post__find_start.php $zd_4a72b_0 = db_find('post', $cond, $orderby, $page, $pagesize, 'pid'); // hook model_post__find_end.php return $zd_4a72b_0; } function post_create($arr, $fid, $gid) { global $conf, $time; // hook model_post_create_start.php $zd_16661_0 = post__create($arr, $gid); if(!$zd_16661_0) return $zd_16661_0; $zd_fb40f_3 = $arr['tid']; $zd_6c9f2_4 = $arr['uid']; if($zd_fb40f_3 > 0) { thread__update($zd_fb40f_3, array('posts+'=>1, 'lastpid'=>$zd_16661_0, 'lastuid'=>$zd_6c9f2_4, 'last_date'=>$time)); $zd_6c9f2_4 AND user__update($zd_6c9f2_4, array('posts+'=>1)); runtime_set('posts+', 1); runtime_set('todayposts+', 1); forum__update($fid, array('todayposts+'=>1)); } forum_list_cache_delete(); $zd_ddb4c_11 = $arr['message']; attach_assoc_post($zd_16661_0); user_update_group($zd_6c9f2_4); // hook model_post_create_end.php return $zd_16661_0; } function post_update($pid, $arr, $tid = 0) { global $conf, $user, $gid; $zd_e500e_0 = post__read($pid); if(empty($zd_e500e_0)) return FALSE; $tid = $zd_e500e_0['tid']; $zd_bd893_3 = $zd_e500e_0['uid']; $zd_a8c21_5 = $zd_e500e_0['isfirst']; // hook model_post_update_start.php post_message_fmt($arr, $gid); // hook model_post_create_post__create_before.php $zd_57633_7 = post__update($pid, $arr); attach_assoc_post($pid); // hook model_post_update_end.php return $zd_57633_7; } function post_read($pid) { // hook model_post_read_start.php $zd_c5715_0 = post__read($pid); post_format($zd_c5715_0); // hook model_post_read_end.php return $zd_c5715_0; } function post_read_cache($pid) { // hook model_post_read_cache_start.php static $zd_13fac_0 = array(); if(isset($zd_13fac_0[$pid])) return $zd_13fac_0[$pid]; $zd_13fac_0[$pid] = post_read($pid); // hook model_post_read_cache_end.php return $zd_13fac_0[$pid]; } function post_delete($pid) { global $conf; $zd_3f041_0 = post_read_cache($pid); if(empty($zd_3f041_0)) return TRUE; $zd_47bac_2 = $zd_3f041_0['tid']; $zd_fb07d_4 = $zd_3f041_0['uid']; $zd_076ec_6 = thread_read_cache($zd_47bac_2); $zd_cd867_8 = $zd_076ec_6['fid']; // hook model_post_delete_start.php if(!$zd_3f041_0['isfirst']) { thread__update($zd_47bac_2, array('posts-'=>1)); $zd_fb07d_4 AND user__update($zd_fb07d_4, array('posts-'=>1)); runtime_set('posts-', 1); } else { } ($zd_3f041_0['images'] || $zd_3f041_0['files']) AND attach_delete_by_pid($pid); $zd_bd5b6_16 = post__delete($pid); if($zd_bd5b6_16 && !$zd_3f041_0['isfirst'] && $pid == $zd_076ec_6['lastpid']) { thread_update_last($zd_47bac_2); } // hook model_post_delete_end.php return $zd_bd5b6_16; } function post_delete_by_tid($tid) { // hook model_post_delete_by_tid_start.php $zd_d683d_0 = post_find_by_tid($tid); foreach($zd_d683d_0 as $zd_e1234_2) { post_delete($zd_e1234_2['pid']); } // hook model_post_delete_by_tid_end.php return count($zd_d683d_0); } function post_delete_by_uid($uid) { // hook model_post_delete_by_uid_start.php $zd_51966_0 = db_delete('post', array('uid'=>$uid)); // hook model_post_delete_by_uid_end.php return $zd_51966_0; } function post_find($cond = array(), $orderby = array(), $page = 1, $pagesize = 20) { // hook model_post_find_start.php $zd_fd991_0 = post__find($cond, $orderby, $page, $pagesize); $zd_43eb1_1 = 1; if($zd_fd991_0) foreach($zd_fd991_0 as &$zd_c277a_4) { $zd_c277a_4['floor'] = $zd_43eb1_1++; post_format($zd_c277a_4); } // hook model_post_find_end.php return $zd_fd991_0; } function post_find_by_tid($tid, $page = 1, $pagesize = 50) { global $conf; // hook model_post_find_by_tid_start.php $zd_ff559_0 = post__find(array('tid'=>$tid), array('pid'=>1), $page, $pagesize); if($zd_ff559_0) { $zd_92aca_2 = ($page - 1)* $pagesize + 1; foreach($zd_ff559_0 as &$zd_fe2b6_4) { $zd_fe2b6_4['floor'] = $zd_92aca_2++; post_format($zd_fe2b6_4); } } // hook model_post_find_by_tid_end.php return $zd_ff559_0; } function user_post_message_format(&$s) { if(xn_strlen($s) < 100) return; $s = preg_replace('#<blockquote\s+class="blockquote">.*?</blockquote>#is', '', $s); $s = str_ireplace(array('<br>', '<br />', '<br/>', '</p>', '</tr>', '</div>', '</li>', '</dd>'. '</dt>'), "\r\n", $s); $s = str_ireplace(array('&nbsp;'), " ", $s); $s = strip_tags($s); $s = preg_replace('#[\r\n]+#', "\n", $s); $s = xn_substr(trim($s), 0, 100); $s = str_replace("\n", '<br>', $s); } function post_count($cond = array()) { // hook model_post_count_start.php $zd_a741b_0 = db_count('post', $cond); // hook model_post_count_end.php return $zd_a741b_0; } function post_maxid() { // hook model_post_maxid_start.php $zd_ed2fa_0 = db_maxid('post', 'pid'); // hook model_post_maxid_end.php return $zd_ed2fa_0; } function post_safe_info($post) { // hook model_post_safe_info_start.php unset($post['userip']); if(!empty($post['user'])) { $post['user'] = user_safe_info($post['user']); } // hook model_post_safe_info_end.php return $post; } function post_find_by_pids($pids, $order = array('pid'=>-1)) { // hook model_post_find_by_pids_start.php if(!$pids) return array(); $zd_869dd_0 = db_find('post', array('pid'=>$pids), $order, 1, 1000, 'pid'); if($zd_869dd_0) foreach($zd_869dd_0 as &$zd_c7f0e_3) post_format($zd_c7f0e_3); // hook model_post_find_by_pids_end.php return $zd_869dd_0; } function post_highlight_keyword($str, $k) { // hook model_post_highlight_keyword_start.php $zd_d1f9a_0 = str_ireplace($k, '<span class="red">'.$k.'</span>', $str); // hook model_post_highlight_keyword_end.php return $zd_d1f9a_0; } function post_file_list_html($filelist, $include_delete = FALSE) { global $uid,$user,$gid,$group,$action,$thread,$tid; if(empty($filelist)) return ''; // hook model_post_file_list_html_start.php // hook model_post_file_list_html_data.php $zd_c90d2_0 = '<fieldset id="filelist" class="fieldset">'."\r\n"; $zd_c90d2_0 .= '<legend>上传的附件：</legend>'."\r\n"; $zd_c90d2_0 .= '<ul class="attachlist">'."\r\n"; foreach ($filelist as &$zd_e7cde_3) { // hook model_post_file_list_html_filelist_start.php $zd_322a6_4 = url("attach-download-$zd_e7cde_3[aid]"); // hook model_post_file_list_html_filelist_data.php $zd_c90d2_0 .= '<li aid="'.$zd_e7cde_3['aid'].'">'."\r\n"; $zd_c90d2_0 .= '     <input type="hidden" name="attach_aid[]" value="'.$zd_e7cde_3['aid'].'" />'."\r\n"; $zd_c90d2_0 .= '		<a href="'.$zd_322a6_4.'" target="_blank">'."\r\n"; $zd_c90d2_0 .= '			<i class="icon filetype '.$zd_e7cde_3['filetype'].'"></i>'."\r\n"; $zd_c90d2_0 .= '			'.$zd_e7cde_3['orgfilename']."\r\n"; $zd_c90d2_0 .= '		</a>'."\r\n"; // hook model_post_file_list_html_delete_before.php $include_delete AND $zd_c90d2_0 .= '		<a href="javascript:void(0)" class="delete ml-3"><i class="icon-remove"></i> '.lang('delete').'</a>'."\r\n"; // hook model_post_file_list_html_delete_after.php $zd_c90d2_0 .= '</li>'."\r\n"; // hook model_post_file_list_html_filelist_end.php }; $zd_c90d2_0 .= '</ul>'."\r\n"; $zd_c90d2_0 .= '</fieldset>'."\r\n"; // hook model_post_file_list_html_end.php return $zd_c90d2_0; } function post_format(&$post) { global $conf, $uid, $sid, $gid, $longip; if(empty($post)) return; $post['create_date_fmt'] = humandate($post['create_date']); $zd_bc4e0_0 = user_read_cache($post['uid']); // hook model_post_format_start.php $post['username'] = array_value($zd_bc4e0_0, 'username'); $post['user_avatar_url'] = array_value($zd_bc4e0_0, 'avatar_url'); $post['user'] = $zd_bc4e0_0 ? $zd_bc4e0_0 : user_guest(); !isset($post['floor']) AND $post['floor'] = ''; $zd_28525_5 = thread_read_cache($post['tid']); $post['allowupdate'] = ($uid == $post['uid']) || forum_access_mod($zd_28525_5['fid'], $gid, 'allowupdate'); $post['allowdelete'] = ($uid == $post['uid']) || forum_access_mod($zd_28525_5['fid'], $gid, 'allowdelete'); $post['user_url'] = url("user-$post[uid]".($post['uid'] ? '' : "-$post[pid]")); if($post['files'] > 0) { list($zd_b8c53_8, $zd_8a7fd_9, $zd_5b6cf_10) = attach_find_by_pid($post['pid']); $post['filelist'] = $zd_5b6cf_10; } else { $post['filelist'] = array(); } $post['classname'] = 'post'; // hook model_post_format_end.php } function post_message_fmt(&$arr, $gid) { // hook post_message_fmt_start.php $arr['message'] = xn_substr($arr['message'], 0, 2028000); $arr['message_fmt'] = htmlspecialchars($arr['message']); $arr['doctype'] == 0 && $arr['message_fmt'] = ($gid == 1 ? $arr['message'] : xn_html_safe($arr['message'])); $arr['doctype'] == 1 && $arr['message_fmt'] = xn_txt_to_html($arr['message']); // hook post_message_fmt_end.php !empty($arr['quotepid']) && $arr['quotepid'] > 0 && $arr['message_fmt'] = post_quote($arr['quotepid']).$arr['message_fmt']; } function post_brief($s, $len = 100) { // hook post_brief_start.php $s = strip_tags($s); $s = htmlspecialchars($s); $zd_49363_0 = xn_strlen($s) > $len ? ' ... ' : ''; $s = xn_substr($s, 0, $len).$zd_49363_0; // hook post_brief_end.php return $s; } function post_quote($quotepid) { $zd_90ac7_0 = post__read($quotepid); if(empty($zd_90ac7_0)) return ''; $zd_9fbb9_2 = $zd_90ac7_0['uid']; $zd_6f14c_4 = $zd_90ac7_0['message']; // hook post_quote_start.php $zd_6f14c_4 = post_brief($zd_6f14c_4, 100); $zd_f6d26_8 = url("user-$zd_9fbb9_2"); $zd_3fdb3_10 = user_read_cache($zd_9fbb9_2); $zd_582d3_12 = '<blockquote class="blockquote">
		<a href="'.$zd_f6d26_8.'" class="text-small text-muted user">
			<img class="avatar-1" src="'.$zd_3fdb3_10['avatar_url'].'">
			'.$zd_3fdb3_10['username'].'
		</a>
		'.$zd_6f14c_4.'
		</blockquote>'; // hook post_quote_end.php return $zd_582d3_12; } function post_list_access_filter(&$postlist, $gid) { global $conf, $forumlist; if(empty($postlist)) return; // hook model_post_list_access_filter_start.php foreach($postlist as $pid=>$post) { $thread = thread__read($post['tid']); $fid = $thread['fid']; if(empty($forumlist[$fid]['accesson'])) continue; if($thread['top'] > 0) continue; if(!forum_access_user($fid, $gid, 'allowread')) { unset($postlist[$pid]); } } // hook model_post_list_access_filter_end.php } // hook model_post_end.php ?>