
<?php

/*
    Powered by ZeroDream
	https://www.zerodream.top/xiuno.htm
	
	修改文件将有禁止使用帐户风险
*/

 // hook model_post_start.php function post__create($zd_205be_0, $zd_cef60_1) { // hook model_post__create_start.php post_message_fmt($zd_205be_0, $zd_cef60_1); // hook model_post__create_insert_before.php $zd_5f69c_4 = db_insert('post', $zd_205be_0); // hook model_post__create_end.php return $zd_5f69c_4; } function post__update($zd_ec289_0, $zd_2facf_1) { // hook model_post__update_start.php $zd_fd819_2 = db_update('post', array('pid'=>$zd_ec289_0), $zd_2facf_1); // hook model_post__update_end.php return $zd_fd819_2; } function post__read($zd_651cc_0) { // hook model_post__read_start.php $zd_12cc0_1 = db_find_one('post', array('pid'=>$zd_651cc_0)); // hook model_post__read_end.php return $zd_12cc0_1; } function post__delete($zd_c71f4_0) { // hook model_post__delete_start.php $zd_4c48e_1 = db_delete('post', array('pid'=>$zd_c71f4_0)); // hook model_post__delete_end.php return $zd_4c48e_1; } function post__find($zd_b57c4_0 = array(), $zd_562b7_1 = array(), $zd_593b2_2 = 1, $zd_42cf5_3 = 20) { // hook model_post__find_start.php $zd_86daf_4 = db_find('post', $zd_b57c4_0, $zd_562b7_1, $zd_593b2_2, $zd_42cf5_3, 'pid'); // hook model_post__find_end.php return $zd_86daf_4; } function post_create($zd_a9ad5_0, $zd_5cec3_1, $zd_0d81f_2) { global $conf, $time; // hook model_post_create_start.php $zd_7d063_3 = post__create($zd_a9ad5_0, $zd_0d81f_2); if(!$zd_7d063_3) return $zd_7d063_3; $zd_51a70_8 = $zd_a9ad5_0['tid']; $zd_20bbc_10 = $zd_a9ad5_0['uid']; if($zd_51a70_8 > 0) { thread__update($zd_51a70_8, array('posts+'=>1, 'lastpid'=>$zd_7d063_3, 'lastuid'=>$zd_20bbc_10, 'last_date'=>$time)); $zd_20bbc_10 AND user__update($zd_20bbc_10, array('posts+'=>1)); runtime_set('posts+', 1); runtime_set('todayposts+', 1); forum__update($zd_5cec3_1, array('todayposts+'=>1)); } forum_list_cache_delete(); $zd_c478f_19 = $zd_a9ad5_0['message']; attach_assoc_post($zd_7d063_3); user_update_group($zd_20bbc_10); // hook model_post_create_end.php return $zd_7d063_3; } function post_update($zd_4896e_0, $zd_451c5_1, $zd_c3962_2 = 0) { global $conf, $user, $gid; $zd_c19f9_3 = post__read($zd_4896e_0); if(empty($zd_c19f9_3)) return FALSE; $zd_c3962_2 = $zd_c19f9_3['tid']; $zd_3128d_8 = $zd_c19f9_3['uid']; $zd_2274b_10 = $zd_c19f9_3['isfirst']; // hook model_post_update_start.php post_message_fmt($zd_451c5_1, $gid); // hook model_post_create_post__create_before.php $zd_eafe0_13 = post__update($zd_4896e_0, $zd_451c5_1); attach_assoc_post($zd_4896e_0); // hook model_post_update_end.php return $zd_eafe0_13; } function post_read($zd_5edc6_0) { // hook model_post_read_start.php $zd_3dcaa_1 = post__read($zd_5edc6_0); post_format($zd_3dcaa_1); // hook model_post_read_end.php return $zd_3dcaa_1; } function post_read_cache($zd_fec24_0) { // hook model_post_read_cache_start.php static $zd_c9f70_1 = array(); if(isset($zd_c9f70_1[$zd_fec24_0])) return $zd_c9f70_1[$zd_fec24_0]; $zd_c9f70_1[$zd_fec24_0] = post_read($zd_fec24_0); // hook model_post_read_cache_end.php return $zd_c9f70_1[$zd_fec24_0]; } function post_delete($zd_c1f34_0) { global $conf; $zd_d94ab_1 = post_read_cache($zd_c1f34_0); if(empty($zd_d94ab_1)) return TRUE; $zd_defe4_4 = $zd_d94ab_1['tid']; $zd_72c9a_6 = $zd_d94ab_1['uid']; $zd_8f6ee_8 = thread_read_cache($zd_defe4_4); $zd_14e71_10 = $zd_8f6ee_8['fid']; // hook model_post_delete_start.php if(!$zd_d94ab_1['isfirst']) { thread__update($zd_defe4_4, array('posts-'=>1)); $zd_72c9a_6 AND user__update($zd_72c9a_6, array('posts-'=>1)); runtime_set('posts-', 1); } else { } ($zd_d94ab_1['images'] || $zd_d94ab_1['files']) AND attach_delete_by_pid($zd_c1f34_0); $zd_59196_19 = post__delete($zd_c1f34_0); if($zd_59196_19 && !$zd_d94ab_1['isfirst'] && $zd_c1f34_0 == $zd_8f6ee_8['lastpid']) { thread_update_last($zd_defe4_4); } // hook model_post_delete_end.php return $zd_59196_19; } function post_delete_by_tid($zd_51971_0) { // hook model_post_delete_by_tid_start.php $zd_89cd2_1 = post_find_by_tid($zd_51971_0); foreach($zd_89cd2_1 as $zd_4a212_4) { post_delete($zd_4a212_4['pid']); } // hook model_post_delete_by_tid_end.php return count($zd_89cd2_1); } function post_delete_by_uid($zd_bac7d_0) { // hook model_post_delete_by_uid_start.php $zd_35131_1 = db_delete('post', array('uid'=>$zd_bac7d_0)); // hook model_post_delete_by_uid_end.php return $zd_35131_1; } function post_find($zd_d7320_0 = array(), $zd_a7909_1 = array(), $zd_45494_2 = 1, $zd_04add_3 = 20) { // hook model_post_find_start.php $zd_6549b_4 = post__find($zd_d7320_0, $zd_a7909_1, $zd_45494_2, $zd_04add_3); $zd_8423b_9 = 1; if($zd_6549b_4) foreach($zd_6549b_4 as &$zd_66c7a_12) { $zd_66c7a_12['floor'] = $zd_8423b_9++; post_format($zd_66c7a_12); } // hook model_post_find_end.php return $zd_6549b_4; } function post_find_by_tid($zd_3c5ef_0, $zd_be1e7_1 = 1, $zd_78937_2 = 50) { global $conf; // hook model_post_find_by_tid_start.php $zd_46e7e_3 = post__find(array('tid'=>$zd_3c5ef_0), array('pid'=>1), $zd_be1e7_1, $zd_78937_2); if($zd_46e7e_3) { $zd_ed234_8 = ($zd_be1e7_1 - 1)* $zd_78937_2 + 1; foreach($zd_46e7e_3 as &$zd_0bb6e_12) { $zd_0bb6e_12['floor'] = $zd_ed234_8++; post_format($zd_0bb6e_12); } } // hook model_post_find_by_tid_end.php return $zd_46e7e_3; } function user_post_message_format(&$zd_99646_0) { if(xn_strlen($zd_99646_0) < 100) return; $zd_99646_0 = preg_replace('#<blockquote\s+class="blockquote">.*?</blockquote>#is', '', $zd_99646_0); $zd_99646_0 = str_ireplace(array('<br>', '<br />', '<br/>', '</p>', '</tr>', '</div>', '</li>', '</dd>'. '</dt>'), "\r\n", $zd_99646_0); $zd_99646_0 = str_ireplace(array('&nbsp;'), " ", $zd_99646_0); $zd_99646_0 = strip_tags($zd_99646_0); $zd_99646_0 = preg_replace('#[\r\n]+#', "\n", $zd_99646_0); $zd_99646_0 = xn_substr(trim($zd_99646_0), 0, 100); $zd_99646_0 = str_replace("\n", '<br>', $zd_99646_0); } function post_count($zd_3ff99_0 = array()) { // hook model_post_count_start.php $zd_21e91_1 = db_count('post', $zd_3ff99_0); // hook model_post_count_end.php return $zd_21e91_1; } function post_maxid() { // hook model_post_maxid_start.php $zd_2a5bc_0 = db_maxid('post', 'pid'); // hook model_post_maxid_end.php return $zd_2a5bc_0; } function post_safe_info($zd_dc5ec_0) { // hook model_post_safe_info_start.php unset($zd_dc5ec_0['userip']); if(!empty($zd_dc5ec_0['user'])) { $zd_dc5ec_0['user'] = user_safe_info($zd_dc5ec_0['user']); } // hook model_post_safe_info_end.php return $zd_dc5ec_0; } function post_find_by_pids($zd_16f90_0, $zd_cb740_1 = array('pid'=>-1)) { // hook model_post_find_by_pids_start.php if(!$zd_16f90_0) return array(); $zd_94d93_3 = db_find('post', array('pid'=>$zd_16f90_0), $zd_cb740_1, 1, 1000, 'pid'); if($zd_94d93_3) foreach($zd_94d93_3 as &$zd_6c4bd_8) post_format($zd_6c4bd_8); // hook model_post_find_by_pids_end.php return $zd_94d93_3; } function post_highlight_keyword($zd_6083e_0, $zd_40b11_1) { // hook model_post_highlight_keyword_start.php $zd_aec1c_2 = str_ireplace($zd_40b11_1, '<span class="red">'.$zd_40b11_1.'</span>', $zd_6083e_0); // hook model_post_highlight_keyword_end.php return $zd_aec1c_2; } function post_file_list_html($zd_9915a_0, $zd_948ce_1 = FALSE) { global $uid,$user,$gid,$group,$action,$thread,$tid; if(empty($zd_9915a_0)) return ''; // hook model_post_file_list_html_start.php // hook model_post_file_list_html_data.php $zd_49e55_3 = '<fieldset id="filelist" class="fieldset">'."\r\n"; $zd_49e55_3 .= '<legend>上传的附件：</legend>'."\r\n"; $zd_49e55_3 .= '<ul class="attachlist">'."\r\n"; foreach ($zd_9915a_0 as &$zd_32729_7) { // hook model_post_file_list_html_filelist_start.php $zd_0f290_8 = url("attach-download-$zd_32729_7[aid]"); // hook model_post_file_list_html_filelist_data.php $zd_49e55_3 .= '<li aid="'.$zd_32729_7['aid'].'">'."\r\n"; $zd_49e55_3 .= '     <input type="hidden" name="attach_aid[]" value="'.$zd_32729_7['aid'].'" />'."\r\n"; $zd_49e55_3 .= '		<a href="'.$zd_0f290_8.'" target="_blank">'."\r\n"; $zd_49e55_3 .= '			<i class="icon filetype '.$zd_32729_7['filetype'].'"></i>'."\r\n"; $zd_49e55_3 .= '			'.$zd_32729_7['orgfilename']."\r\n"; $zd_49e55_3 .= '		</a>'."\r\n"; // hook model_post_file_list_html_delete_before.php $zd_948ce_1 AND $zd_49e55_3 .= '		<a href="javascript:void(0)" class="delete ml-3"><i class="icon-remove"></i> '.lang('delete').'</a>'."\r\n"; // hook model_post_file_list_html_delete_after.php $zd_49e55_3 .= '</li>'."\r\n"; // hook model_post_file_list_html_filelist_end.php }; $zd_49e55_3 .= '</ul>'."\r\n"; $zd_49e55_3 .= '</fieldset>'."\r\n"; // hook model_post_file_list_html_end.php return $zd_49e55_3; } function post_format(&$zd_cf0f4_0) { global $conf, $uid, $sid, $gid, $longip; if(empty($zd_cf0f4_0)) return; $zd_cf0f4_0['create_date_fmt'] = humandate($zd_cf0f4_0['create_date']); $zd_268a5_4 = user_read_cache($zd_cf0f4_0['uid']); // hook model_post_format_start.php $zd_cf0f4_0['username'] = array_value($zd_268a5_4, 'username'); $zd_cf0f4_0['user_avatar_url'] = array_value($zd_268a5_4, 'avatar_url'); $zd_cf0f4_0['user'] = $zd_268a5_4 ? $zd_268a5_4 : user_guest(); !isset($zd_cf0f4_0['floor']) AND $zd_cf0f4_0['floor'] = ''; $zd_4faa7_15 = thread_read_cache($zd_cf0f4_0['tid']); $zd_cf0f4_0['allowupdate'] = ($uid == $zd_cf0f4_0['uid']) || forum_access_mod($zd_4faa7_15['fid'], $gid, 'allowupdate'); $zd_cf0f4_0['allowdelete'] = ($uid == $zd_cf0f4_0['uid']) || forum_access_mod($zd_4faa7_15['fid'], $gid, 'allowdelete'); $zd_cf0f4_0['user_url'] = url("user-$zd_cf0f4_0[uid]".($zd_cf0f4_0['uid'] ? '' : "-$zd_cf0f4_0[pid]")); if($zd_cf0f4_0['files'] > 0) { list($zd_14ce5_28, $zd_43463_29, $zd_040cc_30) = attach_find_by_pid($zd_cf0f4_0['pid']); $zd_cf0f4_0['filelist'] = $zd_040cc_30; } else { $zd_cf0f4_0['filelist'] = array(); } $zd_cf0f4_0['classname'] = 'post'; // hook model_post_format_end.php } function post_message_fmt(&$zd_a9d2f_0, $zd_fd19f_1) { // hook post_message_fmt_start.php $zd_a9d2f_0['message'] = xn_substr($zd_a9d2f_0['message'], 0, 2028000); $zd_a9d2f_0['message_fmt'] = htmlspecialchars($zd_a9d2f_0['message']); $zd_a9d2f_0['doctype'] == 0 && $zd_a9d2f_0['message_fmt'] = ($zd_fd19f_1 == 1 ? $zd_a9d2f_0['message'] : xn_html_safe($zd_a9d2f_0['message'])); $zd_a9d2f_0['doctype'] == 1 && $zd_a9d2f_0['message_fmt'] = xn_txt_to_html($zd_a9d2f_0['message']); // hook post_message_fmt_end.php !empty($zd_a9d2f_0['quotepid']) && $zd_a9d2f_0['quotepid'] > 0 && $zd_a9d2f_0['message_fmt'] = post_quote($zd_a9d2f_0['quotepid']).$zd_a9d2f_0['message_fmt']; } function post_brief($zd_08c7e_0, $zd_b42ee_1 = 100) { // hook post_brief_start.php $zd_08c7e_0 = strip_tags($zd_08c7e_0); $zd_08c7e_0 = htmlspecialchars($zd_08c7e_0); $zd_c26c6_6 = xn_strlen($zd_08c7e_0) > $zd_b42ee_1 ? ' ... ' : ''; $zd_08c7e_0 = xn_substr($zd_08c7e_0, 0, $zd_b42ee_1).$zd_c26c6_6; // hook post_brief_end.php return $zd_08c7e_0; } function post_quote($zd_6c09d_0) { $zd_41bfd_1 = post__read($zd_6c09d_0); if(empty($zd_41bfd_1)) return ''; $zd_3546f_4 = $zd_41bfd_1['uid']; $zd_37a13_6 = $zd_41bfd_1['message']; // hook post_quote_start.php $zd_37a13_6 = post_brief($zd_37a13_6, 100); $zd_d843d_10 = url("user-$zd_3546f_4"); $zd_47e9b_12 = user_read_cache($zd_3546f_4); $zd_fbbf3_14 = '<blockquote class="blockquote">
		<a href="'.$zd_d843d_10.'" class="text-small text-muted user">
			<img class="avatar-1" src="'.$zd_47e9b_12['avatar_url'].'">
			'.$zd_47e9b_12['username'].'
		</a>
		'.$zd_37a13_6.'
		</blockquote>'; // hook post_quote_end.php return $zd_fbbf3_14; } function post_list_access_filter(&$postlist, $gid) { global $conf, $forumlist; if(empty($postlist)) return; // hook model_post_list_access_filter_start.php foreach($postlist as $pid=>$post) { $thread = thread__read($post['tid']); $fid = $thread['fid']; if(empty($forumlist[$fid]['accesson'])) continue; if($thread['top'] > 0) continue; if(!forum_access_user($fid, $gid, 'allowread')) { unset($postlist[$pid]); } } // hook model_post_list_access_filter_end.php } // hook model_post_end.php ?>