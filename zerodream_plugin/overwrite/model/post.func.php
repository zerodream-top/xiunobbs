
<?php

/*
    Powered by ZeroDream
	https://www.zerodream.top/xiuno.htm
	
	修改文件将有禁止使用帐户风险
*/

 // hook model_post_start.php // hook model_post_data.php function post__create($arr, $gid) { // hook model_post__create_start.php post_message_fmt($arr, $gid); // hook model_post__create_insert_before.php $zd_db96e_0 = db_insert('post', $arr); // hook model_post__create_end.php return $zd_db96e_0; } function post__update($pid, $arr) { // hook model_post__update_start.php $zd_687ca_0 = db_update('post', array('pid'=>$pid), $arr); // hook model_post__update_end.php return $zd_687ca_0; } function post__read($pid) { // hook model_post__read_start.php $zd_aa1f9_0 = db_find_one('post', array('pid'=>$pid)); // hook model_post__read_end.php return $zd_aa1f9_0; } function post__delete($pid) { // hook model_post__delete_start.php $zd_a8f7a_0 = db_delete('post', array('pid'=>$pid)); // hook model_post__delete_end.php return $zd_a8f7a_0; } function post__find($cond = array(), $orderby = array(), $page = 1, $pagesize = 20) { // hook model_post__find_start.php $zd_a99dd_0 = db_find('post', $cond, $orderby, $page, $pagesize, 'pid'); // hook model_post__find_end.php return $zd_a99dd_0; } function post_create($arr, $fid, $gid) { global $conf, $time; // hook model_post_create_start.php $zd_3b8bc_0 = post__create($arr, $gid); if(!$zd_3b8bc_0) return $zd_3b8bc_0; $zd_d4dec_3 = $arr['tid']; $zd_191c1_4 = $arr['uid']; if($zd_d4dec_3 > 0) { thread__update($zd_d4dec_3, array('posts+'=>1, 'lastpid'=>$zd_3b8bc_0, 'lastuid'=>$zd_191c1_4, 'last_date'=>$time)); $zd_191c1_4 AND user__update($zd_191c1_4, array('posts+'=>1)); runtime_set('posts+', 1); runtime_set('todayposts+', 1); forum__update($fid, array('todayposts+'=>1)); } forum_list_cache_delete(); $zd_43bc4_11 = $arr['message']; attach_assoc_post($zd_3b8bc_0); user_update_group($zd_191c1_4); // hook model_post_create_end.php return $zd_3b8bc_0; } function post_update($pid, $arr, $tid = 0) { global $conf, $user, $gid; $zd_e8c1e_0 = post__read($pid); if(empty($zd_e8c1e_0)) return FALSE; $tid = $zd_e8c1e_0['tid']; $zd_ffaf4_3 = $zd_e8c1e_0['uid']; $zd_ca42c_5 = $zd_e8c1e_0['isfirst']; // hook model_post_update_start.php post_message_fmt($arr, $gid); // hook model_post_create_post__create_before.php $zd_1047b_7 = post__update($pid, $arr); attach_assoc_post($pid); // hook model_post_update_end.php return $zd_1047b_7; } function post_read($pid) { // hook model_post_read_start.php $zd_ef3c1_0 = post__read($pid); post_format($zd_ef3c1_0); // hook model_post_read_end.php return $zd_ef3c1_0; } function post_read_cache($pid) { // hook model_post_read_cache_start.php static $zd_6e72a_0 = array(); if(isset($zd_6e72a_0[$pid])) return $zd_6e72a_0[$pid]; $zd_6e72a_0[$pid] = post_read($pid); // hook model_post_read_cache_end.php return $zd_6e72a_0[$pid]; } function post_delete($pid) { global $conf; $zd_f5b4f_0 = post_read_cache($pid); if(empty($zd_f5b4f_0)) return TRUE; $zd_7f700_2 = $zd_f5b4f_0['tid']; $zd_75e92_4 = $zd_f5b4f_0['uid']; $zd_c0b84_6 = thread_read_cache($zd_7f700_2); $zd_9bc97_8 = $zd_c0b84_6['fid']; // hook model_post_delete_start.php if(!$zd_f5b4f_0['isfirst']) { thread__update($zd_7f700_2, array('posts-'=>1)); $zd_75e92_4 AND user__update($zd_75e92_4, array('posts-'=>1)); runtime_set('posts-', 1); } else { } ($zd_f5b4f_0['images'] || $zd_f5b4f_0['files']) AND attach_delete_by_pid($pid); $zd_c7f1d_16 = post__delete($pid); if($zd_c7f1d_16 && !$zd_f5b4f_0['isfirst'] && $pid == $zd_c0b84_6['lastpid']) { thread_update_last($zd_7f700_2); } // hook model_post_delete_end.php return $zd_c7f1d_16; } function post_delete_by_tid($tid) { // hook model_post_delete_by_tid_start.php $zd_94c8f_0 = post_find_by_tid($tid); foreach($zd_94c8f_0 as $zd_feb0a_2) { post_delete($zd_feb0a_2['pid']); } // hook model_post_delete_by_tid_end.php return count($zd_94c8f_0); } function post_delete_by_uid($uid) { // hook model_post_delete_by_uid_start.php $zd_ffe85_0 = db_delete('post', array('uid'=>$uid)); // hook model_post_delete_by_uid_end.php return $zd_ffe85_0; } function post_find($cond = array(), $orderby = array(), $page = 1, $pagesize = 20) { // hook model_post_find_start.php $zd_a16c3_0 = post__find($cond, $orderby, $page, $pagesize); $zd_8692f_1 = 1; if($zd_a16c3_0) foreach($zd_a16c3_0 as &$zd_d230d_4) { $zd_d230d_4['floor'] = $zd_8692f_1++; post_format($zd_d230d_4); } // hook model_post_find_end.php return $zd_a16c3_0; } function post_find_by_tid($tid, $page = 1, $pagesize = 50) { global $conf; // hook model_post_find_by_tid_start.php $zd_f703d_0 = post__find(array('tid'=>$tid), array('pid'=>1), $page, $pagesize); if($zd_f703d_0) { $zd_e2b71_2 = ($page - 1)* $pagesize + 1; foreach($zd_f703d_0 as &$zd_bc611_4) { $zd_bc611_4['floor'] = $zd_e2b71_2++; post_format($zd_bc611_4); } } // hook model_post_find_by_tid_end.php return $zd_f703d_0; } function user_post_message_format(&$s) { if(xn_strlen($s) < 100) return; $s = preg_replace('#<blockquote\s+class="blockquote">.*?</blockquote>#is', '', $s); $s = str_ireplace(array('<br>', '<br />', '<br/>', '</p>', '</tr>', '</div>', '</li>', '</dd>'. '</dt>'), "\r\n", $s); $s = str_ireplace(array('&nbsp;'), " ", $s); $s = strip_tags($s); $s = preg_replace('#[\r\n]+#', "\n", $s); $s = xn_substr(trim($s), 0, 100); $s = str_replace("\n", '<br>', $s); } function post_count($cond = array()) { // hook model_post_count_start.php $zd_b399d_0 = db_count('post', $cond); // hook model_post_count_end.php return $zd_b399d_0; } function post_maxid() { // hook model_post_maxid_start.php $zd_1df8f_0 = db_maxid('post', 'pid'); // hook model_post_maxid_end.php return $zd_1df8f_0; } function post_safe_info($post) { // hook model_post_safe_info_start.php unset($post['userip']); if(!empty($post['user'])) { $post['user'] = user_safe_info($post['user']); } // hook model_post_safe_info_end.php return $post; } function post_find_by_pids($pids, $order = array('pid'=>-1)) { // hook model_post_find_by_pids_start.php if(!$pids) return array(); $zd_c1138_0 = db_find('post', array('pid'=>$pids), $order, 1, 1000, 'pid'); if($zd_c1138_0) foreach($zd_c1138_0 as &$zd_66b4c_3) post_format($zd_66b4c_3); // hook model_post_find_by_pids_end.php return $zd_c1138_0; } function post_highlight_keyword($str, $k) { // hook model_post_highlight_keyword_start.php $zd_7a388_0 = str_ireplace($k, '<span class="red">'.$k.'</span>', $str); // hook model_post_highlight_keyword_end.php return $zd_7a388_0; } function post_file_list_html($filelist, $include_delete = FALSE) { global $uid,$user,$gid,$group,$action,$thread,$tid; if(empty($filelist)) return ''; // hook model_post_file_list_html_start.php // hook model_post_file_list_html_data.php $zd_f6eda_0 = '<fieldset id="filelist" class="fieldset">'."\r\n"; $zd_f6eda_0 .= '<legend>上传的附件：</legend>'."\r\n"; $zd_f6eda_0 .= '<ul class="attachlist">'."\r\n"; foreach ($filelist as &$zd_0438e_3) { // hook model_post_file_list_html_filelist_start.php $zd_ff8b3_4 = url("attach-download-$zd_0438e_3[aid]"); // hook model_post_file_list_html_filelist_data.php $zd_f6eda_0 .= '<li aid="'.$zd_0438e_3['aid'].'">'."\r\n"; $zd_f6eda_0 .= '     <input type="hidden" name="attach_aid[]" value="'.$zd_0438e_3['aid'].'" />'."\r\n"; $zd_f6eda_0 .= '		<a href="'.$zd_ff8b3_4.'" target="_blank">'."\r\n"; $zd_f6eda_0 .= '			<i class="icon filetype '.$zd_0438e_3['filetype'].'"></i>'."\r\n"; $zd_f6eda_0 .= '			'.$zd_0438e_3['orgfilename']."\r\n"; $zd_f6eda_0 .= '		</a>'."\r\n"; // hook model_post_file_list_html_delete_before.php $include_delete AND $zd_f6eda_0 .= '		<a href="javascript:void(0)" class="delete ml-3"><i class="icon-remove"></i> '.lang('delete').'</a>'."\r\n"; // hook model_post_file_list_html_delete_after.php $zd_f6eda_0 .= '</li>'."\r\n"; // hook model_post_file_list_html_filelist_end.php }; $zd_f6eda_0 .= '</ul>'."\r\n"; $zd_f6eda_0 .= '</fieldset>'."\r\n"; // hook model_post_file_list_html_end.php return $zd_f6eda_0; } function post_format(&$post) { global $conf, $uid, $sid, $gid, $longip; if(empty($post)) return; $post['create_date_fmt'] = humandate($post['create_date']); $zd_c62cb_0 = user_read_cache($post['uid']); // hook model_post_format_start.php $post['username'] = array_value($zd_c62cb_0, 'username'); $post['user_avatar_url'] = array_value($zd_c62cb_0, 'avatar_url'); $post['user'] = $zd_c62cb_0 ? $zd_c62cb_0 : user_guest(); !isset($post['floor']) AND $post['floor'] = ''; $zd_7b1d8_5 = thread_read_cache($post['tid']); $post['allowupdate'] = ($uid == $post['uid']) || forum_access_mod($zd_7b1d8_5['fid'], $gid, 'allowupdate'); $post['allowdelete'] = ($uid == $post['uid']) || forum_access_mod($zd_7b1d8_5['fid'], $gid, 'allowdelete'); $post['user_url'] = url("user-$post[uid]".($post['uid'] ? '' : "-$post[pid]")); if($post['files'] > 0) { list($zd_27d20_8, $zd_ba102_9, $zd_e68a7_10) = attach_find_by_pid($post['pid']); $post['filelist'] = $zd_e68a7_10; } else { $post['filelist'] = array(); } $post['classname'] = 'post'; // hook model_post_format_end.php } function post_message_fmt(&$arr, $gid) { // hook post_message_fmt_start.php $arr['message'] = xn_substr($arr['message'], 0, 2028000); $arr['message_fmt'] = htmlspecialchars($arr['message']); $arr['doctype'] == 0 && $arr['message_fmt'] = ($gid == 1 ? $arr['message'] : xn_html_safe($arr['message'])); $arr['doctype'] == 1 && $arr['message_fmt'] = xn_txt_to_html($arr['message']); // hook post_message_fmt_end.php !empty($arr['quotepid']) && $arr['quotepid'] > 0 && $arr['message_fmt'] = post_quote($arr['quotepid']).$arr['message_fmt']; } function post_brief($s, $len = 100) { // hook post_brief_start.php $s = strip_tags($s); $s = htmlspecialchars($s); $zd_e432f_0 = xn_strlen($s) > $len ? ' ... ' : ''; $s = xn_substr($s, 0, $len).$zd_e432f_0; // hook post_brief_end.php return $s; } function post_quote($quotepid) { $zd_9ef2c_0 = post__read($quotepid); if(empty($zd_9ef2c_0)) return ''; $zd_86449_2 = $zd_9ef2c_0['uid']; $zd_46e40_4 = $zd_9ef2c_0['message']; // hook post_quote_start.php $zd_46e40_4 = post_brief($zd_46e40_4, 100); $zd_242d9_8 = url("user-$zd_86449_2"); $zd_e7f02_10 = user_read_cache($zd_86449_2); $zd_cd7c2_12 = '<blockquote class="blockquote">
		<a href="'.$zd_242d9_8.'" class="text-small text-muted user">
			<img class="avatar-1" src="'.$zd_e7f02_10['avatar_url'].'">
			'.$zd_e7f02_10['username'].'
		</a>
		'.$zd_46e40_4.'
		</blockquote>'; // hook post_quote_end.php return $zd_cd7c2_12; } function post_list_access_filter(&$postlist, $gid) { global $conf, $forumlist; if(empty($postlist)) return; // hook model_post_list_access_filter_start.php foreach($postlist as $pid=>$post) { $thread = thread__read($post['tid']); $fid = $thread['fid']; if(empty($forumlist[$fid]['accesson'])) continue; if($thread['top'] > 0) continue; if(!forum_access_user($fid, $gid, 'allowread')) { unset($postlist[$pid]); } } // hook model_post_list_access_filter_end.php } // hook model_post_end.php ?>