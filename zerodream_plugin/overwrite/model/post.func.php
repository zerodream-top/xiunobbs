
<?php

/*
    Powered by ZeroDream
	https://www.zerodream.top/xiuno.htm
	
	修改文件将有禁止使用帐户风险
*/

 // hook model_post_start.php // hook model_post_data.php function post__create($arr, $gid) { // hook model_post__create_start.php post_message_fmt($arr, $gid); // hook model_post__create_insert_before.php $zd_8f0e4_0 = db_insert('post', $arr); // hook model_post__create_end.php return $zd_8f0e4_0; } function post__update($pid, $arr) { // hook model_post__update_start.php $zd_1d2f2_0 = db_update('post', array('pid'=>$pid), $arr); // hook model_post__update_end.php return $zd_1d2f2_0; } function post__read($pid) { // hook model_post__read_start.php $zd_6b8f3_0 = db_find_one('post', array('pid'=>$pid)); // hook model_post__read_end.php return $zd_6b8f3_0; } function post__delete($pid) { // hook model_post__delete_start.php $zd_68543_0 = db_delete('post', array('pid'=>$pid)); // hook model_post__delete_end.php return $zd_68543_0; } function post__find($cond = array(), $orderby = array(), $page = 1, $pagesize = 20) { // hook model_post__find_start.php $zd_3f91b_0 = db_find('post', $cond, $orderby, $page, $pagesize, 'pid'); // hook model_post__find_end.php return $zd_3f91b_0; } function post_create($arr, $fid, $gid) { global $conf, $time; // hook model_post_create_start.php $zd_6dd90_0 = post__create($arr, $gid); if(!$zd_6dd90_0) return $zd_6dd90_0; $zd_8cbcc_3 = $arr['tid']; $zd_23dbc_4 = $arr['uid']; if($zd_8cbcc_3 > 0) { thread__update($zd_8cbcc_3, array('posts+'=>1, 'lastpid'=>$zd_6dd90_0, 'lastuid'=>$zd_23dbc_4, 'last_date'=>$time)); $zd_23dbc_4 AND user__update($zd_23dbc_4, array('posts+'=>1)); runtime_set('posts+', 1); runtime_set('todayposts+', 1); forum__update($fid, array('todayposts+'=>1)); } forum_list_cache_delete(); $zd_d7cc1_11 = $arr['message']; attach_assoc_post($zd_6dd90_0); user_update_group($zd_23dbc_4); // hook model_post_create_end.php return $zd_6dd90_0; } function post_update($pid, $arr, $tid = 0) { global $conf, $user, $gid; $zd_4d9f9_0 = post__read($pid); if(empty($zd_4d9f9_0)) return FALSE; $tid = $zd_4d9f9_0['tid']; $zd_f6662_3 = $zd_4d9f9_0['uid']; $zd_4ecdc_5 = $zd_4d9f9_0['isfirst']; // hook model_post_update_start.php post_message_fmt($arr, $gid); // hook model_post_create_post__create_before.php $zd_e0115_7 = post__update($pid, $arr); attach_assoc_post($pid); // hook model_post_update_end.php return $zd_e0115_7; } function post_read($pid) { // hook model_post_read_start.php $zd_4b6ea_0 = post__read($pid); post_format($zd_4b6ea_0); // hook model_post_read_end.php return $zd_4b6ea_0; } function post_read_cache($pid) { // hook model_post_read_cache_start.php static $zd_d75a8_0 = array(); if(isset($zd_d75a8_0[$pid])) return $zd_d75a8_0[$pid]; $zd_d75a8_0[$pid] = post_read($pid); // hook model_post_read_cache_end.php return $zd_d75a8_0[$pid]; } function post_delete($pid) { global $conf; $zd_5de2a_0 = post_read_cache($pid); if(empty($zd_5de2a_0)) return TRUE; $zd_d0076_2 = $zd_5de2a_0['tid']; $zd_dc00a_4 = $zd_5de2a_0['uid']; $zd_a84fe_6 = thread_read_cache($zd_d0076_2); $zd_59f85_8 = $zd_a84fe_6['fid']; // hook model_post_delete_start.php if(!$zd_5de2a_0['isfirst']) { thread__update($zd_d0076_2, array('posts-'=>1)); $zd_dc00a_4 AND user__update($zd_dc00a_4, array('posts-'=>1)); runtime_set('posts-', 1); } else { } ($zd_5de2a_0['images'] || $zd_5de2a_0['files']) AND attach_delete_by_pid($pid); $zd_832ec_16 = post__delete($pid); if($zd_832ec_16 && !$zd_5de2a_0['isfirst'] && $pid == $zd_a84fe_6['lastpid']) { thread_update_last($zd_d0076_2); } // hook model_post_delete_end.php return $zd_832ec_16; } function post_delete_by_tid($tid) { // hook model_post_delete_by_tid_start.php $zd_a3b21_0 = post_find_by_tid($tid); foreach($zd_a3b21_0 as $zd_ed74e_2) { post_delete($zd_ed74e_2['pid']); } // hook model_post_delete_by_tid_end.php return count($zd_a3b21_0); } function post_delete_by_uid($uid) { // hook model_post_delete_by_uid_start.php $zd_3ed19_0 = db_delete('post', array('uid'=>$uid)); // hook model_post_delete_by_uid_end.php return $zd_3ed19_0; } function post_find($cond = array(), $orderby = array(), $page = 1, $pagesize = 20) { // hook model_post_find_start.php $zd_9a2b9_0 = post__find($cond, $orderby, $page, $pagesize); $zd_477f3_1 = 1; if($zd_9a2b9_0) foreach($zd_9a2b9_0 as &$zd_4c305_4) { $zd_4c305_4['floor'] = $zd_477f3_1++; post_format($zd_4c305_4); } // hook model_post_find_end.php return $zd_9a2b9_0; } function post_find_by_tid($tid, $page = 1, $pagesize = 50) { global $conf; // hook model_post_find_by_tid_start.php $zd_b0250_0 = post__find(array('tid'=>$tid), array('pid'=>1), $page, $pagesize); if($zd_b0250_0) { $zd_e6f17_2 = ($page - 1)* $pagesize + 1; foreach($zd_b0250_0 as &$zd_b692f_4) { $zd_b692f_4['floor'] = $zd_e6f17_2++; post_format($zd_b692f_4); } } // hook model_post_find_by_tid_end.php return $zd_b0250_0; } function user_post_message_format(&$s) { if(xn_strlen($s) < 100) return; $s = preg_replace('#<blockquote\s+class="blockquote">.*?</blockquote>#is', '', $s); $s = str_ireplace(array('<br>', '<br />', '<br/>', '</p>', '</tr>', '</div>', '</li>', '</dd>'. '</dt>'), "\r\n", $s); $s = str_ireplace(array('&nbsp;'), " ", $s); $s = strip_tags($s); $s = preg_replace('#[\r\n]+#', "\n", $s); $s = xn_substr(trim($s), 0, 100); $s = str_replace("\n", '<br>', $s); } function post_count($cond = array()) { // hook model_post_count_start.php $zd_0db57_0 = db_count('post', $cond); // hook model_post_count_end.php return $zd_0db57_0; } function post_maxid() { // hook model_post_maxid_start.php $zd_b29c9_0 = db_maxid('post', 'pid'); // hook model_post_maxid_end.php return $zd_b29c9_0; } function post_safe_info($post) { // hook model_post_safe_info_start.php unset($post['userip']); if(!empty($post['user'])) { $post['user'] = user_safe_info($post['user']); } // hook model_post_safe_info_end.php return $post; } function post_find_by_pids($pids, $order = array('pid'=>-1)) { // hook model_post_find_by_pids_start.php if(!$pids) return array(); $zd_ce3e3_0 = db_find('post', array('pid'=>$pids), $order, 1, 1000, 'pid'); if($zd_ce3e3_0) foreach($zd_ce3e3_0 as &$zd_00f7f_3) post_format($zd_00f7f_3); // hook model_post_find_by_pids_end.php return $zd_ce3e3_0; } function post_highlight_keyword($str, $k) { // hook model_post_highlight_keyword_start.php $zd_9cbab_0 = str_ireplace($k, '<span class="red">'.$k.'</span>', $str); // hook model_post_highlight_keyword_end.php return $zd_9cbab_0; } function post_file_list_html($filelist, $include_delete = FALSE) { global $uid,$user,$gid,$group,$action,$thread,$tid; if(empty($filelist)) return ''; // hook model_post_file_list_html_start.php // hook model_post_file_list_html_data.php $zd_99210_0 = '<fieldset id="filelist" class="fieldset">'."\r\n"; $zd_99210_0 .= '<legend>上传的附件：</legend>'."\r\n"; $zd_99210_0 .= '<ul class="attachlist">'."\r\n"; foreach ($filelist as &$zd_7e58e_3) { // hook model_post_file_list_html_filelist_start.php $zd_c4a5c_4 = url("attach-download-$zd_7e58e_3[aid]"); // hook model_post_file_list_html_filelist_data.php $zd_99210_0 .= '<li aid="'.$zd_7e58e_3['aid'].'">'."\r\n"; $zd_99210_0 .= '     <input type="hidden" name="attach_aid[]" value="'.$zd_7e58e_3['aid'].'" />'."\r\n"; $zd_99210_0 .= '		<a href="'.$zd_c4a5c_4.'" target="_blank">'."\r\n"; $zd_99210_0 .= '			<i class="icon filetype '.$zd_7e58e_3['filetype'].'"></i>'."\r\n"; $zd_99210_0 .= '			'.$zd_7e58e_3['orgfilename']."\r\n"; $zd_99210_0 .= '		</a>'."\r\n"; // hook model_post_file_list_html_delete_before.php $include_delete AND $zd_99210_0 .= '		<a href="javascript:void(0)" class="delete ml-3"><i class="icon-remove"></i> '.lang('delete').'</a>'."\r\n"; // hook model_post_file_list_html_delete_after.php $zd_99210_0 .= '</li>'."\r\n"; // hook model_post_file_list_html_filelist_end.php }; $zd_99210_0 .= '</ul>'."\r\n"; $zd_99210_0 .= '</fieldset>'."\r\n"; // hook model_post_file_list_html_end.php return $zd_99210_0; } function post_format(&$post) { global $conf, $uid, $sid, $gid, $longip; if(empty($post)) return; $post['create_date_fmt'] = humandate($post['create_date']); $zd_6f76a_0 = user_read_cache($post['uid']); // hook model_post_format_start.php $post['username'] = array_value($zd_6f76a_0, 'username'); $post['user_avatar_url'] = array_value($zd_6f76a_0, 'avatar_url'); $post['user'] = $zd_6f76a_0 ? $zd_6f76a_0 : user_guest(); !isset($post['floor']) AND $post['floor'] = ''; $zd_2b779_5 = thread_read_cache($post['tid']); $post['allowupdate'] = ($uid == $post['uid']) || forum_access_mod($zd_2b779_5['fid'], $gid, 'allowupdate'); $post['allowdelete'] = ($uid == $post['uid']) || forum_access_mod($zd_2b779_5['fid'], $gid, 'allowdelete'); $post['user_url'] = url("user-$post[uid]".($post['uid'] ? '' : "-$post[pid]")); if($post['files'] > 0) { list($zd_fe530_8, $zd_873fb_9, $zd_ba3d6_10) = attach_find_by_pid($post['pid']); $post['filelist'] = $zd_ba3d6_10; } else { $post['filelist'] = array(); } $post['classname'] = 'post'; // hook model_post_format_end.php } function post_message_fmt(&$arr, $gid) { // hook post_message_fmt_start.php $arr['message'] = xn_substr($arr['message'], 0, 2028000); $arr['message_fmt'] = htmlspecialchars($arr['message']); $arr['doctype'] == 0 && $arr['message_fmt'] = ($gid == 1 ? $arr['message'] : xn_html_safe($arr['message'])); $arr['doctype'] == 1 && $arr['message_fmt'] = xn_txt_to_html($arr['message']); // hook post_message_fmt_end.php !empty($arr['quotepid']) && $arr['quotepid'] > 0 && $arr['message_fmt'] = post_quote($arr['quotepid']).$arr['message_fmt']; } function post_brief($s, $len = 100) { // hook post_brief_start.php $s = strip_tags($s); $s = htmlspecialchars($s); $zd_86c5b_0 = xn_strlen($s) > $len ? ' ... ' : ''; $s = xn_substr($s, 0, $len).$zd_86c5b_0; // hook post_brief_end.php return $s; } function post_quote($quotepid) { $zd_fd46d_0 = post__read($quotepid); if(empty($zd_fd46d_0)) return ''; $zd_0f65c_2 = $zd_fd46d_0['uid']; $zd_b4539_4 = $zd_fd46d_0['message']; // hook post_quote_start.php $zd_b4539_4 = post_brief($zd_b4539_4, 100); $zd_36e61_8 = url("user-$zd_0f65c_2"); $zd_874b4_10 = user_read_cache($zd_0f65c_2); $zd_1b1ea_12 = '<blockquote class="blockquote">
		<a href="'.$zd_36e61_8.'" class="text-small text-muted user">
			<img class="avatar-1" src="'.$zd_874b4_10['avatar_url'].'">
			'.$zd_874b4_10['username'].'
		</a>
		'.$zd_b4539_4.'
		</blockquote>'; // hook post_quote_end.php return $zd_1b1ea_12; } function post_list_access_filter(&$postlist, $gid) { global $conf, $forumlist; if(empty($postlist)) return; // hook model_post_list_access_filter_start.php foreach($postlist as $pid=>$post) { $thread = thread__read($post['tid']); $fid = $thread['fid']; if(empty($forumlist[$fid]['accesson'])) continue; if($thread['top'] > 0) continue; if(!forum_access_user($fid, $gid, 'allowread')) { unset($postlist[$pid]); } } // hook model_post_list_access_filter_end.php } // hook model_post_end.php ?>