
<?php

/*
    Powered by ZeroDream
	https://www.zerodream.top/xiuno.htm
	
	修改文件将有禁止使用帐户风险
*/

 // hook model_post_start.php function post__create($zd_54d1b0, $zd_ea0671) { // hook model_post__create_start.php post_message_fmt($zd_54d1b0, $zd_ea0671); // hook model_post__create_insert_before.php $zd_fe3314 = db_insert('post', $zd_54d1b0); // hook model_post__create_end.php return $zd_fe3314; } function post__update($zd_401d90, $zd_dafd01) { // hook model_post__update_start.php $zd_d04bc2 = db_update('post', array('pid'=>$zd_401d90), $zd_dafd01); // hook model_post__update_end.php return $zd_d04bc2; } function post__read($zd_66bb20) { // hook model_post__read_start.php $zd_398481 = db_find_one('post', array('pid'=>$zd_66bb20)); // hook model_post__read_end.php return $zd_398481; } function post__delete($zd_a59c80) { // hook model_post__delete_start.php $zd_efa391 = db_delete('post', array('pid'=>$zd_a59c80)); // hook model_post__delete_end.php return $zd_efa391; } function post__find($zd_988920 = array(), $zd_f6c5c1 = array(), $zd_f75442 = 1, $zd_5c3d23 = 20) { // hook model_post__find_start.php $zd_1a6344 = db_find('post', $zd_988920, $zd_f6c5c1, $zd_f75442, $zd_5c3d23, 'pid'); // hook model_post__find_end.php return $zd_1a6344; } function post_create($zd_a3d700, $zd_a444d1, $zd_270822) { global $conf, $time; // hook model_post_create_start.php $zd_431cc3 = post__create($zd_a3d700, $zd_270822); if(!$zd_431cc3) return $zd_431cc3; $zd_d8bbe8 = $zd_a3d700['tid']; $zd_5417010 = $zd_a3d700['uid']; if($zd_d8bbe8 > 0) { thread__update($zd_d8bbe8, array('posts+'=>1, 'lastpid'=>$zd_431cc3, 'lastuid'=>$zd_5417010, 'last_date'=>$time)); $zd_5417010 AND user__update($zd_5417010, array('posts+'=>1)); runtime_set('posts+', 1); runtime_set('todayposts+', 1); forum__update($zd_a444d1, array('todayposts+'=>1)); } forum_list_cache_delete(); $zd_8b83319 = $zd_a3d700['message']; attach_assoc_post($zd_431cc3); user_update_group($zd_5417010); // hook model_post_create_end.php return $zd_431cc3; } function post_update($zd_93f070, $zd_44f631, $zd_5af2f2 = 0) { global $conf, $user, $gid; $zd_19ae03 = post__read($zd_93f070); if(empty($zd_19ae03)) return FALSE; $zd_5af2f2 = $zd_19ae03['tid']; $zd_783a88 = $zd_19ae03['uid']; $zd_b176010 = $zd_19ae03['isfirst']; // hook model_post_update_start.php post_message_fmt($zd_44f631, $gid); // hook model_post_create_post__create_before.php $zd_6aac813 = post__update($zd_93f070, $zd_44f631); attach_assoc_post($zd_93f070); // hook model_post_update_end.php return $zd_6aac813; } function post_read($zd_9b1ca0) { // hook model_post_read_start.php $zd_dcb5a1 = post__read($zd_9b1ca0); post_format($zd_dcb5a1); // hook model_post_read_end.php return $zd_dcb5a1; } function post_read_cache($zd_816070) { // hook model_post_read_cache_start.php static $zd_305131 = array(); if(isset($zd_305131[$zd_816070])) return $zd_305131[$zd_816070]; $zd_305131[$zd_816070] = post_read($zd_816070); // hook model_post_read_cache_end.php return $zd_305131[$zd_816070]; } function post_delete($zd_e829a0) { global $conf; $zd_40a591 = post_read_cache($zd_e829a0); if(empty($zd_40a591)) return TRUE; $zd_a34a94 = $zd_40a591['tid']; $zd_a295b6 = $zd_40a591['uid']; $zd_989ef8 = thread_read_cache($zd_a34a94); $zd_283b010 = $zd_989ef8['fid']; // hook model_post_delete_start.php if(!$zd_40a591['isfirst']) { thread__update($zd_a34a94, array('posts-'=>1)); $zd_a295b6 AND user__update($zd_a295b6, array('posts-'=>1)); runtime_set('posts-', 1); } else { } ($zd_40a591['images'] || $zd_40a591['files']) AND attach_delete_by_pid($zd_e829a0); $zd_4377919 = post__delete($zd_e829a0); if($zd_4377919 && !$zd_40a591['isfirst'] && $zd_e829a0 == $zd_989ef8['lastpid']) { thread_update_last($zd_a34a94); } // hook model_post_delete_end.php return $zd_4377919; } function post_delete_by_tid($zd_6f9150) { // hook model_post_delete_by_tid_start.php $zd_f88ad1 = post_find_by_tid($zd_6f9150); foreach($zd_f88ad1 as $zd_b76f94) { post_delete($zd_b76f94['pid']); } // hook model_post_delete_by_tid_end.php return count($zd_f88ad1); } function post_delete_by_uid($zd_f81b60) { // hook model_post_delete_by_uid_start.php $zd_e9b8f1 = db_delete('post', array('uid'=>$zd_f81b60)); // hook model_post_delete_by_uid_end.php return $zd_e9b8f1; } function post_find($zd_5b0a90 = array(), $zd_e8e781 = array(), $zd_16b5f2 = 1, $zd_410493 = 20) { // hook model_post_find_start.php $zd_1adb04 = post__find($zd_5b0a90, $zd_e8e781, $zd_16b5f2, $zd_410493); $zd_4904b9 = 1; if($zd_1adb04) foreach($zd_1adb04 as &$zd_7cff612) { $zd_7cff612['floor'] = $zd_4904b9++; post_format($zd_7cff612); } // hook model_post_find_end.php return $zd_1adb04; } function post_find_by_tid($zd_dc0090, $zd_f67bb1 = 1, $zd_89b172 = 50) { global $conf; // hook model_post_find_by_tid_start.php $zd_e6f5a3 = post__find(array('tid'=>$zd_dc0090), array('pid'=>1), $zd_f67bb1, $zd_89b172); if($zd_e6f5a3) { $zd_cca2c8 = ($zd_f67bb1 - 1)* $zd_89b172 + 1; foreach($zd_e6f5a3 as &$zd_0101312) { $zd_0101312['floor'] = $zd_cca2c8++; post_format($zd_0101312); } } // hook model_post_find_by_tid_end.php return $zd_e6f5a3; } function user_post_message_format(&$zd_19ae80) { if(xn_strlen($zd_19ae80) < 100) return; $zd_19ae80 = preg_replace('#<blockquote\s+class="blockquote">.*?</blockquote>#is', '', $zd_19ae80); $zd_19ae80 = str_ireplace(array('<br>', '<br />', '<br/>', '</p>', '</tr>', '</div>', '</li>', '</dd>'. '</dt>'), "\r\n", $zd_19ae80); $zd_19ae80 = str_ireplace(array('&nbsp;'), " ", $zd_19ae80); $zd_19ae80 = strip_tags($zd_19ae80); $zd_19ae80 = preg_replace('#[\r\n]+#', "\n", $zd_19ae80); $zd_19ae80 = xn_substr(trim($zd_19ae80), 0, 100); $zd_19ae80 = str_replace("\n", '<br>', $zd_19ae80); } function post_count($zd_9a6a70 = array()) { // hook model_post_count_start.php $zd_17ee91 = db_count('post', $zd_9a6a70); // hook model_post_count_end.php return $zd_17ee91; } function post_maxid() { // hook model_post_maxid_start.php $zd_df1270 = db_maxid('post', 'pid'); // hook model_post_maxid_end.php return $zd_df1270; } function post_safe_info($zd_1720f0) { // hook model_post_safe_info_start.php unset($zd_1720f0['userip']); if(!empty($zd_1720f0['user'])) { $zd_1720f0['user'] = user_safe_info($zd_1720f0['user']); } // hook model_post_safe_info_end.php return $zd_1720f0; } function post_find_by_pids($zd_64dc80, $zd_2c3621 = array('pid'=>-1)) { // hook model_post_find_by_pids_start.php if(!$zd_64dc80) return array(); $zd_cbfe13 = db_find('post', array('pid'=>$zd_64dc80), $zd_2c3621, 1, 1000, 'pid'); if($zd_cbfe13) foreach($zd_cbfe13 as &$zd_c1b228) post_format($zd_c1b228); // hook model_post_find_by_pids_end.php return $zd_cbfe13; } function post_highlight_keyword($zd_b3e2d0, $zd_f2e201) { // hook model_post_highlight_keyword_start.php $zd_13add2 = str_ireplace($zd_f2e201, '<span class="red">'.$zd_f2e201.'</span>', $zd_b3e2d0); // hook model_post_highlight_keyword_end.php return $zd_13add2; } function post_file_list_html($zd_fc48e0, $zd_ce1501 = FALSE) { global $uid,$user,$gid,$group,$action,$thread,$tid; if(empty($zd_fc48e0)) return ''; // hook model_post_file_list_html_start.php // hook model_post_file_list_html_data.php $zd_a33263 = '<fieldset id="filelist" class="fieldset">'."\r\n"; $zd_a33263 .= '<legend>上传的附件：</legend>'."\r\n"; $zd_a33263 .= '<ul class="attachlist">'."\r\n"; foreach ($zd_fc48e0 as &$zd_ac6447) { // hook model_post_file_list_html_filelist_start.php $zd_eaf538 = url("attach-download-$zd_ac6447[aid]"); // hook model_post_file_list_html_filelist_data.php $zd_a33263 .= '<li aid="'.$zd_ac6447['aid'].'">'."\r\n"; $zd_a33263 .= '     <input type="hidden" name="attach_aid[]" value="'.$zd_ac6447['aid'].'" />'."\r\n"; $zd_a33263 .= '		<a href="'.$zd_eaf538.'" target="_blank">'."\r\n"; $zd_a33263 .= '			<i class="icon filetype '.$zd_ac6447['filetype'].'"></i>'."\r\n"; $zd_a33263 .= '			'.$zd_ac6447['orgfilename']."\r\n"; $zd_a33263 .= '		</a>'."\r\n"; // hook model_post_file_list_html_delete_before.php $zd_ce1501 AND $zd_a33263 .= '		<a href="javascript:void(0)" class="delete ml-3"><i class="icon-remove"></i> '.lang('delete').'</a>'."\r\n"; // hook model_post_file_list_html_delete_after.php $zd_a33263 .= '</li>'."\r\n"; // hook model_post_file_list_html_filelist_end.php }; $zd_a33263 .= '</ul>'."\r\n"; $zd_a33263 .= '</fieldset>'."\r\n"; // hook model_post_file_list_html_end.php return $zd_a33263; } function post_format(&$zd_37c9e0) { global $conf, $uid, $sid, $gid, $longip; if(empty($zd_37c9e0)) return; $zd_37c9e0['create_date_fmt'] = humandate($zd_37c9e0['create_date']); $zd_26ec84 = user_read_cache($zd_37c9e0['uid']); // hook model_post_format_start.php $zd_37c9e0['username'] = array_value($zd_26ec84, 'username'); $zd_37c9e0['user_avatar_url'] = array_value($zd_26ec84, 'avatar_url'); $zd_37c9e0['user'] = $zd_26ec84 ? $zd_26ec84 : user_guest(); !isset($zd_37c9e0['floor']) AND $zd_37c9e0['floor'] = ''; $zd_879b515 = thread_read_cache($zd_37c9e0['tid']); $zd_37c9e0['allowupdate'] = ($uid == $zd_37c9e0['uid']) || forum_access_mod($zd_879b515['fid'], $gid, 'allowupdate'); $zd_37c9e0['allowdelete'] = ($uid == $zd_37c9e0['uid']) || forum_access_mod($zd_879b515['fid'], $gid, 'allowdelete'); $zd_37c9e0['user_url'] = url("user-$zd_37c9e0[uid]".($zd_37c9e0['uid'] ? '' : "-$zd_37c9e0[pid]")); if($zd_37c9e0['files'] > 0) { list($zd_19fe528, $zd_e4b4629, $zd_09fc330) = attach_find_by_pid($zd_37c9e0['pid']); $zd_37c9e0['filelist'] = $zd_09fc330; } else { $zd_37c9e0['filelist'] = array(); } $zd_37c9e0['classname'] = 'post'; // hook model_post_format_end.php } function post_message_fmt(&$zd_d06260, $zd_b81bf1) { // hook post_message_fmt_start.php $zd_d06260['message'] = xn_substr($zd_d06260['message'], 0, 2028000); $zd_d06260['message_fmt'] = htmlspecialchars($zd_d06260['message']); $zd_d06260['doctype'] == 0 && $zd_d06260['message_fmt'] = ($zd_b81bf1 == 1 ? $zd_d06260['message'] : xn_html_safe($zd_d06260['message'])); $zd_d06260['doctype'] == 1 && $zd_d06260['message_fmt'] = xn_txt_to_html($zd_d06260['message']); // hook post_message_fmt_end.php !empty($zd_d06260['quotepid']) && $zd_d06260['quotepid'] > 0 && $zd_d06260['message_fmt'] = post_quote($zd_d06260['quotepid']).$zd_d06260['message_fmt']; } function post_brief($zd_b45950, $zd_563211 = 100) { // hook post_brief_start.php $zd_b45950 = strip_tags($zd_b45950); $zd_b45950 = htmlspecialchars($zd_b45950); $zd_20dbf6 = xn_strlen($zd_b45950) > $zd_563211 ? ' ... ' : ''; $zd_b45950 = xn_substr($zd_b45950, 0, $zd_563211).$zd_20dbf6; // hook post_brief_end.php return $zd_b45950; } function post_quote($zd_ab34e0) { $zd_73ee51 = post__read($zd_ab34e0); if(empty($zd_73ee51)) return ''; $zd_5b2944 = $zd_73ee51['uid']; $zd_a85af6 = $zd_73ee51['message']; // hook post_quote_start.php $zd_a85af6 = post_brief($zd_a85af6, 100); $zd_58d7210 = url("user-$zd_5b2944"); $zd_0cfe212 = user_read_cache($zd_5b2944); $zd_b505c14 = '<blockquote class="blockquote">
		<a href="'.$zd_58d7210.'" class="text-small text-muted user">
			<img class="avatar-1" src="'.$zd_0cfe212['avatar_url'].'">
			'.$zd_0cfe212['username'].'
		</a>
		'.$zd_a85af6.'
		</blockquote>'; // hook post_quote_end.php return $zd_b505c14; } function post_list_access_filter(&$postlist, $gid) { global $conf, $forumlist; if(empty($postlist)) return; // hook model_post_list_access_filter_start.php foreach($postlist as $pid=>$post) { $thread = thread__read($post['tid']); $fid = $thread['fid']; if(empty($forumlist[$fid]['accesson'])) continue; if($thread['top'] > 0) continue; if(!forum_access_user($fid, $gid, 'allowread')) { unset($postlist[$pid]); } } // hook model_post_list_access_filter_end.php } // hook model_post_end.php ?>