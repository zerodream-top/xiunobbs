
<?php

/*
    Powered by ZeroDream
	https://www.zerodream.top/xiuno.htm
	
	修改文件将有禁止使用帐户风险
*/

 // hook model_attach_start.php // hook model_attach_data.php function attach__create($zd_bd311_0) { // hook model_attach__create_start.php $zd_6f1d8_1 = db_create('attach', $zd_bd311_0); // hook model_attach__create_end.php return $zd_6f1d8_1; } function attach__update($zd_e536e_0, $zd_e32bb_1) { // hook model_attach__update_start.php $zd_01861_2 = db_update('attach', array('aid'=>$zd_e536e_0), $zd_e32bb_1); // hook model_attach__update_end.php return $zd_01861_2; } function attach__read($zd_5c2e1_0) { // hook model_attach__read_start.php $zd_e1a54_1 = db_find_one('attach', array('aid'=>$zd_5c2e1_0)); // hook model_attach__read_end.php return $zd_e1a54_1; } function attach__delete($zd_09f01_0) { // hook model_attach__delete_start.php $zd_ed75e_1 = db_delete('attach', array('aid'=>$zd_09f01_0)); // hook model_attach__delete_end.php return $zd_ed75e_1; } function attach__find($zd_d8127_0 = array(), $zd_bae3e_1 = array(), $zd_eb056_2 = 1, $zd_ebbaa_3 = 20) { // hook model_attach__find_start.php $zd_6e203_4 = db_find('attach', $zd_d8127_0, $zd_bae3e_1, $zd_eb056_2, $zd_ebbaa_3); // hook model_attach__find_end.php return $zd_6e203_4; } function attach_create($zd_cdf91_0) { // hook model_attach_create_start.php $zd_20e29_1 = attach__create($zd_cdf91_0); // hook model_attach_create_end.php return $zd_20e29_1; } function attach_update($zd_85b89_0, $zd_b5978_1) { // hook model_attach_update_start.php $zd_4a915_2 = attach__update($zd_85b89_0, $zd_b5978_1); // hook model_attach_update_end.php return $zd_4a915_2; } function attach_read($zd_89a4c_0) { // hook model_attach_read_start.php $zd_42bf7_1 = attach__read($zd_89a4c_0); attach_format($zd_42bf7_1); // hook model_attach_read_end.php return $zd_42bf7_1; } function attach_delete($zd_8353b_0) { // hook model_attach_delete_start.php global $conf; $zd_ee6bf_1 = attach_read($zd_8353b_0); $zd_f3fc5_3 = $conf['upload_path'].'attach/'.$zd_ee6bf_1['filename']; file_exists($zd_f3fc5_3) AND unlink($zd_f3fc5_3); $zd_6cec3_7 = attach__delete($zd_8353b_0); // hook model_attach_delete_end.php return $zd_6cec3_7; } function attach_delete_by_pid($zd_eb30a_0) { global $conf; list($zd_3199e_1, $zd_d4d6a_2, $zd_b1a84_3) = attach_find_by_pid($zd_eb30a_0); // hook model_attach_delete_by_pid_start.php foreach($zd_3199e_1 as $zd_56b9b_6) { $zd_fc4e7_7 = $conf['upload_path'].'attach/'.$zd_56b9b_6['filename']; file_exists($zd_fc4e7_7) AND unlink($zd_fc4e7_7); attach__delete($zd_56b9b_6['aid']); } // hook model_attach_delete_by_pid_end.php return count($zd_3199e_1); } function attach_delete_by_uid($zd_c15a6_0) { global $conf; // hook model_attach_delete_by_uid_start.php $zd_d7333_1 = db_find('attach', array('uid'=>$zd_c15a6_0), array(), 1, 9000); foreach ($zd_d7333_1 as $zd_aa4bf_4) { $zd_87bf5_5 = $conf['upload_path'].'attach/'.$zd_aa4bf_4['filename']; file_exists($zd_87bf5_5) AND unlink($zd_87bf5_5); attach__delete($zd_aa4bf_4['aid']); } // hook model_attach_delete_by_uid_end.php } function attach_find($zd_b0a48_0 = array(), $zd_d4cba_1 = array(), $zd_05d3e_2 = 1, $zd_8c6dc_3 = 20) { // hook model_attach_find_start.php $zd_6ec8f_4 = attach__find($zd_b0a48_0, $zd_d4cba_1, $zd_05d3e_2, $zd_8c6dc_3); if($zd_6ec8f_4) foreach ($zd_6ec8f_4 as &$zd_904be_11) attach_format($zd_904be_11); // hook model_attach_find_end.php return $zd_6ec8f_4; } function attach_find_by_pid($zd_b8839_0) { $zd_07154_1 = $zd_6b0a8_2 = $zd_a9de7_3 = array(); // hook model_attach_find_by_pid_start.php $zd_07154_1 = attach__find(array('pid'=>$zd_b8839_0), array(), 1, 1000); if($zd_07154_1) { foreach ($zd_07154_1 as $zd_03f3b_8) { attach_format($zd_03f3b_8); $zd_03f3b_8['isimage'] ? ($zd_6b0a8_2[] = $zd_03f3b_8) : ($zd_a9de7_3[] = $zd_03f3b_8); } } // hook model_attach_find_by_pid_end.php return array($zd_07154_1, $zd_6b0a8_2, $zd_a9de7_3); } function attach_format(&$zd_853a2_0) { global $conf; if(empty($zd_853a2_0)) return; // hook model_attach_format_start.php $zd_853a2_0['create_date_fmt'] = date('Y-n-j', $zd_853a2_0['create_date']); $zd_853a2_0['url'] = $conf['upload_url'].'attach/'.$zd_853a2_0['filename']; // hook model_attach_format_end.php } function attach_count($zd_fda99_0 = array()) { // hook model_attach_count_start.php $zd_fda99_0 = db_cond_to_sqladd($zd_fda99_0); $zd_55d09_3 = db_count('attach', $zd_fda99_0); // hook model_attach_count_end.php return $zd_55d09_3; } function attach_type($zd_c7d30_0, $zd_5d603_1) { // hook model_attach_type_start.php $zd_65576_2 = file_ext($zd_c7d30_0); foreach($zd_5d603_1 as $zd_87254_5=>$zd_3c96d_6) { if($zd_87254_5 == 'all') continue; if(in_array($zd_65576_2, $zd_3c96d_6)) { return $zd_87254_5; } } // hook model_attach_type_end.php return 'other'; } function attach_gc() { global $time, $conf; // hook model_attach_gc_start.php $zd_22445_0 = glob($conf['upload_path'].'tmp/*.*'); if(is_array($zd_22445_0)) { foreach($zd_22445_0 as $zd_3e187_3) { if($time - filemtime($zd_3e187_3) > 86400) { unlink($zd_3e187_3); } } } // hook model_attach_gc_end.php } function attach_assoc_post($pid) { global $uid, $time, $conf; $sess_tmp_files = _SESSION('tmp_files'); if(!$sess_tmp_files && preg_match('/tmp\+files\|(a\:1\:\{.*\})/',_SESSION('data'),$arr)) { $sess_tmp_files = unserialize(str_replace(array('+','='),array('_','.'),$arr['1'])); } $post = post__read($pid); if(empty($post)) return; // hook attach_assoc_post_start.php $attach_aid = param('attach_aid', array(0)); // hook attach_assoc_post_data.php $tid = $post['tid']; $post['message_old'] = $post['message_fmt']; $attach_dir_save_rule = array_value($conf, 'attach_dir_save_rule', 'Ym'); $tmp_files = $sess_tmp_files; if($tmp_files) { foreach($tmp_files as $file) { $filename = file_name($file['url']); $day = date($attach_dir_save_rule, $time); $path = $conf['upload_path'].'attach/'.$day; $url = $conf['upload_url'].'attach/'.$day; !is_dir($path) AND mkdir($path, 0777, TRUE); $destfile = $path.'/'.$filename; $desturl = $url.'/'.$filename; $r = xn_copy($file['path'], $destfile); !$r AND xn_log("xn_copy($file[path]), $destfile) failed, pid:$pid, tid:$tid", 'php_error'); if(is_file($destfile) && filesize($destfile) == filesize($file['path'])) { @unlink($file['path']); } $arr = array( 'tid'=>$tid, 'pid'=>$pid, 'uid'=>$uid, 'filesize'=>$file['filesize'], 'width'=>$file['width'], 'height'=>$file['height'], 'filename'=>"$day/$filename", 'orgfilename'=>$file['orgfilename'], 'filetype'=>$file['filetype'], 'create_date'=>$time, 'comment'=>'', 'downloads'=>0, 'isimage'=>$file['isimage'] ); $aid = attach_create($arr); $post['message'] = str_replace($file['url'], $desturl, $post['message']); $post['message_fmt'] = str_replace($file['url'], $desturl, $post['message_fmt']); } } $_SESSION['tmp_files'] = array(); $post['message_old'] != $post['message_fmt'] AND post__update($pid, array('message'=>$post['message'], 'message_fmt'=>$post['message_fmt'])); list($attachlist, $imagelist, $filelist) = attach_find_by_pid($pid); $images = count($imagelist); $files = count($filelist); $post['isfirst'] AND thread__update($tid, array('images'=>$images, 'files'=>$files)); post__update($pid, array('images'=>$images, 'files'=>$files)); foreach($attach_aid as $key=>$aid) { $attach = array(); // hook attach_assoc_post_array.php attach_update($aid, $attach); } // hook attach_assoc_post_end.php return TRUE; } // hook model_attach_end.php ?>