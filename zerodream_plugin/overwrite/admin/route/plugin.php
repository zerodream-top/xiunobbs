
<?php

/*
    Powered by ZeroDream
	https://www.zerodream.top/xiuno.htm
	
	修改文件将有禁止使用帐户风险
*/

 !defined('DEBUG') AND exit('Access Denied.'); include XIUNOPHP_PATH.'xn_zip.func.php'; $action = param(1); // hook admin_plugin_start.php // hook admin_plugin_data.php plugin_init(); plugin_env_check(); empty($action) AND $action = 'local'; if($action == 'local') { // hook admin_plugin_local_start.php // hook admin_plugin_local_data.php $pluginlist = $plugins; $pagination = ''; $pugin_cate_html = ''; $header['title'] = lang('local_plugin'); $header['mobile_title'] = lang('local_plugin'); // hook admin_plugin_local_end.php include _include(ADMIN_PATH."view/htm/plugin_list.htm"); } elseif($action == 'official_fee' || $action == 'official_free') { // hook admin_plugin_official_start.php $cateid = param(2, 0); $page = param(3, 1); $pagesize = 10; $cond = $cateid ? array('cateid'=>$cateid) : array(); $cond['price'] = $action == 'official_fee' ? array('>'=>0) : 0; // hook admin_plugin_official_data.php $pugin_cates = array(0=>lang('pugin_cate_0'), 1=>lang('pugin_cate_1'), 2=>lang('pugin_cate_2'), 3=>lang('pugin_cate_3'), 4=>lang('pugin_cate_4'), 99=>lang('pugin_cate_99')); $pugin_cate_html = plugin_cate_active($action, $pugin_cates, $cateid, $page); $total = plugin_official_total($cond); $pluginlist = plugin_official_list($cond, array('pluginid'=>-1), $page, $pagesize); $pagination = pagination(url("plugin-$action-$cateid-{page}"), $total, $page, $pagesize); $header['title'] = lang('official_plugin'); $header['mobile_title'] = lang('official_plugin'); // hook admin_plugin_official_end.php include _include(ADMIN_PATH."view/htm/plugin_list.htm"); } elseif($action == 'read') { // hook admin_plugin_read_start.php $dir = param_word(2); $siteid = plugin_siteid(); // hook admin_plugin_read_data.php $plugin = plugin_read_by_dir($dir); empty($plugin) AND message(-1, lang('plugin_not_exists')); $islocal = plugin_is_local($dir); $url = ''; $download_url = ''; $errmsg = ''; if($plugin['pluginid']) { if(!empty($plugin['official']) && $plugin['official']['price'] > 0) { $url = plugin_order_buy_qrcode_url($siteid, $dir); if($url === FALSE) { if($errno == 1 || $errno == 2) { $download_url = url("plugin-download-$dir"); } else { $download_url = ''; $errmsg = $errstr; } } else { } } else { } } else { $url = ''; } $tab = !$islocal ? ($plugin['price'] > 0 ? 'official_fee' : 'official_free') : 'local'; $header['title'] = lang('plugin_detail').'-'.$plugin['name']; $header['mobile_title'] = $plugin['name']; // hook admin_plugin_read_end.php include _include(ADMIN_PATH."view/htm/plugin_read.htm"); } elseif($action == 'is_bought') { $dir = param_word(2); plugin_check_exists($dir, FALSE); $plugin = plugin_read_by_dir($dir); if($plugin['official']['price'] == 0) { message(1, lang('plugin_is_free')); } if(plugin_is_bought($dir)) { message(0, lang('plugin_is_bought')); } else { message(2, lang('plugin_not_bought')); } } elseif($action == 'download') { plugin_lock_start(); $dir = param_word(2); plugin_check_exists($dir, FALSE); $plugin = plugin_read_by_dir($dir); $official = plugin_official_read($dir); empty($official) AND message(-1, lang('plugin_not_exists')); if(version_compare($conf['version'], $official['bbs_version']) == -1) { message(-1, lang('plugin_versio_not_match', array('bbs_version'=>$official['bbs_version'], 'version'=>$conf['version']))); } plugin_download_unzip($dir); plugin_lock_end(); message(0, jump(lang('plugin_download_sucessfully', array('dir'=>$dir)), url("plugin-read-$dir"), 3)); } elseif($action == 'install') { // hook admin_plugin_install_start.php plugin_lock_start(); $dir = param_word(2); plugin_check_exists($dir); $name = $plugins[$dir]['name']; // hook admin_plugin_install_data.php plugin_check_dependency($dir, 'install'); plugin_install($dir); $installfile = APP_PATH."plugin/$dir/install.php"; if(is_file($installfile)) { include _include($installfile); } plugin_lock_end(); if(strpos($dir, '_theme_') !== FALSE) { foreach($plugins as $_dir => $_plugin) { if($dir == $_dir) continue; if(strpos($_dir, '_theme_') !== FALSE) { plugin_unstall($_dir); } } } else { $suffix = substr($dir, strpos($dir, '_')); foreach($plugins as $_dir => $_plugin) { if($dir == $_dir) continue; $_suffix = substr($_dir, strpos($_dir, '_')); if($suffix == $_suffix) { plugin_unstall($_dir); } } } // hook admin_plugin_install_end.php $msg = lang('plugin_install_sucessfully', array('name'=>$name)); message(0, jump($msg, http_referer(), 3)); } elseif($action == 'unstall') { // hook admin_plugin_unstall_start.php plugin_lock_start(); $dir = param_word(2); plugin_check_exists($dir); $name = $plugins[$dir]['name']; // hook admin_plugin_unstall_data.php plugin_check_dependency($dir, 'unstall'); plugin_unstall($dir); $unstallfile = APP_PATH."plugin/$dir/unstall.php"; if(is_file($unstallfile)) { include _include($unstallfile); } plugin_lock_end(); // hook admin_plugin_unstall_end.php $msg = lang('plugin_unstall_sucessfully', array('name'=>$name, 'dir'=>"plugin/$dir")); message(0, jump($msg, http_referer(), 5)); } elseif($action == 'enable') { // hook admin_plugin_enable_start.php plugin_lock_start(); $dir = param_word(2); plugin_check_exists($dir); $name = $plugins[$dir]['name']; // hook admin_plugin_enable_data.php plugin_check_dependency($dir, 'install'); plugin_enable($dir); plugin_lock_end(); // hook admin_plugin_enable_end.php $msg = lang('plugin_enable_sucessfully', array('name'=>$name)); message(0, jump($msg, http_referer(), 1)); } elseif($action == 'disable') { // hook admin_plugin_disable_start.php plugin_lock_start(); $dir = param_word(2); plugin_check_exists($dir); $name = $plugins[$dir]['name']; // hook admin_plugin_disable_data.php plugin_check_dependency($dir, 'unstall'); plugin_disable($dir); plugin_lock_end(); // hook admin_plugin_disable_end.php $msg = lang('plugin_disable_sucessfully', array('name'=>$name)); message(0, jump($msg, http_referer(), 3)); } elseif($action == 'upgrade') { plugin_lock_start(); $dir = param_word(2); plugin_check_exists($dir, FALSE); $name = $plugins[$dir]['name']; $plugin = plugin_read_by_dir($dir); plugin_check_dependency($dir, 'install'); $official = plugin_read_by_dir($dir, FALSE); if(version_compare($conf['version'], $official['bbs_version']) == -1) { message(-1, lang('plugin_versio_not_match', array('bbs_version'=>$official['bbs_version'], 'version'=>$conf['version']))); } plugin_download_unzip($dir); plugin_install($dir); $upgradefile = APP_PATH."plugin/$dir/upgrade.php"; if(is_file($upgradefile)) { include _include($upgradefile); } plugin_lock_end(); $msg = lang('plugin_upgrade_sucessfully', array('name'=>$name)); message(0, jump($msg, http_referer(), 3)); } elseif($action == 'setting') { // hook admin_plugin_setting_start.php $dir = param_word(2); plugin_check_exists($dir); $name = $plugins[$dir]['name']; // hook admin_plugin_setting_data.php // hook admin_plugin_setting_end.php include _include(APP_PATH."plugin/$dir/setting.php"); } // hook admin_plugin_end.php function plugin_check_dependency($dir, $action = 'install') { global $plugins; $zd_272f0_0 = $plugins[$dir]['name']; if($action == 'install') { $zd_1dbb9_1 = plugin_dependencies($dir); if(!empty($zd_1dbb9_1)) { $zd_f66c0_3 = plugin_dependency_arr_to_links($zd_1dbb9_1); $zd_a634a_5 = lang('plugin_dependency_following', array('name'=>$zd_272f0_0, 's'=>$zd_f66c0_3)); message(-1, $zd_a634a_5); } } else { $zd_1dbb9_1 = plugin_by_dependencies($dir); if(!empty($zd_1dbb9_1)) { $zd_f66c0_3 = plugin_dependency_arr_to_links($zd_1dbb9_1); $zd_a634a_5 = lang('plugin_being_dependent_cant_delete', array('name'=>$zd_272f0_0, 's'=>$zd_f66c0_3)); message(-1, $zd_a634a_5); } } } function plugin_dependency_arr_to_links($arr) { global $plugins; $zd_f7ec8_0 = ''; foreach($arr as $zd_6456f_1=>$zd_ae5f1_2) { $zd_47736_3 = isset($plugins[$zd_6456f_1]['name']) ? $plugins[$zd_6456f_1]['name'] : $zd_6456f_1; $zd_c537a_7 = url("plugin-read-$zd_6456f_1"); $zd_f7ec8_0 .= " <a href=\"$zd_c537a_7\">【{$zd_47736_3}】</a> "; } return $zd_f7ec8_0; } function plugin_download_unzip($dir) { global $conf; $zd_b3806_0 = http_url_path(); $zd_d06ca_1 = plugin_siteid(); $zd_b3806_0 = xn_urlencode($zd_b3806_0); $zd_45352_4 = PLUGIN_OFFICIAL_URL."plugin-download-$dir-$zd_d06ca_1-$zd_b3806_0.htm"; $zd_72ffb_7 = http_get($zd_45352_4); empty($zd_72ffb_7) AND message(-1, $zd_45352_4.lang('plugin_return_data_error').lang('server_response_empty')); if(substr($zd_72ffb_7, 0, 2) != 'PK') { $zd_17ff1_12 = xn_json_decode($zd_72ffb_7); empty($zd_17ff1_12) AND message(-1, $zd_45352_4.lang('plugin_return_data_error').$zd_72ffb_7); if($zd_17ff1_12['code'] == -2) { message(-2, jump(lang('plugin_is_not_free'), url("plugin-read-$dir"))); } message($zd_17ff1_12['code'], $zd_45352_4.lang('plugin_return_data_error').$zd_17ff1_12['message']); } $zd_3e189_21 = $conf['tmp_path'].'plugin_'.$dir.'.zip'; $zd_49c09_22 = APP_PATH."plugin/"; file_put_contents($zd_3e189_21, $zd_72ffb_7); rmdir_recusive(APP_PATH."plugin/$dir/hook/", 1); rmdir_recusive(APP_PATH."plugin/$dir/overwrite/", 1); xn_unzip($zd_3e189_21, $zd_49c09_22); $conffile = "../plugin/$dir/conf.json"; !is_file($conffile) AND message(-1, 'conf.json '.lang('not_exists')); $zd_17ff1_12 = xn_json_decode(file_get_contents($conffile)); empty($zd_17ff1_12['name']) AND message(-1, 'conf.json '.lang('format_maybe_error')); !is_dir("../plugin/$dir") AND message(-1, lang('plugin_maybe_download_failed')." plugin/$dir"); } function plugin_is_bought($dir) { global $conf; $zd_ab424_0 = plugin_siteid(); $zd_f8a61_1 = http_url_path(); $zd_f8a61_1 = xn_urlencode($zd_f8a61_1); $zd_cba57_4 = PLUGIN_OFFICIAL_URL."plugin-is_bought-$dir-$zd_ab424_0-$zd_f8a61_1.htm"; $zd_e90f0_7 = http_get($zd_cba57_4); $zd_93d19_9 = xn_json_decode($zd_e90f0_7); empty($zd_93d19_9) AND message(-1, $zd_cba57_4.lang('plugin_return_data_error').$zd_e90f0_7); if($zd_93d19_9['code'] == 0) { return TRUE; } else { return xn_error($zd_93d19_9['code'], $zd_93d19_9['message']); } } function plugin_order_buy_qrcode_url($siteid, $dir, $app_url = '') { global $conf; $siteid = plugin_siteid(); $app_url = http_url_path(); $app_url = xn_urlencode($app_url); $zd_f4f2b_0 = PLUGIN_OFFICIAL_URL."plugin-buy_qrcode_url-$dir-$siteid-$app_url.htm"; set_time_limit(0); $zd_3653c_1 = http_get($zd_f4f2b_0); if(empty($zd_3653c_1)) return xn_error(-1, lang('server_response_empty')); $zd_6e0be_4 = xn_json_decode($zd_3653c_1); if(empty($zd_6e0be_4) || !isset($zd_6e0be_4['code'])) { return xn_error($zd_6e0be_4['code'], $zd_f4f2b_0.lang('plugin_return_data_error').$zd_3653c_1); } if($zd_6e0be_4['code'] == 0) { return $zd_6e0be_4['message']; } else { return xn_error($zd_6e0be_4['code'], $zd_f4f2b_0.lang('plugin_return_data_error').$zd_6e0be_4['message']); } } function plugin_is_local($dir) { global $plugins; return isset($plugins[$dir]) ? TRUE : FALSE; } function plugin_check_exists($dir, $local = TRUE) { global $plugins, $official_plugins; !is_word($dir) AND message(-1, lang('plugin_name_error')); if($local) { !isset($plugins[$dir]) AND message(-1, lang('plugin_not_exists')); } else { !isset($official_plugins[$dir]) AND message(-1, lang('plugin_not_exists')); } } function plugin_cate_active($action, $plugin_cate, $cateid, $page) { $zd_38c0f_0 = ''; foreach ($plugin_cate as $zd_13f48_1=>$zd_78682_2) { $zd_1ed9c_3 = url("plugin-$action-$zd_13f48_1-$page"); $zd_38c0f_0 .= '<a role="button" class="btn btn btn-secondary'.($cateid == $zd_13f48_1 ? ' active' : '').'" href="'.$zd_1ed9c_3.'">'.$zd_78682_2.'</a>'; } return $zd_38c0f_0; } function plugin_lock_start() { global $route, $action; !xn_lock_start($route.'_'.$action) AND message(-1, lang('plugin_task_locked')); } function plugin_lock_end() { global $route, $action; xn_lock_end($route.'_'.$action); } function plugin_env_check() { } ?>