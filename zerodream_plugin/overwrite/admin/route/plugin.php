
<?php

/*
    Powered by ZeroDream
	https://www.zerodream.top/xiuno.htm
	
	修改文件将有禁止使用帐户风险
*/

 !defined('DEBUG') AND exit('Access Denied.'); include XIUNOPHP_PATH.'xn_zip.func.php'; $action = param(1); // hook admin_plugin_start.php // hook admin_plugin_data.php plugin_init(); plugin_env_check(); empty($action) AND $action = 'local'; if($action == 'local') { // hook admin_plugin_local_start.php // hook admin_plugin_local_data.php $pluginlist = $plugins; $pagination = ''; $pugin_cate_html = ''; $header['title'] = lang('local_plugin'); $header['mobile_title'] = lang('local_plugin'); // hook admin_plugin_local_end.php include _include(ADMIN_PATH."view/htm/plugin_list.htm"); } elseif($action == 'official_fee' || $action == 'official_free') { // hook admin_plugin_official_start.php $cateid = param(2, 0); $page = param(3, 1); $pagesize = 10; $cond = $cateid ? array('cateid'=>$cateid) : array(); $cond['price'] = $action == 'official_fee' ? array('>'=>0) : 0; // hook admin_plugin_official_data.php $pugin_cates = array(0=>lang('pugin_cate_0'), 1=>lang('pugin_cate_1'), 2=>lang('pugin_cate_2'), 3=>lang('pugin_cate_3'), 4=>lang('pugin_cate_4'), 99=>lang('pugin_cate_99')); $pugin_cate_html = plugin_cate_active($action, $pugin_cates, $cateid, $page); $total = plugin_official_total($cond); $pluginlist = plugin_official_list($cond, array('pluginid'=>-1), $page, $pagesize); $pagination = pagination(url("plugin-$action-$cateid-{page}"), $total, $page, $pagesize); $header['title'] = lang('official_plugin'); $header['mobile_title'] = lang('official_plugin'); // hook admin_plugin_official_end.php include _include(ADMIN_PATH."view/htm/plugin_list.htm"); } elseif($action == 'read') { // hook admin_plugin_read_start.php $dir = param_word(2); $siteid = plugin_siteid(); // hook admin_plugin_read_data.php $plugin = plugin_read_by_dir($dir); empty($plugin) AND message(-1, lang('plugin_not_exists')); $islocal = plugin_is_local($dir); $url = ''; $download_url = ''; $errmsg = ''; if($plugin['pluginid']) { if(!empty($plugin['official']) && $plugin['official']['price'] > 0) { $url = plugin_order_buy_qrcode_url($siteid, $dir); if($url === FALSE) { if($errno == 1 || $errno == 2) { $download_url = url("plugin-download-$dir"); } else { $download_url = ''; $errmsg = $errstr; } } else { } } else { } } else { $url = ''; } $tab = !$islocal ? ($plugin['price'] > 0 ? 'official_fee' : 'official_free') : 'local'; $header['title'] = lang('plugin_detail').'-'.$plugin['name']; $header['mobile_title'] = $plugin['name']; // hook admin_plugin_read_end.php include _include(ADMIN_PATH."view/htm/plugin_read.htm"); } elseif($action == 'is_bought') { $dir = param_word(2); plugin_check_exists($dir, FALSE); $plugin = plugin_read_by_dir($dir); if($plugin['official']['price'] == 0) { message(1, lang('plugin_is_free')); } if(plugin_is_bought($dir)) { message(0, lang('plugin_is_bought')); } else { message(2, lang('plugin_not_bought')); } } elseif($action == 'download') { plugin_lock_start(); $dir = param_word(2); plugin_check_exists($dir, FALSE); $plugin = plugin_read_by_dir($dir); $official = plugin_official_read($dir); empty($official) AND message(-1, lang('plugin_not_exists')); if(version_compare($conf['version'], $official['bbs_version']) == -1) { message(-1, lang('plugin_versio_not_match', array('bbs_version'=>$official['bbs_version'], 'version'=>$conf['version']))); } plugin_download_unzip($dir); plugin_lock_end(); message(0, jump(lang('plugin_download_sucessfully', array('dir'=>$dir)), url("plugin-read-$dir"), 3)); } elseif($action == 'install') { // hook admin_plugin_install_start.php plugin_lock_start(); $dir = param_word(2); plugin_check_exists($dir); $name = $plugins[$dir]['name']; // hook admin_plugin_install_data.php plugin_check_dependency($dir, 'install'); plugin_install($dir); $installfile = APP_PATH."plugin/$dir/install.php"; if(is_file($installfile)) { include _include($installfile); } plugin_lock_end(); if(strpos($dir, '_theme_') !== FALSE) { foreach($plugins as $_dir => $_plugin) { if($dir == $_dir) continue; if(strpos($_dir, '_theme_') !== FALSE) { plugin_unstall($_dir); } } } else { $suffix = substr($dir, strpos($dir, '_')); foreach($plugins as $_dir => $_plugin) { if($dir == $_dir) continue; $_suffix = substr($_dir, strpos($_dir, '_')); if($suffix == $_suffix) { plugin_unstall($_dir); } } } // hook admin_plugin_install_end.php $msg = lang('plugin_install_sucessfully', array('name'=>$name)); message(0, jump($msg, http_referer(), 3)); } elseif($action == 'unstall') { // hook admin_plugin_unstall_start.php plugin_lock_start(); $dir = param_word(2); plugin_check_exists($dir); $name = $plugins[$dir]['name']; // hook admin_plugin_unstall_data.php plugin_check_dependency($dir, 'unstall'); plugin_unstall($dir); $unstallfile = APP_PATH."plugin/$dir/unstall.php"; if(is_file($unstallfile)) { include _include($unstallfile); } plugin_lock_end(); // hook admin_plugin_unstall_end.php $msg = lang('plugin_unstall_sucessfully', array('name'=>$name, 'dir'=>"plugin/$dir")); message(0, jump($msg, http_referer(), 5)); } elseif($action == 'enable') { // hook admin_plugin_enable_start.php plugin_lock_start(); $dir = param_word(2); plugin_check_exists($dir); $name = $plugins[$dir]['name']; // hook admin_plugin_enable_data.php plugin_check_dependency($dir, 'install'); plugin_enable($dir); plugin_lock_end(); // hook admin_plugin_enable_end.php $msg = lang('plugin_enable_sucessfully', array('name'=>$name)); message(0, jump($msg, http_referer(), 1)); } elseif($action == 'disable') { // hook admin_plugin_disable_start.php plugin_lock_start(); $dir = param_word(2); plugin_check_exists($dir); $name = $plugins[$dir]['name']; // hook admin_plugin_disable_data.php plugin_check_dependency($dir, 'unstall'); plugin_disable($dir); plugin_lock_end(); // hook admin_plugin_disable_end.php $msg = lang('plugin_disable_sucessfully', array('name'=>$name)); message(0, jump($msg, http_referer(), 3)); } elseif($action == 'upgrade') { plugin_lock_start(); $dir = param_word(2); plugin_check_exists($dir, FALSE); $name = $plugins[$dir]['name']; $plugin = plugin_read_by_dir($dir); plugin_check_dependency($dir, 'install'); $official = plugin_read_by_dir($dir, FALSE); if(version_compare($conf['version'], $official['bbs_version']) == -1) { message(-1, lang('plugin_versio_not_match', array('bbs_version'=>$official['bbs_version'], 'version'=>$conf['version']))); } plugin_download_unzip($dir); plugin_install($dir); $upgradefile = APP_PATH."plugin/$dir/upgrade.php"; if(is_file($upgradefile)) { include _include($upgradefile); } plugin_lock_end(); $msg = lang('plugin_upgrade_sucessfully', array('name'=>$name)); message(0, jump($msg, http_referer(), 3)); } elseif($action == 'setting') { // hook admin_plugin_setting_start.php $dir = param_word(2); plugin_check_exists($dir); $name = $plugins[$dir]['name']; // hook admin_plugin_setting_data.php // hook admin_plugin_setting_end.php include _include(APP_PATH."plugin/$dir/setting.php"); } // hook admin_plugin_end.php function plugin_check_dependency($zd_78d810, $zd_865ea1 = 'install') { global $plugins; $zd_244a02 = $plugins[$zd_78d810]['name']; if($zd_865ea1 == 'install') { $zd_420e15 = plugin_dependencies($zd_78d810); if(!empty($zd_420e15)) { $zd_be9bf8 = plugin_dependency_arr_to_links($zd_420e15); $zd_6467810 = lang('plugin_dependency_following', array('name'=>$zd_244a02, 's'=>$zd_be9bf8)); message(-1, $zd_6467810); } } else { $zd_420e15 = plugin_by_dependencies($zd_78d810); if(!empty($zd_420e15)) { $zd_be9bf8 = plugin_dependency_arr_to_links($zd_420e15); $zd_6467810 = lang('plugin_being_dependent_cant_delete', array('name'=>$zd_244a02, 's'=>$zd_be9bf8)); message(-1, $zd_6467810); } } } function plugin_dependency_arr_to_links($zd_b84940) { global $plugins; $zd_63bd31 = ''; foreach($zd_b84940 as $zd_e1f5b3=>$zd_0fe4d4) { $zd_b43fc5 = isset($plugins[$zd_e1f5b3]['name']) ? $plugins[$zd_e1f5b3]['name'] : $zd_e1f5b3; $zd_814c79 = url("plugin-read-$zd_e1f5b3"); $zd_63bd31 .= " <a href=\"$zd_814c79\">【{$zd_b43fc5}】</a> "; } return $zd_63bd31; } function plugin_download_unzip($zd_82df70) { global $conf; $zd_2d9e11 = http_url_path(); $zd_b65e72 = plugin_siteid(); $zd_2d9e11 = xn_urlencode($zd_2d9e11); $zd_836e05 = PLUGIN_OFFICIAL_URL."plugin-download-$zd_82df70-$zd_b65e72-$zd_2d9e11.htm"; $zd_d5e179 = http_get($zd_836e05); empty($zd_d5e179) AND message(-1, $zd_836e05.lang('plugin_return_data_error').lang('server_response_empty')); if(substr($zd_d5e179, 0, 2) != 'PK') { $zd_dfa0014 = xn_json_decode($zd_d5e179); empty($zd_dfa0014) AND message(-1, $zd_836e05.lang('plugin_return_data_error').$zd_d5e179); if($zd_dfa0014['code'] == -2) { message(-2, jump(lang('plugin_is_not_free'), url("plugin-read-$zd_82df70"))); } message($zd_dfa0014['code'], $zd_836e05.lang('plugin_return_data_error').$zd_dfa0014['message']); } $zd_8d95524 = $conf['tmp_path'].'plugin_'.$zd_82df70.'.zip'; $zd_0055a26 = APP_PATH."plugin/"; file_put_contents($zd_8d95524, $zd_d5e179); rmdir_recusive(APP_PATH."plugin/$zd_82df70/hook/", 1); rmdir_recusive(APP_PATH."plugin/$zd_82df70/overwrite/", 1); xn_unzip($zd_8d95524, $zd_0055a26); $conffile = "../plugin/$zd_82df70/conf.json"; !is_file($conffile) AND message(-1, 'conf.json '.lang('not_exists')); $zd_dfa0014 = xn_json_decode(file_get_contents($conffile)); empty($zd_dfa0014['name']) AND message(-1, 'conf.json '.lang('format_maybe_error')); !is_dir("../plugin/$zd_82df70") AND message(-1, lang('plugin_maybe_download_failed')." plugin/$zd_82df70"); } function plugin_is_bought($zd_ce4b80) { global $conf; $zd_ef2291 = plugin_siteid(); $zd_9fb8d2 = http_url_path(); $zd_9fb8d2 = xn_urlencode($zd_9fb8d2); $zd_ff6ec5 = PLUGIN_OFFICIAL_URL."plugin-is_bought-$zd_ce4b80-$zd_ef2291-$zd_9fb8d2.htm"; $zd_012239 = http_get($zd_ff6ec5); $zd_108a411 = xn_json_decode($zd_012239); empty($zd_108a411) AND message(-1, $zd_ff6ec5.lang('plugin_return_data_error').$zd_012239); if($zd_108a411['code'] == 0) { return TRUE; } else { return xn_error($zd_108a411['code'], $zd_108a411['message']); } } function plugin_order_buy_qrcode_url($zd_5c01b0, $zd_336541, $zd_62b0c2 = '') { global $conf; $zd_5c01b0 = plugin_siteid(); $zd_62b0c2 = http_url_path(); $zd_62b0c2 = xn_urlencode($zd_62b0c2); $zd_254f57 = PLUGIN_OFFICIAL_URL."plugin-buy_qrcode_url-$zd_336541-$zd_5c01b0-$zd_62b0c2.htm"; set_time_limit(0); $zd_6b3dc11 = http_get($zd_254f57); if(empty($zd_6b3dc11)) return xn_error(-1, lang('server_response_empty')); $zd_4bed214 = xn_json_decode($zd_6b3dc11); if(empty($zd_4bed214) || !isset($zd_4bed214['code'])) { return xn_error($zd_4bed214['code'], $zd_254f57.lang('plugin_return_data_error').$zd_6b3dc11); } if($zd_4bed214['code'] == 0) { return $zd_4bed214['message']; } else { return xn_error($zd_4bed214['code'], $zd_254f57.lang('plugin_return_data_error').$zd_4bed214['message']); } } function plugin_is_local($zd_f766e0) { global $plugins; return isset($plugins[$zd_f766e0]) ? TRUE : FALSE; } function plugin_check_exists($zd_cafde0, $zd_3382b1 = TRUE) { global $plugins, $official_plugins; !is_word($zd_cafde0) AND message(-1, lang('plugin_name_error')); if($zd_3382b1) { !isset($plugins[$zd_cafde0]) AND message(-1, lang('plugin_not_exists')); } else { !isset($official_plugins[$zd_cafde0]) AND message(-1, lang('plugin_not_exists')); } } function plugin_cate_active($zd_3708c0, $zd_5a6d01, $zd_3883e2, $zd_444f23) { $zd_9ccfa4 = ''; foreach ($zd_5a6d01 as $zd_032eb6=>$zd_4cba37) { $zd_83f5c8 = url("plugin-$zd_3708c0-$zd_032eb6-$zd_444f23"); $zd_9ccfa4 .= '<a role="button" class="btn btn btn-secondary'.($zd_3883e2 == $zd_032eb6 ? ' active' : '').'" href="'.$zd_83f5c8.'">'.$zd_4cba37.'</a>'; } return $zd_9ccfa4; } function plugin_lock_start() { global $route, $action; !xn_lock_start($route.'_'.$action) AND message(-1, lang('plugin_task_locked')); } function plugin_lock_end() { global $route, $action; xn_lock_end($route.'_'.$action); } function plugin_env_check() { } ?>