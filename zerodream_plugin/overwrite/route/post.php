
<?php

/*
    Powered by ZeroDream
    Optimized by ZeroDream
	https://www.zerodream.top/xiuno.htm
	
	修改文件将有禁止使用帐户风险
*/

 !defined('DEBUG') AND exit('Access Denied.'); $action = param(1); user_login_check(); // hook post_start.php // hook post_data.php if($action == 'create') { // hook post_create_start.php $tid = param(2); $quick = param(3); $quotepid = param(4); // hook post_create_data.php $thread = thread_read($tid); empty($thread) AND message(-1, lang('thread_not_exists')); $fid = $thread['fid']; $forum = forum_read($fid); empty($forum) AND message(-1, lang('forum_not_exists')); $r = forum_access_user($fid, $gid, 'allowpost'); if(!$r) { message(-1, lang('user_group_insufficient_privilege')); } ($thread['closed'] && ($gid == 0 || $gid > 5)) AND message(-1, lang('thread_has_already_closed')); // hook post_get_post.php if($method == 'GET') { // hook post_get_start.php $header['title'] = lang('post_create'); $header['mobile_title'] = lang('post_create'); $header['mobile_link'] = url("thread-$tid"); // hook post_get_data.php // hook post_get_end.php include _include(APP_PATH.'view/htm/post.htm'); } else { // hook post_post_start.php $message = param('message', '', FALSE); empty($message) AND message('message', lang('please_input_message')); $doctype = param('doctype', 0); xn_strlen($message) > 2028000 AND message('message', lang('message_too_long')); $thread['top'] > 0 AND thread_top_cache_delete(); $quotepid = param('quotepid', 0); $quotepost = post__read($quotepid); (!$quotepost || $quotepost['tid'] != $tid) AND $quotepid = 0; // hook post_post_data.php $post = array( 'tid'=>$tid, 'uid'=>$uid, 'create_date'=>$time, 'userip'=>$longip, 'isfirst'=>0, 'doctype'=>$doctype, 'quotepid'=>$quotepid, 'message'=>$message, ); // hook post_post_array.php $pid = post_create($post, $fid, $gid); empty($pid) AND message(-1, lang('create_post_failed')); $post = post_read($pid); $post['floor'] = $thread['posts'] + 2; $postlist = array($post); $allowpost = forum_access_user($fid, $gid, 'allowpost'); $allowupdate = forum_access_mod($fid, $gid, 'allowupdate'); $allowdelete = forum_access_mod($fid, $gid, 'allowdelete'); // hook post_post_end.php $return_html = param('return_html', 0); if($return_html) { $filelist = array(); ob_start(); include _include(APP_PATH.'view/htm/post_list.inc.htm'); $s = ob_get_clean(); message(0, $s); } else { message(0, lang('create_post_sucessfully')); } } // hook post_create_end.php } elseif($action == 'update') { // hook post_update_start.php $pid = param(2); // hook post_update_data.php $post = post_read($pid); empty($post) AND message(-1, lang('post_not_exists')); $tid = $post['tid']; $thread = thread_read($tid); empty($thread) AND message(-1, lang('thread_not_exists')); $fid = $thread['fid']; $forum = forum_read($fid); empty($forum) AND message(-1, lang('forum_not_exists')); $isfirst = $post['isfirst']; !forum_access_user($fid, $gid, 'allowpost') AND message(-1, lang('user_group_insufficient_privilege')); $allowupdate = forum_access_mod($fid, $gid, 'allowupdate'); !$allowupdate AND !$post['allowupdate'] AND message(-1, lang('have_no_privilege_to_update')); !$allowupdate AND $thread['closed'] AND message(-1, lang('thread_has_already_closed')); // hook post_update_get_post.php if($method == 'GET') { // hook post_update_get_start.php // hook post_update_get_data.php $forumlist_allowthread = forum_list_access_filter($forumlist, $gid, 'allowthread'); $forumarr = xn_json_encode(arrlist_key_values($forumlist_allowthread, 'fid', 'name')); $post['message'] = htmlspecialchars($post['message'] ? $post['message'] : $post['message_fmt']); ($uid != $post['uid']) AND $post['message'] = xn_html_safe($post['message']); $attachlist = $imagelist = $filelist = array(); if($post['files']) { list($attachlist, $imagelist, $filelist) = attach_find_by_pid($pid); } // hook post_update_get_end.php include _include(APP_PATH.'view/htm/post.htm'); } elseif($method == 'POST') { $subject = htmlspecialchars(param('subject', '', FALSE)); $message = param('message', '', FALSE); $doctype = param('doctype', 0); // hook post_update_post_start.php // hook post_update_post_data.php empty($message) AND message('message', lang('please_input_message')); mb_strlen($message, 'UTF-8') > 2048000 AND message('message', lang('message_too_long')); $arr = array(); if($isfirst) { $newfid = param('fid'); $forum = forum_read($newfid); empty($forum) AND message('fid', lang('forum_not_exists')); if($fid != $newfid) { !forum_access_user($fid, $gid, 'allowthread') AND message(-1, lang('user_group_insufficient_privilege')); $post['uid'] != $uid AND !forum_access_mod($fid, $gid, 'allowupdate') AND message(-1, lang('user_group_insufficient_privilege')); $arr['fid'] = $newfid; } if($subject != $thread['subject']) { mb_strlen($subject, 'UTF-8') > 80 AND message('subject', lang('subject_max_length', array('max'=>80))); $arr['subject'] = $subject; } // hook post_update_post_array_thread.php $arr AND thread_update($tid, $arr) === FALSE AND message(-1, lang('update_thread_failed')); } $arr = array('doctype'=>$doctype, 'message'=>$message); // hook post_update_post_array_post.php $r = post_update($pid, $arr); $r === FALSE AND message(-1, lang('update_post_failed')); // hook post_update_post_end.php message(0, lang('update_successfully')); } // hook post_update_end.php } elseif($action == 'delete') { // hook post_delete_start.php $pid = param(2, 0); // hook post_delete_data.php if($method != 'POST') message(-1, lang('method_error')); $post = post_read($pid); empty($post) AND message(-1, lang('post_not_exists')); $tid = $post['tid']; $thread = thread_read($tid); empty($thread) AND message(-1, lang('thread_not_exists')); $fid = $thread['fid']; $forum = forum_read($fid); empty($forum) AND message(-1, lang('forum_not_exists')); $isfirst = $post['isfirst']; !forum_access_user($fid, $gid, 'allowpost') AND message(-1, lang('user_group_insufficient_privilege')); $allowdelete = forum_access_mod($fid, $gid, 'allowdelete'); !$allowdelete AND !$post['allowdelete'] AND message(-1, lang('insufficient_delete_privilege')); !$allowdelete AND $thread['closed'] AND message(-1, lang('thread_has_already_closed')); // hook post_delete_middle.php if($isfirst) { thread_delete($tid); } else { post_delete($pid); } // hook post_delete_end.php message(0, lang('delete_successfully')); } // hook post_end.php ?>